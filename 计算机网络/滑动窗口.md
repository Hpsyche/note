## 固定窗口的问题及滑动窗口的引入

固定窗口存在的问题

如下图所示：

![img](https://img-blog.csdn.net/20180416144425689)

我们假设这个固定窗口的大小为1，也就是每次只能发送一个数据，只有接收方对这个数据进行了确认后才能发送第二个数据。在图中我们可以看到，发送方每发送一个数据接收方就要给发送方一个ACK对这个数据进行确认。只有接收了这个确认数据以后发送方才能传输下个数据。

存在的问题：如果窗口过小，当传输比较大的数据的时候需要不停的对数据进行确认，这个时候就会造成很大的延迟。

如果窗口过大，我们假设发送方一次发送100个数据，但接收方只能处理50个数据，这样每次都只对这50个数据进行确认。发送方下一次还是发送100个数据，但接受方还是只能处理50个数据。这样就避免了不必要的数据来拥塞我们的链路。

因此，我们引入了滑动窗口。

## 滑动窗口

### 什么是滑动窗口

同学 Luffy 给你打电话，让你记下一串手机号码，可是你记忆力不太好，你跟 Luffy 约定，一次只最多只能报 4 个数字，Luffy 念一遍，如果你听到了就把他说的话重复一遍。接下来：

你：你一次最多报 4 个数字，多了我记不住啊！
Luffy：139
你：139 （Luffy 知道你听到了）
Luffy：7548
你：7538 （很明显你听错了）
Luffy：不对，是7548
你：7548
Luffy : 2669
你：2669

上面的场景，你一次最多只能接受 4 个数字，表示你的滑动窗口大小就是  在 TCP 协议中，也有这样的滑动窗口，它的大小表示目前还能接收多少字节的数据。

TCP 每次收到对方发来的报文，都会检查**窗口大小**字段

![](D:\Work\TyporaNotes\note\计算机网络\pict\滑动窗口1.png)

知道了对方的窗口大小后，就知道对方目前还能接收多少数据，接收的数据字节序号是 TCP 段中的 ACK 的值到 ACK + 窗口大小，即 [ACK,ACK+窗口大小) [ACK, ACK + 窗口大小)[ACK,ACK+窗口大小).

比如，你给对方发送了一个段携带字节序号为 [400, 500) 的数据。对方回送了一个 TCP 段，ack = 500, win = 100，就表示，我已经收到 [400, 500) 的数据我还能接收字节序号为 [500, 600) 之间的数据，见图 2。

![](D:\Work\TyporaNotes\note\计算机网络\pict\滑动窗口2.png)

修正：上面的第二条蓝线文字更改为 data[500, 600)

如果对方回送了一个 TCP 段，ack = 500, win = 0，就表示，我已经收到了 [400, 500) 的数据，但是我现在不能再接收数据了，你待会再发。

![](D:\Work\TyporaNotes\note\计算机网络\pict\滑动窗口3.png)

### 滑动窗口的目的

回顾本文开头给出的打电话的例子，为什么你要告诉对方一次最多只能报 4 个数字？原因在于你的接受能力有限，不是说你无法记忆很多数字，只是在短期内，你记不住，你需要一段一段的记忆（一段一段的将数据放入缓冲区）。

所以，在 TCP 中，滑动窗口是为了实现流量控制。如果对方发送数据过快，接收方就来不及接收（你来不急记住），接收方就需要通告对方，减慢数据的发送（图 3）。

![](D:\Work\TyporaNotes\note\计算机网络\pict\滑动窗口4.png)

修正：图4 中最后一个小图修正一下文字，应该为『发送方收到 ack=41, win=10, 知道对方希望接收序号为 [41, 51) 的数据』

##  慢开始和拥塞避免

发送方维持一个拥塞窗口 cwnd ( congestion window )的状态变量。拥塞窗口的大小取决于网络的拥塞程度，并且动态地在变化。发送方让自己的发送窗口等于拥塞。

发送方控制拥塞窗口的原则是：只要网络没有出现拥塞，拥塞窗口就再增大一些，以便把更多的分组发送出去。但只要网络出现拥塞，拥塞窗口就减小一些，以减少注入到网络中的分组数。

慢开始算法：当主机开始发送数据时，如果立即所大量数据字节注入到网络，那么就有可能引起网络拥塞，因为现在并不清楚网络的负荷情况。因此，较好的方法是 先探测一下，即由小到大逐渐增大发送窗口，也就是说，由小到大逐渐增大拥塞窗口数值。通常在刚刚开始发送报文段时，先把拥塞窗口 cwnd 设置为一个最大报文段MSS的数值。而在每收到一个对新的报文段的确认后，把拥塞窗口增加至多一个MSS的数值。用这样的方法逐步增大发送方的拥塞窗口 cwnd ，可以使分组注入到网络的速率更加合理。

![1560265483190](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1560265483190.png)

<1>. 当TCP连接进行初始化时，把拥塞窗口cwnd置为1。前面已说过，为了便于理解，图中的窗口单位不使用字节而使用报文段的个数。慢开始门限的初始值设置为16个报文段，即 cwnd = 16 。

<2>. 在执行慢开始算法时，拥塞窗口 cwnd 的初始值为1。以后发送方每收到一个对新报文段的确认ACK，就把拥塞窗口值另1，然后开始下一轮的传输（图中横坐标为传输轮次）。因此拥塞窗口cwnd 随着传输轮次按指数规律增长。当拥塞窗口cwnd增长到慢开始门限值ssthresh时（即当cwnd=16时），就改为执行拥塞控制算法，拥塞窗口按线 性规律增长。

<3>. 假定拥塞窗口的数值增长到24时，网络出现超时（这很可能就是网络发生拥塞了）。更新后的ssthresh值变为12（即变为出现超时时的拥塞窗口数值 24的一半），拥塞窗口再重新设置为1，并执行慢开始算法。当cwnd=ssthresh=12时改为执行拥塞避免算法，拥塞窗口按线性规律增长，每经过 一个往返时间增加一个MSS的大小。

强调：“拥塞避免”并非指完全能够避免了拥塞。利用以上的措施要完全避免网络拥塞还是不可能的。“拥塞避免”是说在拥塞避免阶段将拥塞窗口控制为按线性规律增长，**使网络比较不容易出现拥塞。**

