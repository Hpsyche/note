# 发送数据包（邮件发送）

## 1.应用程序处理

应用在发送邮件的那一刻建立TCP连接，从而利用这个TCP连接发送数据，

它的过程首先是将应用的数据发送给下一层的TCP，在做实际的转发处理。

## 2.TCP模块的处理

TCP根据应用的指示，负责建立连接、发送数据以及断开连接。

为实现TCP这一功能，需要在应用层数据的前端附加一个TCP首部

TCP首部汇总包括源端口号和目标端口号、序号、校验和（判断数据是否被损坏）

随后将附加了TCP首部的包再发送给IP

## 3.IP模块的处理

IP将TCP传过来的TCP首部和TCP数据合起来当做自己的数据，并在TCP首部的前端在加上自己的IP首部。因此，IP数据包中IP首部后面紧跟着TCP首部，然后才是应用的数据首部的数据本身。

IP首部中包含<font color=red>接收端IP地址</font>以及<font color=red>发送端IP地址</font>。紧随IP首部的还有用来判断其后面数据是TCP还是UDP的信息。

在进入第4步前，要得MAC地址，如果尚不知道接收端的MAC地址，可以利用ARP(Address Resolution Protocol)查找，只要知道了对端的MAC地址，就可以将MAC地址和IP地址交给以太网的驱动程序，实现数据传输。

## 4.网络接口（以太网）的处理

从IP传过来的IP包，以太网驱动给这数据附加上以太网首部并进行发送处理。以太网首部中包含接收端MAC地址、发送端MAC地址以及标志以太网类型的以太网数据的协议。

发送处理中的FCS（Frame Check Sequence）由硬件计算，添加到包的最后。设置FCS的目的是为了判断数据包是否由于噪声而被破坏。

### 注意：1-4

经过数据链路的包：每个包的首部都会包含两个信息：一个是发送端和接收端地址，另一个是上一层的协议类型

以太网会用MAC地址，IP会用IP地址，而TCP/UDP则会把端口号作为识别两端主机的地址。

# 数据包接受处理

## 5.网络接口（以太网驱动）的处理

主机收到以太网包后，判断以太网的包首部找到MAC地址判断是否为发给自己的包，如果不是则丢弃数据；如果以太网包首部的类型域包含了一个无法识别的协议类型，则丢弃数据。

## 6.IP模块的处理

 IP模块收到IP包首部及后面的数据部分以后，如果判断得出包首部中的IP地址与自己的IP地址匹配，则可接收数据并从中查找上一层的协议。如果上一层是TCP就将IP包首部之后的部分传给TCP处理， 如果是UDP则将IP包首部后面的部分传给UDP处理。

对于有路由器的情况下，接收端地址往往不是自己的地址，此时，需要借助路由控制表，再调查应该送达的主机或路由器以后再转发数据。

## 7.TCP模块的处理

在TCP模块中，首先会计算一下校验和，判断数据是否被破坏。然后检查是否按照序号接收数据，最后检查端口号，确定具体的应用程序。

数据接收完毕后，接收端则发送一个“确认回执”给发送端。如果这个回执信息未能到达发送端，那么发送端会认为接收端没有接收到数据而一直反复发送。

## 8.应用程序的处理

如果正确进行，则接收端返回一个“处理正常”的回执给发送端；反之，若邮件未能保存成功，则会发送一个“处理异常”的回执给发送端







