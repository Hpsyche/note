## 什么是VPN

VPN，全名Virtual Private Network，虚拟专用网，就是利用开放的公众网络，建立专用数据传输通道，将远程的分支机构、移动办公人员等连接起来。

![](D:\Work\TyporaNotes\note\计算机网络\趣谈网络协议知识点\pict\22-1.png)

## VPN是如何工作的？

VPN通过隧道技术在公众网络上仿真一条点到点的专线，是通过利用一种协议来传输另外一种协议的技术，这里面涉及三种协议：乘客协议、隧道协议和承载协议。

基于IP协议的安全隧道协议：IPsec VPN。为了保证在公网上面信息的安全，采取了一定的机制保证安全性。

* 机制一：私密性，防止信息泄漏给未经授权的个人，通过加密把数据从明文变成无法读懂的密文，从而确保数据的私密性。
  前面讲HTTPS的时候，说过加密可以分为对称加密和非对称加密。对称加密速度快一些。而VPN一旦建立，需要传输大量数据，因而我们采取对称加密。但是同样，对称加密还是存在加密秘钥如何传输的问题，这里需要用到因特网密钥交换（IKE，Internet Key Exchange）协议。
* 机制二：完整性，数据没有被非法篡改，通过对数据进行hash运算，产生类似于指纹的数据摘要，以保证数据的完整性。
* 机制三：真实性，数据确实是由特定的对端发出，通过身份认证可以保证数据的真实性。

## VPN包的传输

点对点的基于IP的VPN，能满足互通的要求，但是速度往往比较慢，这是由底层IP协议的特性决定的。IP不是面向连接的，是尽力而为的协议，每个IP包自由选择路径，到每一个路由器，都自己去找下一跳，丢了就丢了，是靠上一层TCP的重发来保证可靠性。

![](D:\Work\TyporaNotes\note\计算机网络\趣谈网络协议知识点\pict\22-2.png)

因为IP网络从设计的时候，就认为是不可靠的，所以即使同一个连接，也可能选择不同的道路，这样的好处是，一条道路崩溃的时候，总有其他的路可以走。当然，带来的代价就是，不断的路由查找，效率比较差。

和IP对应的另一种技术称为ATM。这种协议和IP协议的不同在于，它是面向连接的。你可以说TCP也是面向连接的啊。这两个不同，**ATM和IP是一个层次的，和TCP不是一个层次的。**

TCP所谓的面向连接，是不停地重试来保证成功，其实下层的IP还是不面向连接的，丢了就丢了。**ATM是传输之前先建立一个连接，形成一个虚拟的通路，一旦连接建立了，所有的包都按照相同的路径走，不会分头行事。**

![](D:\Work\TyporaNotes\note\计算机网络\趣谈网络协议知识点\pict\22-3.png)

好处是不需要每次都查路由表的，虚拟路径已经建立，打上了标签，后续的包傻傻的跟着走就是了，不用像IP包一样，每个包都思考下一步怎么走，都按相同的路径走，这样效率会高很多。

但是一旦虚拟路径上的某个路由器坏了，则这个连接就断了，什么也发不过去了，因为其他的包还会按照原来的路径走，都掉坑里了，它们不会选择其他的路径走。

**ATM技术**虽然没有成功，**但其屏弃了繁琐的路由查找，改为简单快速的标签交换，将具有全局意义的路由表改为只有本地意义的标签表，这些都可以大大提高一台路由器的转发功力。**

有没有一种方式将两者的优点结合起来呢？这就是**多协议标签交换**（MPLS，Multi-Protocol Label Switching）。MPLS的格式如图所示，在原始的IP头之外，多了MPLS的头，里面可以打标签。

![](D:\Work\TyporaNotes\note\计算机网络\趣谈网络协议知识点\pict\22-4.png)

有了标签，还需要设备认这个标签，并且能够根据这个标签转发，这种能够转发标签的路由器称为**标签交换路由器（LSR，Label Switching Router）。**

这种路由器会有两个表格，一个就是传统的FIB，也即路由表，另一个就是LFIB，标签转发表。有了这两个表，既可以进行普通的路由转发，也可以进行基于标签的转发。

![](D:\Work\TyporaNotes\note\计算机网络\趣谈网络协议知识点\pict\22-5.png)

有了标签转发表，转发的过程如图所示，就不用每次都进行普通路由的查找了。

这里我们区分MPLS区域和非MPLS区域。在MPLS区域中间，使用标签进行转发，非MPLS区域，使用普路由转发，在边缘节点上，需要有能力将对于普通路由的转发，变成对于标签的转发。

例如图中要访问114.1.1.1，在边界上查找普通路由，发现马上要**进入MPLS区域了（标签变）**，进去了对应标签1，于是在IP头外面加一个标签1，在区域里面，标签1要变成标签3，标签3**到达出口边缘（路由变），将标签去掉，按照路由发出。**

## 生成标签过程

有了标签，转发是很简单的事，但是如何生成标签，却是MPLS中最难修炼的部分。在MPLS秘笈中，这部分被称为LDP（Label Distribution Protocol），是一个动态的生成标签的协议。

其实LDP与IP帮派中的路由协议十分相像，通过LSR的交互，互相告知去哪里应该打哪个标签，称为标签分发，往往是从下游开始的。

![](D:\Work\TyporaNotes\note\计算机网络\趣谈网络协议知识点\pict\22-6.png)

如果有一个边缘节点发现自己的路由表中出现了新的目的地址，它就要给别人说，我能到达一条新的路径了。

如果此边缘节点存在上游LSR，并且尚有可供分配的标签，则该节点为新的路径分配标签，并向上游发出标签映射消息，其中包含分配的标签等信息。

收到标签映射消息的LSR记录相应的标签映射信息，在其标签转发表中增加相应的条目。此LSR为它的上游LSR分配标签，并继续向上游LSR发送标签映射消息。

可以想象，如果我们VPN通道里面包的转发，都是通过标签的方式进行，效率就会高很多。

![](D:\Work\TyporaNotes\note\计算机网络\趣谈网络协议知识点\pict\22-7.png)

在MPLS VPN中，网络中的路由器分成以下几类：

* PE（Provider Edge）：运营商网络与客户网络相连的边缘网络设备；
* CE（Customer Edge）：客户网络与PE相连接的边缘设备；
* P（Provider）：这里特指运营商网络中除PE之外的其他运营商网络设备。

为什么要这样分呢？因为我们发现，在运营商网络里面，也即P Router之间，使用标签是没有问题的，因为都在运营商的管控之下，对于网段，路由都可以自己控制。但是一旦客户要接入这个网络，就复杂得多。

首先是客户地址重复的问题。客户所使用的大多数都是私网的地址(192.168.X.X;10.X.X.X;172.X.X.X)，而且很多情况下都会与其它的客户重复。

比如，机构A和机构B都使用了192.168.101.0/24网段的地址，这就发生了地址空间重叠（Overlapping Address Spaces）。

VPN报文转发采用两层标签方式：

* 第一层（外层）标签在骨干网内部进行交换，指示从PE到对端PE的一条LSP。VPN报文利用这层标签，可以沿LSP到达对端PE；
* 第二层（内层）标签在从对端PE到达CE时使用，在PE上，通过查找VRF表项，指示报文应被送到哪个VPN用户，或者更具体一些，到达哪一个CE。这样，对端PE根据内层标签可以找到转发报文的接口。

![](D:\Work\TyporaNotes\note\计算机网络\趣谈网络协议知识点\pict\22-8.png)

我们来举一个例子，看MPLS VPN的包发送过程。
1. 机构A和机构B都发出一个目的地址为192.168.101.0/24的IP报文，分别由各自的CE将报文发送至PE。
2. PE会根据报文到达的接口及目的地址查找VPN实例表项VRF，匹配后将报文转发出去，**同时打上内层和外层两个标签**。假设通过MP-BGP配置的路由，两个报文在骨干网走相同的路径。
3. MPLS网络**利用报文的外层标签，将报文传送到出口PE**，报文在到达出口PE 2前一跳时已经被剥离外层标签，仅含内层标签。
4. 出口PE**根据内层标签和目的地址查找VPN实例表项VRF，确定报文的出接口**，将报文转发至各自的CE。
5. CE根据正常的IP转发过程将报文传送到目的地。

## 小结

* VPN可以将一个机构的多个数据中心通过隧道的方式连接起来，让机构感觉在一个数据中心里面，就像自驾游通过琼州海峡一样；
* 完全基于软件的IPsec VPN可以保证私密性、完整性、真实性、简单便宜，但是性能稍微差一些；
* **MPLS-VPN综合和IP转发模式和ATM的标签转发模式的优势，性能较好，但是需要从运营商购买。**