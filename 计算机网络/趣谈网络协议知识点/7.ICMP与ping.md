ping 是基于 ICMP 协议工作的。ICMP全称Internet Control Message Protocol，就是互联网控制报文
协议。

ICMP具体类型：

* 查询报文（如ping）
* 差错报文
  * 终点不可达3
  * 源抑制4
  * 超时11
  * 重定向5

##  ping 的发送和接收过程

![](D:\Work\TyporaNotes\note\计算机网络\趣谈网络协议知识点\pict\7-1.png)

* ping 命令执行的时候，源主机首先会构建一个 ICMP 请求数据包，ICMP 数据包内包含多个字段。最重
  要的是两个，第一个是类型字段，对于请求数据包而言该字段为 8；另外一个是顺序号，主要用于区分
  连续 ping 的时候发出的多个数据包。每发出一个请求数据包，顺序号会自动加 1。为了能够计算往返时
  间 RTT，它会在报文的数据部分插入发送时间。
* 然后，由 ICMP 协议将这个数据包连同地址 192.168.1.2 一起交给 IP 层。IP 层将以 192.168.1.2 作为
  目的地址，本机 IP 地址作为源地址，加上一些其他控制信息，构建一个 IP 数据包。
* 需要加入 MAC 头。如果在本节 ARP 映射表中查找出 IP 地址 192.168.1.2 所对应的 MAC 地
  址，则可以直接使用；如果没有，则需要发送 ARP 协议查询 MAC 地址，获得 MAC 地址后，由数据链
  路层构建一个数据帧，目的地址是 IP 层传过来的 MAC 地址，源地址则是本机的 MAC 地址；还要附加
  上一些控制信息，依据以太网的介质访问规则，将它们传送出去。
* 主机 B 收到这个数据帧后，先检查它的目的 MAC 地址，并和本机的 MAC 地址对比，如符合，则接
  收，否则就丢弃。接收后检查该数据帧，将 IP 数据包从帧中提取出来，交给本机的 IP 层。同样，IP 层
  检查后，将有用的信息提取后交给 ICMP 协议。
* 主机 B 会构建一个 ICMP 应答包，应答数据包的类型字段为 0，顺序号为接收到的请求数据包中的顺序
  号，然后再发送出去给主机 A。殊的 TTL，来追踪去往目的地时沿途经过的路由器。
  Traceroute 的参数指向某个目的 IP 地址，它会发送一个 UDP 的数据包。**将 TTL 设置成 1，也就是说一
  旦遇到一个路由器或者一个关卡，就表示它“牺牲”了。**
* **在规定的时候间内**，源主机如果没有接到 ICMP 的应答包，则说明目标主机不可达；如果接收到了
  ICMP 应答包，则说明目标主机可达。此时，源主机会检查，用当前时刻减去该数据包最初从源主机上
  发出的时刻，就是 ICMP 数据包的时间延迟。

## Traceroute：差错报文类型的使用

它会使用 ICMP 的规则，故意制造一些能够产生错误的场景。

所以，**Traceroute 的第一个作用就是故意设置特殊的 TTL，来追踪去往目的地时沿途经过的路由器。**
Traceroute 的参数指向某个目的 IP 地址，它会发送一个 UDP 的数据包。**将 TTL 设置成 1，也就是说一
旦遇到一个路由器或者一个关卡，就表示它“牺牲”了。**

如果中间的路由器不止一个，当然碰到第一个就“牺牲”。于是，返回一个 ICMP 包，也就是网络差错
包，类型是时间超时。那大军前行就带一顿饭，试一试走多远会被饿死，然后找个哨探回来报告，那我
就知道大军只带一顿饭能走多远了。

接下来，将 TTL 设置为 2。第一关过了，第二关就“牺牲”了，那我就知道第二关有多远。如此反复，直到到达目的主机。这样，Traceroute 就拿到了所有的路由器 IP。当然，有的路由器压根不会回这个ICMP。这也是 Traceroute 一个公网的地址，看不到中间路由的原因。

Traceroute 程序会发送一份 UDP 数据报给目的主机，但它会选择一个不可能的值作为 UDP 端口号（大于 30000）。当该数据报到达时，将使目的主机的 UDP 模块产生一份“端口不可达”错误 ICMP 报文。如果数据报没有到达，则可能是超时。

**这就相当于故意派人去西天如来那里去请一本《道德经》，结果人家信佛不信道，消息就会被打出来。
被打的消息传回来，你就知道西天是能够到达的。为什么不去取《心经》呢？因为 UDP 是无连接的。也
就是说这人一派出去，你就得不到任何音信。你无法区别到底是半路走丢了，还是真的信佛遁入空门
了，只有让人家打出来，你才会得到消息。**

**Traceroute 还有一个作用是故意设置不分片，从而确定路径的 MTU。**要做的工作首先是发送分组，并
设置“不分片”标志。发送的第一个分组的长度正好与出口 MTU 相等。如果中间遇到窄的关口会被卡
住，会发送 ICMP 网络差错包，类型为“需要进行分片但设置了不分片位”。其实，这是人家故意的好
吧，每次收到 ICMP“不能分片”差错时就减小分组的长度，直到到达目标主机。

