每个办公室会有几十个甚至上百个网口。这个时候，一个交换机肯定不够用，需要多台交换机连接，而多台交换机连接就形成了一个稍微复杂的拓扑结构。

## 交换机过程

![](D:\Work\TyporaNotes\note\计算机网络\趣谈网络协议知识点\pict\6-1.png)

如果机器 1 只知道机器 4 的 IP 地址，当它想要访问机器 4 时，把包发出去的时候，它必须知道机器 4 的 MAC 地址。我们来看看这个过程：

- 机器 1 发起广播，机器 2 和交换机 A 都收到广播。机器 2 收到广播后，知道不是找它的，所以没它什么事。
- 交换机 A 一开始是不知道任何拓扑信息的，在它收到这个广播后，采取的策略是，除了广播包来的方向外，它还要转发给其他所有的网口。
- 机器 3 和交换机 B 收到了广播信息了，同样的，机器 3 也知道和它没什么关系。
- 交换机 B 收到广播信息后，这时候它也不知道任何拓扑信息，所以也进行广播，将包转发到局域网三，也就是机器 4 和机器 5。
- 机器 4 收到广播是，它发现是找它的，就主动响应说，这是找我的，我的 MAC 地址是 XXX。

    在机器 1 收到机器 4 的 MAC 地址后，一个 ARP 请求就成功完成了。

    在上面过程中，交换机 A 和交换机 B 都是能够学习到这样的信息：

- 机器 1 是在左边这个网口。

    当了解这样的信息后，如果机器 2 访问 机器 1，机器 2 发起一个 ARP 请求获取机器 1 的 MAC 地址，这个广播消息会发给机器 1 和交换机 A。这个时候交换机 A 已经知道机器 1 是在左边的网卡，所以它就不会将请求广播到局域网二和局域网三。

    就这样，当交换机学习完所有的拓扑信息后，两台交换机工作得会越来越好。

但是随着办公室越来越大，交换机数量肯定会越来越多，当整个拓扑结构复杂，这么多网线绕来绕去，不可避免的就会出现一些意料之外的情况，其中最常见的问题就是**环路问题**。

## 环路与广播风暴

![](D:\Work\TyporaNotes\note\计算机网络\趣谈网络协议知识点\pict\6-2.png)

 我们来想象下机器 1 访问机器 2 的过程。

- 机器 1 发起 ARP 广播
- 机器 2 收到广播，把 MAC 地址返回。

    咦，整个过程很顺利，没什么问题。

    但是我们忽略了，两个交换机也是能收到广播包的。我们来看看两个交换机的广播过程：

1. 交换机 A 开始不知道拓扑信息，于是将广播信息放到局域网二
2. 消息在局域网二广播，交换机 B 右网卡收到广播消息，于是将信息放到局域网一
3. 消息在局域网一广播，交换机 A 左网口收到消息，又将广播信息放到局域网二
4. ......

    看出来了吗？这样一直广播，就会形成一个环路，最终成为**广播风暴**，直到网络瘫痪。

上面过程，可能会有人说，两台交换机逐渐学习到拓扑结构后 ，是不是就可以了？那就让我们来看下它们的学习过程：

1. 在局域网一，交换机 A、B 收到机器 1 的广播包后，知道机器 1 都是在**左网口**
2. 当广播放到局域网二后，交换机 B **右网口**又收到了来自机器 1 的广播包，于是就误会机器 1 换位置了，就记住了机器 1 是在**右网口**，把之前学习到的信息清理掉
3. 同理，交换机 A 右网口收到了机器 1 的广播包，同样误会了，于是也学会了，机器 1 在**右网口**，不是在左网口

    就这样，两个交换机会不断刷新“三观”，机器 1 是在左网口，过一会，发现不对，机器 1 是在右网口，过了一会，又发现不对，是在左网口。于是，又形成了一个“广播风暴”。

    那么，有什么方法可以解决环路问题呢？这就到了 STP 协议出场的时候了。

## STP（生成树算法）

在数据结构中，有一个方法叫作**最小生成树**。有环的我们常称为**图**。将图中的环破了，就生成了**树**。而在计算机网络中，生成树的算法叫作 **STP（Spanning Tree Protocol）**。

## VLAN

​		机器多了，交换机也多了，就算交换机比 Hub 智能一些，但是还是难免有广播的问题。一大堆机器，相关的部门、不相关的部门，广播一大堆，性能就下来了。

    就像一家公司，创业的时候，十来个人，坐在一个会议室，有事情大家讨论下，非常方便。当时如果变成了 50 个，全在一个会议室吵吵，就会乱的不得了。

    另一方面，一个公司里，有的部门需要保密，比如人事部门，肯定要讨论升职加薪的事情。但是如果在一个广播域里，碰到一个会抓包的程序员，就能看的没有加密的敏感信息。

    那咋办？能咋办，分部门，分会议室呗，让我们来看看怎么分。

    有两种分的方法。一个是**物理隔离**。每个部门设一个单独的会议室，对应到网络方面，就是每个部门有单独的交换机，配置单独的子网。这样部门之间的沟通就需要路由器了。

    这样的问题在于，有的部门人多，有的部门人少，而且部门的人数也会频繁发生变化，如果每个部门有单独的交换机，网口多了浪费，少了又不够用。

    这时候，**虚拟隔离**就出来了。虚拟隔离，就是我们常说的 VLAN，或者叫做**虚拟局域网**。

​		使用 VLAN，一个交换机上会连属于多个局域网的机器，那交换机是怎么区分哪个机器属于哪个局域网呢？

![](D:\Work\TyporaNotes\note\计算机网络\趣谈网络协议知识点\pict\6-3.png)

  我们只需要在原来的二层头上加一个 TAG，里面有个 VLAN ID，共 12 位，可以划分 4096 个 VLAN。对于普通办公室，这个数量应该是够用的。

    如果我们买的交换机支持 VLAN，当这个交换机把二层的头取下来的时候，就能够识别这个 VLAN ID。这样只有相同的 VLAN 的包，才会互相转发，不同 VLAN 的包，是看不到的。这样广播问题和安全问题就都能够解决了\。

​		我们可以设置交换机每个口所属的 VLAN。如果某个口坐的是程序员，他们属于 VLAN 10；如果某个口
坐的是人事，他们属于 VLAN 20；如果某个口坐的是财务，他们属于 VLAN 30。这样，财务发的包，交换机只会转发到 VLAN 30 的口上。程序员啊，你就监听 VLAN 10 吧，里面除了代码，啥都没有。

​		而且对于交换机来讲，每个 VLAN 的口都是可以重新设置的。一个财务走了，把他所在的作为的口从VLAN 30 移除掉，来了一个程序员，坐在财务的位置上，就把这个口设置为 VLAN 10，十分灵活。有人会问交换机之间怎么连接呢？将两个交换机连接起来的口应该设置成什么 VLAN 呢？对于支持VLAN 的交换机，有一种口叫作Trunk 口。它可以转发属于任何 VLAN 的口。交换机之间可以通过这种口相互连接。

## 小结

* 当交换机的数目越来越多的时候，会遭遇环路问题，让网络包迷路，这就需要使用 STP 协议，通过华
  山论剑比武的方式，将有环路的图变成没有环路的树，从而解决环路问题。
* 交换机数目多会面临隔离问题，可以通过 VLAN 形成虚拟局域网，从而解决广播问题和安全问题。

### STP的缺点

* **当拓扑发生变化**，新的配置消息要经过**一定的时延**才能传播到整个网络。
* 由于**整个交换网络只有一棵生成树，在网络规模比较大的时候会导致较长的收敛时间**，拓扑改变的影响面也较大，**当链路被阻塞后将不承载任何流量，造成了极大带宽浪费。**



