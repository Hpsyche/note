​	数据链路层属于计算机网络的低层。

## 数据链路层使用的信道主要有以下两种类型

* 点对点信道
* 广播信道

# 使用点对点信道的数据链路层

## 数据链路和帧

链路：即物理链路，从一个结点到相邻结点的一段物理线路，而中间没有任何其他的交换结点。在进行数据通信时，两台计算机之间的通信路径往往要经过许多段这样的链路。

数据链路：即逻辑链路，当需要在一条线路上传送数据时，除了必须有一条物理线路外，还必须有一些必要的通信协议来控制这些数据的传输，若把实现这些协议的硬件和软件加到链路上，就构成了数据链路。

现在最常用的方法是使用网络适配器来实现这些协议。一般的适配器都包括了数据链路层和物理层这两层的功能。

点对点信道的数据链路层的协议数据单元----帧

点对点信道的数据链路层在进行通信时的主要步骤如下：

* 结点A的数据链路层把网络层交下来的IP数据报添加首部和尾部封装成帧
* 结点A把封装好的帧发送给结点B的数据链路层
* 若结点B的数据链路层收到的帧无差错，则从收到的帧中提取出IP数据报交给上面的网络层；否则丢弃这个帧

## 数据链路层的三个基本问题

(封透差)

封装成帧、透明传输和差错检测

### 封装成帧

 封装成帧就是在一段数据的前后分别添加首部和尾部，这样就构成了一个帧。

一个帧的帧长等于帧的数据部分长度加上帧首部和帧尾部的长度。首部和尾部的一个重要作用就是进行帧定界。

控制字符SOH放在一帧的最前面，表示帧的首部开始；另一个控制字符EOT表示帧的结束。

### 透明传输

**字符填充或字节填充**

当传送的帧是用文本文件组成的帧时，其数据部分显然不会出现像SOH或EOT这样的帧定界控制字符，因此这样的传输就是透明传输。

但当数据部分是非ASCII码的文本文件时（如二进制代码的计算机程序或图像等）。如果数据中的某个字节的二进制代码恰好和SOH或EOT这种控制字符一样，数据链路层就会错误地“找到帧的边界“，此时这样的传输不是透明传输。

透明：某一个实际存在的事物看起来却好像不存在一样

为了解决透明传输问题，就必须设法使数据中可能出现的控制字符“SOH”和“EOT”在接收端不被解释为控制字符。

具体的方法为：发送端的数据链路层在数据中出现控制字符“SOH”和“EOT”的前面插入一个转义字符“ESC”，而在接收端的数据链路层在把数据送完网络层之前删除这个插入的转义字符。<font color=red>这种方法称为字符填充或字节填充。</font>

### 差错检测

在数据链路层广泛使用了<u>***循环冗杂检验CRC的检错技术***</u>。

“凡是接收端数据链路层接受的帧均无差错”

传输差错可分为：

* 比特差错
* 传输差错
  * 帧丢失
  * 帧重复
  * 帧失序



# 使用广播信道的数据链路层

## 局域网的数据链路层

局域网（最主要的特点是）：网络为一个单位所拥有，且地理范围和占地数目均有限

局域网有以下优点：（广阔靠）

* 具有广播功能，从一个站点可以很方便地访问全网
* 便于系统的扩展和逐渐演变，各设备的位置可灵活调整和改变
* 提高了系统的可靠性、可用性和生存型

共享信道要着重考虑的一个问题就是如何使众多用户能够合理而方便地共享通信媒体资源。这在技术上有两种方法：

* 静态划分通道

  频分复用、时分复用、统计时分复用、波分复用、码分复用

* 动态媒体接入控制，又称为多点接入

  特点是信道并非在用户通道时固定分配给用户，分为两大类：

  * 随机接入
  * 受控接入

### 以太网的两个标准

为了使数据链路层能更好地适应多种局域网标准，把局域网的数据链路层拆分为两个子层，即<u>逻辑链路控制LLC子层</u>和<u>媒体接入控制MAC（Media Access Control）子层</u>。但现在LLC子层已成为历史

与接入到传输媒体有关的内容都放在MAC子层，而LLC子层则与传输媒体无关，不管采用何种传输媒体和MAC子层的局域网对LLC子层来说都是透明的，即LLC子层看不见下面的局域网

### 适配器的作用

计算机与外界局域网的连接时通过通信适配器进行的。（即网卡）

适配器和局域网之间的通信是通过电缆或双绞线以串行传输方式进行的，而适配器和计算机之间的通信则是通过计算机主板上的I/O总线以并行传输方式进行的。

由此，适配器的作用：

* 进行数据串行传输和并行传输的转换
* 对数据进行缓存
* 实现以太网协议

![](D:\Work\TyporaNotes\note\计算机网络\pict\计算机通过适配器和局域网进行通信.png)

## CSMA/CD协议

最早的以太网是将许多计算机都连接在一根总线上。

当一台计算机发送数据时，总线上的所有计算机都能检测到这个数据。

为了实现一对一额通信，在发现数据帧时，在帧的首部写明接收站的地址。

采用较为了灵活的无连接的工作方式，即不必先建立连接就可以直接发送数据。此时需要在同一时间只允许一台计算机发送数据，即使用了CSMA/CD协议（载波监听多点接入/碰撞检测Carrier Sense Multiple Access with Collision Detection）

* 载波侦听：发送节点在发送数据之前，必须侦听传输介质（信道）是否处于空闲状态。
* 多路访问：具有两种含义，既表示多个节点可以同时访问信道，也表示一个节点发送的数据可以被多个结点所接收。
* 冲突检测：发送节点在发出数据的同时，还必须监听信道，判断是否发生冲突 

## 使用集线器的星行拓扑

这种以太网采用星行拓扑，在星行的中心则增加了一种可靠性非常高的设备，叫做集线器

## 以太网的MAC层

### MAC层的物理地址

在局域网中，硬件地址又称为物理地址或MAC地址。

48位的mac地址，有2^24个不同的地址，前24位是厂商识别码，后24位是节点标识符

局域网上的某台主机“地址”根本不能告诉我们这台主机位于什么地方。因此，严格地讲，局域网的“地址”应当是每一个站的“名字”或标识符。

MAC地址中6个字节的前三个字节：世界上凡要生产局域网适配器的厂家都必须向IEEE购买由这三个字节构成的这个号，这个号的正式名称是组织唯一标识符，即公司标识符

地址字段的后三个字节：由厂家自行指派，称为扩展标识符，只要保证生产出的适配器没有重复地址即可。可见一个地址可以生成2^24个不同的地址。

用这种方式得到的48位地址称为EUI-48，EUI表示扩展的唯一标识符

因此，MAC地址也叫做硬件地址或物理地址。

### MAC地址的分类

* 单播：第1个字节的最低位为0，可作为目的地址和源地址
* 组播：第1个字节的最低位为1，仅能作为目的地址
* 广播：48位全部为1

### MAC地址表

存储地址到端口的映射关系



# 扩展的以太网

## 在物理层扩展以太网

如果使用多个集线器，就可以连接成覆盖更大范围的多级星行结构的以太网，如，一个学院的三个系各有一个10BASE-T以太网，可通过一个主干集线器把各系的以太网连接起来，成为一个更大的以太网。

好处：

* 使这个学院不同系的以太网上的计算机能够进行跨系的通信
* 扩大了以太网覆盖的地理范围

缺点：

* 每一个系的以太网的最大吞吐量是10Mbit/s，因此三个系总的最大吞吐量共有30Mbit/s，在三个系的以太网通过集线器互连起来后就把三个碰撞域变成一个碰撞域，而这时的最大吞吐量仍然是一个系的吞吐量10Mbit/s，当某个系的两个站在通信时所传送的数据会通过所有的集线器进行转发，使得其他系的内部在这时都不能通信（一发送数据就会碰撞）
* 如果不同的系使用不同的以太网技术（如数据率不同），那么就不可能用集线器将它们互连起来

## 在数据链路层扩展以太网

使用网桥在数据链路层扩展以太网。

网桥对收到的帧根据其MAC帧的目的地址进行转发和过滤。当网桥收到一个帧时，并不是向所有的接口转发此帧，而是根据此帧的目的MAC地址，查找网桥中的地址表，然后确定将该帧转发到哪一个接口，或者是把它丢弃（即过滤）。

交换式集线器，常称为以太网交换机或第二层交换机，这种交换机工作在数据链路层。

### 透明网桥

- 目前使用得最多的网桥是透明网桥(transparent bridge)。
- “透明”是指局域网上的站点并不知道所发送的帧将经过哪几个网桥，因为网桥对各站来说是看不见的。
- 透明网桥是一种即插即用设备，其标准是 IEEE 802.1D。
- 透明网桥使用了生成树协议

### 网桥的自学习和转发帧的步骤

* 网桥收到一帧后进行自学习，查找转发表中与收到帧的源地址有无相匹配的项目，如没有，就在转发表中增加一个项目（源地址、进入的接口和时间），如有，则把原有的项目进行更新
* 转发帧。查找转发表中与收到帧的目的地址有无匹配的项目。
  * 如没有，则通过所有其他接口（但进入网桥的接口除外）进行转发
  * 如有，则按转发表中给出的接口进行转发
  * 若转发表中给出的接口就是该帧进入网桥的接口，则丢弃这个帧（因为这时候不需要经过网桥进行转发）

### 以太网交换机的特点

* 以太网交换机实质上就是一个多接口网桥（相互通信的主机都是独占传输媒体，无碰撞地传输数据）
* 以太网交换机的性能远远超过普通的集线器，而且价格并不贵，这就使工作在物理层的集线器逐渐地退出了市场

### 交换机的三项主要功能

（学习转发消除）

* MAC地址表学习
* 转发/过滤数据帧
* 消除第二层环路

### 以太网交换机的自学习功能

* A先向B发送一帧，从接口1进入到交换机，交换机收到帧后，先查找交换表，没有查到应从哪个接口转发这个帧，接着，交换机把这个帧的源地址A和接口1写入交换表中，并向除接口1以外的所有接口广播这个帧
* C和D将丢弃这个帧，因为目的地址不对。只有B才收入这个目的地址正确的帧，这也称为过滤。
* 从新写入的交换表的项目（A，1）可以看出，以后不管从哪一个接口收到帧，只要其目的地址是A，就应当把收到的帧从接口1转发出去，这样做的依据是：既然A发出的帧时从接口1进入到交换机的，那么从交换机的接口1转发出的帧也应当可以到达A
* 假定接下来B通过接口3向A发送一帧，交换机查找交换表，发现交换表中的MAC地址有A，表明要发送给A的帧应从接口1转发，于是就把这个帧传送到接口1转发给A。显然，现在已经没有必要再广播收到的帧。交换表这时新增加的项目（B,3），表明今后如有发送给B的帧，就应当从接口3转发出去。

注意：在交换表中每个项目都设有一定的有效时间，过期的项目就被自动删除。以太网交换机的这种自学习方法使得以太网交换机能够即插即用，不必人工进行配置，因此非常方便。

缺点：可能导致在网络的某个环路中无限制地兜圈子

为了解决这种兜圈子问题，制定了一个生成树协议STP，其要点就是不改变网络的实际拓扑，但在逻辑上则切断某些链路，使得从一台主机到所有其他主机的路径是无环路的树状结构，从而消除了兜圈子现象。

生成树协议：为了避免局域网中的单点故障、网络回环，解决成环以太网网络的“广播风暴”问题，从某种意义上说是一种网络保护技术，可以消除由于失误或者意外带来的循环连接

### 从总线以太网到星形以太网

以太网的重要协议CSMA/CD不使用了，但还是叫做以太网，原因：它的帧结构未改变，仍然采用以太网的帧结构。

## 虚拟局域网

<u>虚拟局域网VLAN：是由一些局域网网段构成的与物理位置无关的逻辑组，而这些网段具有某些共同的需求。</u>

每一个VLAN的帧都有一个明确的标识符，指明发送这个帧的计算机属于哪一个VLAN

虚拟局域网其实只是局域网给用户提供的一种服务，而并不是一种新型局域网

以太网交换机不向虚拟局域网以外的计算机传送某台计算机的广播信息。这样，虚拟局域网限制了接收广播信息的计算机数，使得网络不会因<u>传播过多的广播信息（“广播风暴”）</u>而引起性能恶化。

如果还使用原来的以太网帧格式，那么就无法区分是否划分了虚拟局域网。故为支持虚拟局域网，允许在以太网帧格式中插入一个4字节的标识符，用来指明发送该帧的计算机属于哪一个虚拟局域网。

VLAN标记字段的长度是4字节，VLAN标记的前两个字节的值是0x8100时，就知道现在插入了4字节的VLAN标记。前3位是用户优先级字段，接着的一位是规范格式标识符，最后12位是该虚拟局域网的VLAN标识符VID，它唯一地标识了这个以太网帧属于哪一个VLAN



# 本章的重要概念

* 数据链路层传送的协议数据单元是帧。数据链路层的三个基本问题：封装成帧、透明传输和差错检测。
* 循环冗余检验CRC是一种检错方法，而帧检验序列FCS是添加在数据后面的冗余码
* 点对点协议PPP是数据链路层使用最多的一种协议，它的特点是：简单、只检测差错，而不是纠正差错；不使用序号，也不进行流量控制；可同时支持多种网络层协议
* PPPoE是为宽带上网的主机使用的链路层协议
* 计算机与外界局域网的通信要通过通信适配器（或网络适配器），它又称为网络接口卡或网卡。<u>计算机的硬件地址就在适配器的ROM中</u>
* <u>以太网采用无连接的工作方式，对发送的数据帧不进行编号，也不要求对方发回确认。目的站收到有差错帧就把它丢弃，其他什么也不做</u>
* <u>以太网采用的协议是具有冲突检测的载波监听多点接入CSMA/CD。协议的要点是：发送前先监听，边发送边监听，一旦发现总线上出现了碰撞，就立即停止发送。然后按照退避算法等待一段随机时间后再次发送。因此，每一个站在自己发送数据之后的一小段时间内，存在着遭遇碰撞的可能性。以太网上各站点都平等地争用以太网信道。</u>
* 传统的总线以太网基本上都是使用集线器的双绞线以太网。这种以太网在物理上是星形网，但在逻辑上则是总线行网。<u>集线器工作在物理层，它的每个接口仅仅简单地转发比特，不进行碰撞检测。</u>
* <u>以太网的适配器有过滤功能，它只接受单播帧、广播帧或多播帧。</u>
* 使用集线器可以在物理层扩展以太网（扩展后的以太网仍然是一个网络）
* 交换式集线器，常称为以太网交换机或第二层交换机，这种交换机工作在数据链路层，它就是一个多接口的网桥，而每个接口都直接与某台单主机或另一个集线器相连，且<u>工作在全双工方式</u>。<u>以太网交换机能同时连通许多对的接口，使每一对相互通信的主机都能像独占通信媒体那样，无碰撞地传输数据</u>。
* 高速以太网有100Mbit/s的快速以太网、吉比特以太网和10Gbit/s的10吉比特以太网，最近还发展到100吉比特以太网。
* <u>局域网的拓扑：星形网、环形网、总线网、（树形网）！</u>

