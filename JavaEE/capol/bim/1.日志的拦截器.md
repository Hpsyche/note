```java
package com.capol.bim.manage.server.interceptor;

import com.alibaba.fastjson.JSONArray;
import com.alibaba.fastjson.JSONException;
import com.alibaba.fastjson.JSONObject;
import com.capol.base.utils.StringUtil;
import com.capol.bim.manage.common.entity.dto.system.LogDTO;
import com.capol.bim.manage.server.enums.HttpMethodEnum;
import com.capol.bim.manage.server.helpers.BodyReaderHttpServletRequestWrapper;
import com.capol.bim.manage.server.service.system.IElementService;
import com.capol.bim.manage.server.service.system.ILogService;
import com.capol.bim.manage.server.util.SpringContextUtil;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.lang3.StringUtils;
import org.springframework.context.ApplicationContext;
import org.springframework.web.method.HandlerMethod;
import org.springframework.web.servlet.HandlerMapping;
import org.springframework.web.servlet.ModelAndView;
import org.springframework.web.servlet.handler.HandlerInterceptorAdapter;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.lang.reflect.Field;
import java.lang.reflect.Method;
import java.util.*;
import java.util.regex.Pattern;

/**
 * 〈一句话功能简述〉<br>
 *
 * @Author yuanyanxiao
 * @Date 2019/8/2 15:49
 */
@Slf4j
public class OperationLogInterceptor extends HandlerInterceptorAdapter {


    private ILogService logService = (ILogService) SpringContextUtil.getBean("logServiceImpl");

    /**
     *  菜单
     **/
    private static final String MENU = "menu";
    /**
     *  操作
     **/
    private static final String OPERATION = "operation";


    private static final String ID = "id";

    private static final int MAX_MESSAGE_LENGTH = 60000;

    private static final int MAX_PROPERTY_LENGTH = 100;

    private static final int MAX_PROPERTY_ARRAY_LENGTH = 15;


    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler)
            throws Exception {
        if(handler instanceof HandlerMethod) {
            HandlerMethod method = (HandlerMethod) handler;
            String methodType = request.getMethod();

            if(StringUtils.equalsIgnoreCase(HttpMethodEnum.POST.name(), methodType)
             || StringUtils.equalsIgnoreCase(HttpMethodEnum.DELETE.name(), methodType)
            || StringUtils.equalsIgnoreCase(HttpMethodEnum.PUT.name(), methodType)){
                insertLog(request,method);
            }
        }
        return true;
    }


    @Override
    public void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler,
                           ModelAndView modelAndView) throws Exception {
    }

    /**
     * 根据http请求类型插入日志记录
     * @param request
     * @param handlerMethod
     */
    private void insertLog(HttpServletRequest request,HandlerMethod handlerMethod) throws Exception{
        List<Map<String,String>> menuOperationList =  getMenuOperation(request);

        if(menuOperationList.size() > 0) {
            JSONObject data = new JSONObject();
            data.put("method", request.getMethod());
            //获取@RequestBody注解的参数
            String requestBody = new BodyReaderHttpServletRequestWrapper(request).getBodyString();

            //pathVariable
            Map pathVariable = (Map) request.getAttribute(HandlerMapping.URI_TEMPLATE_VARIABLES_ATTRIBUTE);

            //获取普通参数
            Enumeration<?> parameterNames = request.getParameterNames();
            Map<String, String> params = new HashMap<>(16);
            while(parameterNames.hasMoreElements()) {
                String name=(String) parameterNames.nextElement();
                params.put(name, request.getParameter(name));
            }

            if(StringUtil.isNotBlank(requestBody)){
                try{
                    JSONObject jsonObject = JSONObject.parseObject(requestBody);
                    for (String key : jsonObject.keySet()){
                        Object o = jsonObject.get(key);
                        jsonObject.put(key, subProperty(o));
                    }
                    data.put("requestBody",jsonObject);
                }catch(JSONException j){
                    JSONArray jsonArray = JSONObject.parseArray(requestBody);
                    if(jsonArray.size() > Math.min(MAX_PROPERTY_ARRAY_LENGTH, jsonArray.size())){
                        JSONArray jsonArrayNew = new JSONArray();
                        for (int i = 0; i < MAX_PROPERTY_ARRAY_LENGTH; i++) {
                            jsonArrayNew.add(jsonArray.get(i));
                        }
                        jsonArrayNew.add("...");
                        jsonArray = jsonArrayNew;
                    }
                    data.put("requestBody",jsonArray);
                }
            }
            if(pathVariable != null && pathVariable.entrySet().size() > 0){
                data.put("pathVariable", pathVariable);
            }
            if(params != null && params.entrySet().size() > 0){
                data.put("params", params);
            }
            //如果有id则查询一下数据
            String id = getId(request);
            if(StringUtils.isNotEmpty(id)){
                Object record = getRecordById(handlerMethod,id);
                setField(record);
                data.put("record", record);
            }

            LogDTO entity = new LogDTO();
            String menuSb = null;
            StringBuffer operateSb = new StringBuffer();
            for (Map<String,String> map : menuOperationList) {
                menuSb = map.get(MENU);
                operateSb.append(map.get(OPERATION)).append("/");
            }
            entity.setMenu(menuSb);
            entity.setOperation(operateSb.deleteCharAt(operateSb.length()-1).toString());
            entity.setUri(request.getRequestURI());
            String msg = data.toString();
            if(msg.length() > MAX_MESSAGE_LENGTH){
                msg = msg.substring(0, MAX_MESSAGE_LENGTH) + "...";
            }
            entity.setMsg(msg);
            logService.insert(entity);
        }
    }

    /**
     * @Author yuanyanxiao
     * @Description //属性过长处理
     * @Date 10:05 2019/8/21
     * @Param [object]
     * @return void
     **/
    private void setField(Object object) {
        try {
            Field[] field = object.getClass().getDeclaredFields();
            for(int j=0 ; j<field.length ; j++) {
                field[j].setAccessible(true);
                String name = field[j].getName();
                name = name.substring(0, 1).toUpperCase() + name.substring(1);
                String type = field[j].getGenericType().toString();
                if("class java.lang.String".equals(type)){
                    Method m = object.getClass().getMethod("get"+name);
                    String value = (String) m.invoke(object);
                    if(value != null && value.length() > MAX_PROPERTY_LENGTH ){
                        System.out.println("attribute value:"+value);
                        Method setMethod = object.getClass().getMethod("set"+name, String.class);
                        setMethod.invoke(object, value.substring(0, MAX_PROPERTY_LENGTH ) + "...");
                    }
                }

            }
        } catch(Exception e){
            log.error("属性过长，截取失败。");
        }


    }

    private Object subProperty(Object o){
        Object res = o;
        if(o != null && o.toString().length() > MAX_PROPERTY_LENGTH){
            res = o.toString().substring(0, MAX_PROPERTY_LENGTH) + "...";
        }
        return res;
    }
    /**
     * 获取请求中的id
     * @param request
     * @return
     */
    private String getId(HttpServletRequest request) {
        Map<?, ?> pathVariables = (Map<?, ?>) request.getAttribute(HandlerMapping.URI_TEMPLATE_VARIABLES_ATTRIBUTE);
        String id = (String)pathVariables.get(ID);
        if(StringUtil.isBlank(id)) {
            id = request.getParameter(ID);
        }
        if(StringUtil.isBlank(id)) {
            for(Object key : pathVariables.keySet()){
                if(pathVariables.get(key) != null){
                    id = pathVariables.get(key).toString();
                    break;
                }

            }

        }
        return id;
    }

    /**
     * 获取uri对应的菜单和操作
     * @param request
     * @return
     */
    private List<Map<String,String>> getMenuOperation(HttpServletRequest request){
        List<Map<String,String>> result = new ArrayList<>();
        IElementService elementService =  (IElementService) SpringContextUtil.getBean("elementServiceImpl");
        List<Map<String,Object>> elementMenu = elementService.selectAllElementWithMenu();
        for(Map<String,Object> map:elementMenu) {
            if(StringUtils.equalsAnyIgnoreCase(request.getMethod(), map.get("method").toString())
                    && Pattern.matches(map.get("uri").toString(), request.getRequestURI())) {
                Map<String,String> temp = new HashMap<>(2);
                temp.put(OPERATION, map.get("name").toString());
                temp.put(MENU, map.get("title").toString());
                result.add(temp);
            }
        }
        return result;
    }


    /**
     * 调用service通过id查询记录
     * @param handlerMethod
     * @param id
     * @return
     */
    private Object getRecordById(HandlerMethod handlerMethod,String id) {
        Object obj = null;
        try {
            String serviceName = getServiceImplName(handlerMethod.getBeanType().getName());
            Class<?> clazz = Class.forName(serviceName);
            ApplicationContext context = SpringContextUtil.getApplicationContext();
            Object serviceBean = context.getBean(clazz);
            context.getAutowireCapableBeanFactory().autowireBean(serviceBean);
            //调用selectById方法获取记录
            Method serviceMethod = clazz.getSuperclass().getDeclaredMethod("selectById", Object.class);
            serviceMethod.setAccessible(true);
            obj = serviceMethod.invoke(serviceBean, Long.valueOf(id));
        }catch(Exception e) {
            log.error("通过id获取记录失败");
        }
        return obj;
    }


    /**
     * 将controller类名转成service实现类名
     * @param controllerName
     * @return
     */
    private String getServiceImplName(String controllerName){
        String tempName = controllerName.replace("web.controller", "service").replace("Controller", "ServiceImpl");
        String[] split = tempName.split("\\.");
        StringBuffer serviceName = new StringBuffer();
        for(int i=0 ; i<split.length ; i++){
            if(i == split.length-2){
                serviceName.append(split[i]).append(".")
                        .append("impl").append(".");
            }else{
                serviceName.append(split[i]).append(".");
            }
        }
        return serviceName.deleteCharAt(serviceName.length()-1).toString();
    }



```

获取请求body

```java
package com.capol.enterprise.manage.server.helpers;

import javax.servlet.ReadListener;
import javax.servlet.ServletInputStream;
import javax.servlet.ServletRequest;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletRequestWrapper;
import java.io.*;
import java.nio.charset.Charset;

/**
 * 〈一句话功能简述〉<br>
 *
 * @Author yuanyanxiao
 * @Date 2019/8/2 15:58
 */
public class BodyReaderHttpServletRequestWrapper extends HttpServletRequestWrapper {

    private final byte[] body;

    public BodyReaderHttpServletRequestWrapper(HttpServletRequest request) throws IOException {
        super(request);
        String sessionStream = getBodyString(request);
        body = sessionStream.getBytes(Charset.forName("UTF-8"));
    }

    public String  getBodyString(){
        return new String(body,Charset.forName("UTF-8"));
    }

    /**
     * 获取请求Body
     * @param request
     * @return
     */
    private String getBodyString(final ServletRequest request) {
        StringBuilder sb = new StringBuilder();
        InputStream inputStream = null;
        BufferedReader reader = null;
        try {
            inputStream = cloneInputStream(request.getInputStream());
            reader = new BufferedReader(new InputStreamReader(inputStream, Charset.forName("UTF-8")));
            String line = "";
            while ((line = reader.readLine()) != null) {
                sb.append(line);
            }
        }
        catch (IOException e) {
            e.printStackTrace();
        }
        finally {
            if (inputStream != null) {
                try {
                    inputStream.close();
                }
                catch (IOException e) {
                    e.printStackTrace();
                }
            }
            if (reader != null) {
                try {
                    reader.close();
                }
                catch (IOException e) {
                    e.printStackTrace();
                }
            }
        }
        return sb.toString();
    }

    /**
     * Description: 复制输入流</br>
     *
     * @param inputStream
     * @return</br>
     */
    public InputStream cloneInputStream(ServletInputStream inputStream) {
        ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream();
        byte[] buffer = new byte[1024];
        int len;
        try {
            while ((len = inputStream.read(buffer)) > -1) {
                byteArrayOutputStream.write(buffer, 0, len);
            }
            byteArrayOutputStream.flush();
        }
        catch (IOException e) {
            e.printStackTrace();
        }
        InputStream byteArrayInputStream = new ByteArrayInputStream(byteArrayOutputStream.toByteArray());
        return byteArrayInputStream;
    }
    @Override
    public BufferedReader getReader() throws IOException {
        return new BufferedReader(new InputStreamReader(getInputStream()));
    }

    @Override
    public ServletInputStream getInputStream() throws IOException {

        final ByteArrayInputStream bais = new ByteArrayInputStream(body);

        return new ServletInputStream() {

            @Override
            public int read() throws IOException {
                return bais.read();
            }

            @Override
            public boolean isFinished() {
                return false;
            }

            @Override
            public boolean isReady() {
                return false;
            }

            @Override
            public void setReadListener(ReadListener readListener) {

            }
        };
    }
}

```

全局拦截器的配置如下

```java
package com.capol.bim.manage.server.helpers.config;
import com.capol.auth.client.helpers.interceptor.UserAuthRestInterceptor;
import com.capol.base.exception.handle.GlobalExceptionHandler;
import com.capol.bim.manage.server.interceptor.OperationLogInterceptor;
import com.capol.bim.manage.server.interceptor.UriInterceptor;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Primary;
import org.springframework.web.servlet.config.annotation.InterceptorRegistry;
import org.springframework.web.servlet.config.annotation.ResourceHandlerRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

/**
 * Created by zhangping
 * Date: 09/04/03
 * Time: 15:13
 * Version 1.0.0
 */
@Configuration("bimWebConfig")
@Primary
public class WebConfig implements WebMvcConfigurer {
    @Bean
    GlobalExceptionHandler getGlobalExceptionHandler() {
        return new GlobalExceptionHandler();
    }

    @Override
    public void addInterceptors(InterceptorRegistry registry) {

        registry.addInterceptor(getUserAuthRestInterceptor()).addPathPatterns("/**")
                .excludePathPatterns("/swagger-resources/**", "/webjars/**", "/v2/api-docs/**", "/swagger-ui.html/**","/swagger/**");
        registry.addInterceptor(new OperationLogInterceptor())
                .addPathPatterns("/**")
                .excludePathPatterns("/api/**");

        registry.addInterceptor(getUriInterceptor()).addPathPatterns("/**").excludePathPatterns("/api/**","/menu/auth");
    }


    @Bean
    UriInterceptor getUriInterceptor(){
        return new UriInterceptor();
    }
    @Bean
    UserAuthRestInterceptor getUserAuthRestInterceptor() {
        return new UserAuthRestInterceptor();
    }

    @Override
    public void addResourceHandlers(ResourceHandlerRegistry registry) {
        //过滤swagger
        registry.addResourceHandler("swagger-ui.html")
                .addResourceLocations("classpath:/META-INF/resources/");

        registry.addResourceHandler("/webjars/**")
                .addResourceLocations("classpath:/META-INF/resources/webjars/");

        registry.addResourceHandler("/swagger-resources/**")
                .addResourceLocations("classpath:/META-INF/resources/swagger-resources/");

        registry.addResourceHandler("/swagger/**")
                .addResourceLocations("classpath:/META-INF/resources/swagger*");

        registry.addResourceHandler("/v2/api-docs/**")
                .addResourceLocations("classpath:/META-INF/resources/v2/api-docs/");


        registry.addResourceHandler("/**").addResourceLocations("classpath:/static/");

    }

}
```

### tip

用户权限拦截器

```java
package com.capol.auth.client.helpers.interceptor;
import com.alibaba.fastjson.JSONObject;
import com.capol.auth.client.api.ServiceAuthApi;
import com.capol.auth.client.helpers.annotation.IgnoreUserToken;
import com.capol.auth.client.helpers.config.UserAuthConfig;
import com.capol.auth.client.utils.UserAuthUtil;
import com.capol.auth.common.entity.IJwtInfo;
import com.capol.auth.common.entity.JwtInfoDTO;
import com.capol.base.exception.auth.UserTokenException;
import com.capol.base.helpers.context.BaseContextHandler;
import com.capol.base.response.ObjectResponse;
import com.capol.base.utils.StringUtil;
import com.capol.cache.service.IRedisService;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.lang3.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.method.HandlerMethod;
import org.springframework.web.servlet.handler.HandlerInterceptorAdapter;
import org.springframework.web.servlet.resource.ResourceHttpRequestHandler;
import javax.servlet.http.Cookie;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.util.List;

/**
 * Created by huangpingqiang
 * Date: 19/01/03
 * Time: 15:13
 * Version 1.0.0
 */
@Slf4j
public class UserAuthRestInterceptor extends HandlerInterceptorAdapter {

    @Autowired
    private UserAuthUtil userAuthUtil;

    @Autowired
    private UserAuthConfig userAuthConfig;

    @Autowired
    private ServiceAuthApi serviceAuthFeign;

    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {

        if(handler instanceof ResourceHttpRequestHandler){
            return super.preHandle(request, response, handler);
        }
        HandlerMethod handlerMethod = (HandlerMethod) handler;
        // 配置该注解，说明不进行用户拦截
        IgnoreUserToken annotation = handlerMethod.getBeanType().getAnnotation(IgnoreUserToken.class);
        if (annotation == null) {
            annotation = handlerMethod.getMethodAnnotation(IgnoreUserToken.class);
        }
        if (annotation != null) {
            return super.preHandle(request, response, handler);
        }
        String token = request.getHeader(userAuthConfig.getTokenHeader());
        if (StringUtils.isEmpty(token)) {
            if (request.getCookies() != null) {
                for (Cookie cookie : request.getCookies()) {
                    if (cookie.getName().equals(userAuthConfig.getTokenHeader())) {
                        token = cookie.getValue();
                    }
                }
            }
            if (StringUtils.isEmpty(token)) {
                token = request.getParameter("token");
            }
        }
        IJwtInfo infoFromToken = userAuthUtil.getInfoFromToken(token);
        log.info("Auth Client => UserAuthRestInterceptor: "+ JSONObject.toJSONString(infoFromToken));
        BaseContextHandler.setUsername(infoFromToken.getUniqueName());
        BaseContextHandler.setName(infoFromToken.getName());
        BaseContextHandler.setUserID(infoFromToken.getId());
        BaseContextHandler.setToken(token);
        return super.preHandle(request, response, handler);
    }

    @Override
    public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception {
        BaseContextHandler.remove();
        super.afterCompletion(request, response, handler, ex);
    }
}
```

注意：异常情况

由以上我们可以看到，在日志拦截器的put、post、get中需要getBodyString，从流中获取数据，此时拦截器执行完后交由各controller，由于流中数据已被读出并关闭流，此时会报如下controller找不到参数等问题的异常org.springframework.http.converter.HttpMessageNotReadableException: Required request body is missing。

解决方案：

添加过滤器，读取流后继续写出去

```java
package com.capol.bim.manage.server.filter;

import com.capol.bim.manage.server.helpers.BodyReaderHttpServletRequestWrapper;

import javax.servlet.*;
import javax.servlet.http.HttpServletRequest;
import java.io.IOException;

/**
 * 〈一句话功能简述〉<br>
 *
 * @Author yuanyanxiao
 * @Date 2019/8/12 17:09
 */
public class ChannelFilter implements Filter {

    @Override
    public void init(FilterConfig filterConfig) throws ServletException {

    }

    @Override
    public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException {
        // 防止流读取一次后就没有了, 所以需要将流继续写出去
        HttpServletRequest httpServletRequest = (HttpServletRequest) servletRequest;
        ServletRequest requestWrapper = new BodyReaderHttpServletRequestWrapper(httpServletRequest);

        filterChain.doFilter(requestWrapper, servletResponse);
    }

    @Override
    public void destroy() {

    }
}
```

同时对所有的url添加此过滤器

```java
package com.capol.bim.manage.server.helpers.config;

import com.capol.bim.manage.server.filter.ChannelFilter;
import org.springframework.boot.web.servlet.FilterRegistrationBean;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

/**
 * 〈一句话功能简述〉<br>
 *
 * @Author yuanyanxiao
 * @Date 2019/8/12 17:10
 */
@Configuration
public class FilterConfig {
    @Bean
    public FilterRegistrationBean registFilter() {
        FilterRegistrationBean registration = new FilterRegistrationBean();
        registration.setFilter(new ChannelFilter());
        registration.addUrlPatterns("/*");
        registration.setName("channelFilter");
        registration.setOrder(1);
        return registration;
    }
}
```

此处解释下FilterRegistrationBean：

Springboot中会使用FilterRegistrationBean来注册Filter，Filter是Servlet规范里面的，属于容器范围，Springboot中我们没有web.xml，那Springboot中，Filter是如何交给Servlet容器的呢？

在springboot添加过滤器有两种方式：

1、通过创建FilterRegistrationBean的方式（建议使用此种方式，统一管理，且通过注解的方式若不是本地调试，如果在filter中需要增加cookie可能会存在写不进前端情况）同时可以为filter设置排序值，让spring在注册web filter之前排序后再依次注册。

2、通过注解@WebFilter的方式