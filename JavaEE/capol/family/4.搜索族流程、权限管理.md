## 族流程搜索

FamilySearchVO--->extends PageHelperVO

```java
@ApiModel("族列表查询条件实体类")
@Data
public class FamilySearchVO extends PageHelperVO implements Serializable {

    private static final long serialVersionUID = 1L;

    @ApiModelProperty("专业编号")
    private String specialityNo;

    @ApiModelProperty("分类层级编号")
    private String categoryHierarchyNo;

    @ApiModelProperty("族名称")
    private String familyName;

    @ApiModelProperty("状态：1：待制作，2：待互检，3：待审核，4：互检驳回，5：审核驳回，6：已完成，7：已取消")
    private Integer status;

    @ApiModelProperty("是否我参与的，1：是，0：否")
    private Integer myJoined;

    @ApiModelProperty("用户id")
    private Long userId;
}
```

 private static final long serialVersionUID = 1L;???

```java
package com.capol.family.manage.common.entity.vo;

import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

import java.io.Serializable;

@Data
public class PageHelperVO implements Serializable {

    private static final long serialVersionUID = 1L;

    @ApiModelProperty("当前分页数")
    private Integer page;

    @ApiModelProperty("当前页显示数量")
    private Integer limit;

    @ApiModelProperty("排序字段")
    private String column;

    @ApiModelProperty("排序规则（desc、asc）")
    private String orderBy;

}

```

```java
@Override
public PageInfo<FamilyInfoVO> selectMakeFamilyList(FamilySearchVO familySearchVO) {
    PageInfo<FamilyInfoVO> pageInfo = new PageInfo<>();
    PageHelper.startPage(familySearchVO.getPage(), familySearchVO.getLimit());
    if (StringUtil.isNotBlank(familySearchVO.getColumn())) {
        familySearchVO.setColumn(HumpUndelineConvertUtil.HumpToUnderline(familySearchVO.getColumn()));
    }

    if (familySearchVO.getMyJoined() == 1) {
        // 获取当前在线用户
        String currentLogginUserIdStr = BaseContextHandler.getUserID();
        if (StringUtils.isBlank(currentLogginUserIdStr)){
            log.error("无法获取当用户");
        }
        familySearchVO.setUserId(Long.parseLong(currentLogginUserIdStr));
    }

    List<FamilyInfoVO> list = mapper.selectMakeFamilyList(familySearchVO);

    pageInfo = new PageInfo<FamilyInfoVO>(list);
    return pageInfo;
}
```

日志处理：log.error

使用了PageHelper：（原理）？

获取当前uid？ BaseContextHandler.getUserID()

common-base服务下的方法

```java
package com.capol.base.helpers.context;
import com.capol.base.helpers.constant.SystemConstant;
import com.capol.base.utils.StringUtil;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.mockito.runners.MockitoJUnitRunner;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import java.util.HashMap;
import java.util.Map;
import static org.junit.Assert.assertEquals;

public class BaseContextHandler {
    public static ThreadLocal<Map<String, Object>> threadLocal = new ThreadLocal<Map<String, Object>>();

    public static void set(String key, Object value) {
        Map<String, Object> map = threadLocal.get();
        if (map == null) {
            map = new HashMap<String, Object>();
            threadLocal.set(map);
        }
        map.put(key, value);
    }

    public static Object get(String key){
        Map<String, Object> map = threadLocal.get();
        if (map == null) {
            map = new HashMap<String, Object>();
            threadLocal.set(map);
        }
        return map.get(key);
    }

    public static String getUserID(){
        Object value = get(SystemConstant.CONTEXT_KEY_USER_ID);
        return returnObjectValue(value);
    }

    public static String getUsername(){
        Object value = get(SystemConstant.CONTEXT_KEY_USERNAME);
        return returnObjectValue(value);
    }


    public static String getName(){
        Object value = get(SystemConstant.CONTEXT_KEY_USER_NAME);
        return StringUtil.getObjectValue(value);
    }

    public static String getToken(){
        Object value = get(SystemConstant.CONTEXT_KEY_USER_TOKEN);
        return StringUtil.getObjectValue(value);
    }
    public static void setToken(String token){set(SystemConstant.CONTEXT_KEY_USER_TOKEN,token);}

    public static void setName(String name){set(SystemConstant.CONTEXT_KEY_USER_NAME,name);}

    public static void setUserID(String userID){
        set(SystemConstant.CONTEXT_KEY_USER_ID,userID);
    }

    public static void setUsername(String username){
        set(SystemConstant.CONTEXT_KEY_USERNAME,username);
    }

    private static String returnObjectValue(Object value) {
        return value==null?null:value.toString();
    }

    public static void remove(){
        threadLocal.remove();
    }

}
```

mapper语句

```xml
<select id="selectMakeFamilyList" parameterType="com.capol.family.manage.server.entity.vo.familyProcess.FamilySearchVO" resultType="com.capol.family.manage.server.entity.vo.familyInfo.FamilyInfoVO">
    SELECT distinct p.id processId, p.status processStatus, p.process_no processNo,p.update_time processUpdateTime,
    i.id id, i.family_name familyName, i.family_no familyNo, i.release_no releaseNo, i.speciality_no specialityNo, i.speciality_id specialityId, i.speciality_name specialityName,
    i.category_hierarchy_no categoryHierarchyNo, i.category_hierarchy_name categoryHierarchyName, i.maker_id makerId, i.maker_name makerName,
    i.rummager_id rummagerId, i.rummager_name rummagerName, i.auditor_id auditorId, i.auditor_name auditorName, i.system_family_flag systemFamilyFlag,
    i.maker_reason makerReason, i.update_flag updateFlag, i.update_reasom updateReasom, i.status status, i.has_family_file hasFamilyFile, i.has_family_type hasFamilyType,
    i.creator creator, i.creator_id creatorId, i.create_time createTime
    FROM t_family_process p LEFT JOIN t_family_info i on p.family_id = i.id LEFT JOIN t_speciality_category sc on p.family_id = sc.family_id
    WHERE
    1 = 1
    <if test="status != null" >
        and p.status = #{status}
    </if>
    <if test="familyName != null and familyName != '' ">
        and i.family_name like '%${familyName}%'
    </if>
    <if test="myJoined == 1">
        and  (i.creator_id = #{userId} or i.maker_id = #{userId} or i.rummager_id = #{userId} or i.auditor_id = #{userId})
    </if>
    <if test="specialityNo !=null and specialityNo != ''">
        and  sc.speciality_no = #{specialityNo}
    </if>
    <if test="categoryHierarchyNo != null and categoryHierarchyNo != ''" >
        and  sc.category_hierarchy_no like '%${categoryHierarchyNo}%'
    </if>
    and p.status in (1,2,3,4,5)
    <choose>
        <when test="column == 'processUpdateTime'" >
            order by p.${column} ${orderBy}
        </when>
        <when test="column != null and column != '' ">
            order by i.${column} ${orderBy}
        </when>
        <otherwise>
            order by i.update_time DESC
        </otherwise>
    </choose>
</select>
```

三表连接：流程表---族id（族表）---分类表(177ms)

mybatis中like：like '%${familyName}%'

## 人员权限管理

restful风格

新增:Post   /staffSpeicality 

参数（人员id，专业id的dto）（还可以选择全部专业，值为all）

```java
@ApiOperation(value = "新增", notes = "参数：userIds,specialityNo不能为空，userIds多个逗号分隔，specialityNo只能一个，如果全部专业specialityNo值为all")
@PostMapping("/staffSpeciality")
public BaseResponse insertStaffSpeciality(@RequestBody StaffSpecialityDTO dto) {
    if(StringUtils.isEmpty(dto.getUserIds())
       || StringUtils.isEmpty(dto.getSpecialityNo())){
        throw new InvalidParamException(MessageConstant.INVALID_PARAM);
    }
    staffSpecialityService.insertStaffSpeciality(dto);
    return new BaseResponse(FamilyResponseCode.RESPONSE_CODE_200, MessageConstant.ADD_SUEECSS);
}
```

异常处理机制：

InvalidParamException  extends RuntimeException

```java
package com.capol.family.manage.common.exception.handle;

import com.capol.base.exception.handle.GlobalExceptionHandler;
import com.capol.base.response.BaseResponse;
import com.capol.family.manage.common.exception.entity.InvalidParamException;
import com.capol.family.manage.common.exception.entity.InvokerServiceException;
import com.capol.family.manage.common.exception.entity.NotAllowedException;
import com.capol.family.manage.common.exception.entity.ObjectConvertException;
import com.capol.family.manage.common.helpers.code.FamilyResponseCode;
import lombok.extern.slf4j.Slf4j;
import org.springframework.web.bind.annotation.ControllerAdvice;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.ResponseBody;

import javax.servlet.http.HttpServletResponse;

/**
 * 统一异常处理
 * @Author yuanyanxiao
 * @Description //TODO
 * @Date 10:40 2019/5/29
 * @Param
 * @return
 **/
@ControllerAdvice("com.capol.family")
@ResponseBody
@Slf4j
public class FamilyGlobalExceptionHandler extends GlobalExceptionHandler {

    @ExceptionHandler(InvalidParamException.class)
    public BaseResponse invalidParamException(HttpServletResponse response, Exception ex) {
        response.setStatus(FamilyResponseCode.RESPONSE_CODE_INVALID_PARAM);
        log.error(ex.getMessage(),ex);
        return new BaseResponse(FamilyResponseCode.RESPONSE_CODE_INVALID_PARAM, ex.getMessage());
    }


    @ExceptionHandler(NotAllowedException.class)
    public BaseResponse notAllowedException(HttpServletResponse response, Exception ex) {
        response.setStatus(FamilyResponseCode.RESPONSE_CODE_NOT_ALLOWED);
        log.error(ex.getMessage(),ex);
        return new BaseResponse(FamilyResponseCode.RESPONSE_CODE_NOT_ALLOWED, ex.getMessage());
    }

    @ExceptionHandler(ObjectConvertException.class)
    public BaseResponse objectConvertException(HttpServletResponse response, Exception ex) {
        response.setStatus(FamilyResponseCode.RESPONSE_CODE_CONVERT_FAILD);
        log.error(ex.getMessage(),ex);
        return new BaseResponse(FamilyResponseCode.RESPONSE_CODE_CONVERT_FAILD, ex.getMessage());
    }

    @ExceptionHandler(InvokerServiceException.class)
    public BaseResponse invokerServiceException(HttpServletResponse response, Exception ex) {
        response.setStatus(FamilyResponseCode.RESPONSE_CODE_INVOKER_SERVICE_FAILD);
        log.error(ex.getMessage(),ex);
        return new BaseResponse(FamilyResponseCode.RESPONSE_CODE_INVOKER_SERVICE_FAILD, ex.getMessage());
    }
}
```

```java
 @Override
    public void insertStaffSpeciality(StaffSpecialityDTO dto) {
        List<StaffSpecialityDTO> list = buildList(dto);
        if(list.size() > 0){
            staffSpecialityMapper.insertStaffSpeciality(list);
        }else{
            throw new RepeatExcption(MessageConstant.STAFF_SPECIALITY_REPEAT);
        }
    }

    private List<StaffSpecialityDTO> buildList(StaffSpecialityDTO dto) {
        List<StaffSpecialityDTO> list = new ArrayList<>();
        String userIds = dto.getUserIds();
        String[] userIdArr = userIds.split(",");
        for(String idStr : userIdArr){
            StaffSpecialityDTO staffSpecialityDTO = new StaffSpecialityDTO();
            staffSpecialityDTO.setStatus(FamilyConstant.STATUS_NORMAL);
            staffSpecialityDTO.setSpecialityNo(dto.getSpecialityNo());
            staffSpecialityDTO.setUserId(Long.parseLong(idStr));
            EntityUtil.setCreatAndUpdatInfo(staffSpecialityDTO);
            //不能重复设置
            boolean isRepeat = false;
            List<StaffSpecialityDTO> listByUserId = this.selectByUserId(Long.parseLong(idStr));
            if(listByUserId != null && listByUserId.size() > 0){
                isRepeat = true;
            }
            if(! isRepeat){
                list.add(staffSpecialityDTO);
            }
        }
        return list;
    }
```

```java
//不能重复设置
            boolean isRepeat = false;
            List<StaffSpecialityDTO> listByUserId = this.selectByUserId(Long.parseLong(idStr));
            if(listByUserId != null && listByUserId.size() > 0){
                isRepeat = true;
            }
            if(! isRepeat){
                list.add(staffSpecialityDTO);
            }
```

```java
<insert id="insertStaffSpeciality" parameterType="java.util.List" >
    insert into t_staff_speciality(<include refid="fullStaffSpecialityColumns"/>)
    <foreach collection="list" item="item" index="index" separator="UNION ALL">
            (
            SELECT
            #{item.id}, #{item.userId}, #{item.specialityNo}, #{item.status},
    #{item.creator},#{item.creatorId},sysdate(),#{item.createdHostIp},#{item.lastOperator},#{item.lastOperatorId},sysdate(),#{item.updateHostIp}
    FROM dual
            )
        </foreach>
    </insert>
```

删除:Delete   /id

```java
    @Override
    public void deleteStaffSpeciality(Long id) {
        StaffSpecialityDTO dto = new StaffSpecialityDTO();
        dto.setStatus(FamilyConstant.STATUS_DELETE);
        dto.setId(id);
        this.updateSelectiveById(dto);
    }
```

其实只是setStatus为delete；

```java
    /* 状态1：正常，0：删除 */
    public final static Integer STATUS_DELETE = 0;

    /* 状态1：正常，0：删除 */
    public final static Integer STATUS_NORMAL = 1;
```

修改:Update  /id

```java
@Override
public void updateStaffSpeciality(StaffSpecialityDTO dto) {
    StaffSpecialityDTO param = new StaffSpecialityDTO();
    param.setId(dto.getId());
    param.setSpecialityNo(dto.getSpecialityNo());
    this.updateSelectiveById(param);
}
```

查询:Get  /list

```java
@ApiOperation(value = "查询", notes = "参数：page,limit,userName, specialityNo")
@GetMapping("/list")
public BaseResponse selectDeptSpecialityList(StaffSpecialityVO vo) throws Exception {

    List<StaffSpecialityVO> list = staffSpecialityService.selectStaffSpecialityList(vo);

    Integer total = staffSpecialityService.getTotal(vo);

    return new TableResultResponse(total, list);
}
```

复杂的sql

```sql
    <select id="selectStaffSpecialityList" parameterType="com.capol.family.manage.server.entity.vo.system.StaffSpecialityVO"  resultMap="simpleStaffSpecialityMap">
        select ss.*, u.name user_name, u.company_name,
        if(ss.speciality_no='all',"全部专业",(
        SELECT GROUP_CONCAT(b.speciality_name  ORDER BY b.speciality_no)
        FROM t_speciality b
        where FIND_IN_SET(b.speciality_no, ss.speciality_no)
        and b.status =1
        ) )speciality_name,

        COALESCE(
        (select name from t_department d where id = u.dept_id and d.level = 4),
        (select name from t_department d where id = (select parent_id from t_department where id = u.dept_id) and d.level = 4)
        ) first_dept_name,
        (select name from t_department d where id = u.dept_id and d.level = 5) second_dept_name

        from t_staff_speciality ss
        left join t_employee u on u.id = ss.user_id
        where ss.status =1
        <if test="specialityNo != null and specialityNo != ''">
            and ss.speciality_no like #{specialityNo}
        </if>
        <if test="userName != null and userName != ''">
            and u.name like #{userName}
        </if>

        <if test="column == 'updateTime' and orderBy == 'desc'">
            order by ss.update_time desc
        </if>
        <if test="page != null and limit != null">
            limit ${page*limit} , ${limit}
        </if>

    </select>
```





* 禅道怎么使用
* 数据库
  * 表中有字段叫做“全部专业”
* 