## 架构设计

在应用架构设计过程中，主要考虑如下内容：

* 子系统划分：依据架构分解原则，对概念架构阶段设计的系统进行分解。
* 接口定义：明确各子系统、各模块之间的接口定义；
* 交互机制：明确各子系统、各模块之间的交互机制，如基于接口编程、消息机制或RPC调用等；

在进行应用架构设计时，根据系统的复杂性进行合理的拆分、组合，然后针对不同的部分，分别进行描述。如下图所示：

![](D:\Work\TyporaNotes\note\JavaEE\capol\pict\2-1.png)

各层相互关联，相互依存。

* 前端层

提供多终端的接入，包括PC端、IOS端、Andriod端、及第三方接入等。

* 网关层

提供统一的认证、鉴权、安全、流量管控、缓存、服务路由，协议转换、服务编排、熔断、灰度发布、监控报警等功能。

* 服务层

提供统一的各种业务流程服务。

* 存储层

数据持久化层，提供不同数据格式或形式存储及访问。

* 容器层

提供各种服务及软件运行的基础容器环境。

### 服务层设计原则

![](D:\Work\TyporaNotes\note\JavaEE\capol\pict\2-3.png)

## 技术架构

平台的Java技术栈的技术选型如下：

* 服务框架

选择Springcloud作为分布式服务框架，Springcloud提供一站式微服务解决方案；

* 运行时支撑服务
  * 服务注册中心：采用consul作为服务注册中心；
  * 服务网关：采用Springcloud Gateway网关，实现通讯协议解析，安全认证，流量控制，数据转换，协议转换等功能；
  * 配置中心：采用springcloud的组件config配置中心；
  * 负载均衡：基于nginx、haproxy的软负载等；

* 服务部署平台

基于Gitlab、Jenkins、Rancher的自动化部署平台。

* 服务运行平台

基于docker容器集群部署；

* 服务安全

基于角色的认证授权机制；如有必要，后期引入数字证书，对通讯数据进行签名、验签，保证用户的身份认证、通讯信息的完整性；通过数字签名和数字时间戳，保证业务操作的不可抵赖性；

* 服务容错

基于Springcloud实现服务的开关、限流、降级、超时等；

* 服务监控

基于Logback分级记录系统运行日志、业务操作日志，并定期同步到日志归档平台；

通过自定义Spring注解实现服务调用链日志记录；集成到公司的监控平台上。

* 后台服务

如有必要，后期引入mycat，实现分布式数据访问层，支持分库分表；基于ElasticJob自主实现自动任务调度；自主实现本地内存缓存，采用Redis实现分布式数据缓存；

此次主要采用的开发工具如下：

IntelliJ IDEA；

SDK:JDK1.8；

单元测试：Junit4；

性能测试：JMeter或LoadRunner；

此次主要采用的过程管理工具如下：

项目构建：Maven；

版本控制：SVN；

构件仓库：Nexus；

缺陷跟踪：禅道；

代码审查：FishEye、Crucible；

知识管理：Confluence；            

持续集成、持续交付：Jenkins、Rancher等；

各服务器的配置要求如下表格：

| **设备名称**    | **配置概要** | **安装软件(网络服务)**               | **设备数量** |
| --------------- | ------------ | ------------------------------------ | ------------ |
| 负载均衡服务器  | 每台2C8G     | Linux centos 7.4 、Nginx、Keepalived | 2            |
| 网关服务器      | 每台4C8G     | Linux centos 7.4 、JDK8              | 4            |
| admin管理服务器 | 每台4C8G     | Linux centos 7.4 、JDK8              | 1            |
| Auth授权服务器  | 每台4C8G     | Linux centos 7.4 、JDK8              | 1            |
| 缓存服务器      | 每台4C16G    | Linux centos 7.4 、Redis 4.0         | 3            |
| mysql服务器     | 每台4C8G     | Linux centos 7.4、Mysql5.7           | 3            |

## 目录结构

### 一级目录：

capol-gateway    基础架构网关

capol-center      资源监控中心

capol-config              分布式配置中心

capol-common    公共基础jar包 

capol-admin              管理服务

capol-auth                 授权中心

### 二级目录(以管理服务admin为例)：

公用模块common：capol-admin-common

client模块：capol-admin-client

server模块：capol-admin-server

### 公共模块目录：

公共的实体：entity

公共的controller：BaseController

公共的service：BaseService

公共的DAO：BaseMongoDao、Mapper

公共的返回对象：BaseResponse、ListResponse、ObjectResponse

公共的异常：BaseException

公共的帮助类：helpers

公共的工具类：utils

#### 日志配置文件：

统一存放在src/main/resources文件夹下，名称为logback-spring.xml。此为全局性的日志配置文件，在模块中不再单独需要日志配置文件。 logback日志文件，建议预留一个磁盘空间比较大（至少50G）的磁盘专门用于存放日志文件。

### 模块配置文件：

统一存放在src/main/resources/文件夹下。

配置文件包括，但不限于下述文件：

Mapper包下存放，实体与数据表的映射文件。

bootstrap.yml：系统相关的配置。多环境下，则增加后缀：“-环境编码”。如bootstrap-[dev/test/prod].yml。

application.yml：业务相关的配置，多环境下，则增加后缀：“-环境编码”。如：application -[dev/test/prod].yml

logback-spring.xml：日志配置文件。多环境下，则增加后缀：“-环境编码”。如：logback-spring -[dev/test/prod].yml

banner.txt：公司的logo

### 初始化数据

统一存放在src/main/resources/initdata文件夹下。

## 系统性能

**前端性能优化**

HTML、JS、CSS压缩输出：服务器向浏览器客户端输出的网页数据流一般有较多的无用字符，通过最新的代码压缩技术，可以使网页数据包减小，从而缩短页面载入时间。 

采用Ajax引擎：根据用户的信息获取意向，按需加载区块内容。 提升网页加载速度，降低流量和负载压力。 

支持Keep-Alive功能：Keep-Alive功能使客户端到服务器端的连接持续有效，当出现对服务器的后继请求时，Keep-Alive功能避免了重新建立连接。对于部分提供静态内容很有用。 

**web服务器、图片、数据库分离** 

对于Web类型的电子商务网站来说，服务器最大的压力在于并发请求数量，因此通过集群化部署来降低单台服务器的并发请求可以大幅提高网站性能和响应效率。系统在架构上设立了独立的存储层，可以为图片的存储提供多种选择，包括配置独立的图片存储服务器，CDN存储机制等，并且系统也提供开发接口，可单独针对特定的文件存储方案进行存储接口的开发，方便高效。 系统可以进行简单的配置，将数据库服务器进行单独部署。

**多级缓存机制** 

nginx本地缓存+redis分布式缓存+tomcat堆缓存的多级缓存

nginx本地缓存，抗的是热数据的高并发访问。我们以电商为例，一般来讲，商品的购买总是有热点的，比如访问某些知名品牌的次数会比小众品牌次数多。这些热数据，由于经常被访问，我们可以利用nginx本地缓存。由于nginx本地内存有限，我们只cache住部分热数据，其余不怎么热的数据，流量可以走redis。

redis大规模分布式缓存集群，抗的是很高的离散访问,支撑海量的数据，高并发的访问，提供高可用的服务。

Tomcat的jvm堆内存缓存，主要是抗redis大规模灾难（比如雪崩），如果redis出现了大规模的宕机，导致nginx大量流量直接涌入数据生产服务，那么最后的tomcat堆内存缓存至少可以再抗一下，不至于让数据库直接裸奔。同时tomcat jvm堆内存缓存，也可以抗住redis没有cache住的最后那少量的部分缓存。

**数据库读写分离**

大部分的HTTP请求都属于读数据操作，把读写操作混合在同一个数据库服务器，当访问量瞬间放大时，对系统会造成很大的压力，甚至导致数据库锁死，因此数据库的优化至关重要。 

系统不仅支持数据库与Web服务器分离，同时支持数据库读写分离，可根据企业在电子商务不同的阶段戒者企业的经营模式不同采用针对性的优化设计。 

读写分离是把对数据库读和写的操作分开对应不同的数据库服务器，这样能有效地减轻数据库压力，也能减轻IO压力。主数据库提供写操作，从数据库提供读操作，其实在很多系统中，主要是读的操作。当主数据库进行写操作时，数据要同步到从的数据库，这样才能有效保证数据库完整性。 

**支持多KV引擎** 

满足简单的数据结构存储，数据读取效率较高，较数据库的读性能高出很多，这个性能会依据不同的KV引擎而不同。 系统有统一的数据存储出入口封装，能部署不同的KV引擎。在应对较大访问量时，可以灵活实现各种存储部署方案（包括分布式KV存储）。比如，在集群部署环境下能使用redis,mongodb等高效的存储引擎。

## 系统安全

### HTTPS SSL认证

HTTPS简介HTTPS（全称：Hypertext Transfer Protocol over Secure Socket Layer），是以安全为目标的HTTP通道，简单讲是HTTP的安全版。即HTTP下加入SSL层，HTTPS的安全基础是SSL，因此加密的详细内容就需要SSL。HTTPS对于会员登录以及传递相关隐私数据时可采用HTTPS的方式进行数据加密传输，对于tcp 嗅探和劫持有很好的防御作用。

### 用户密码加密策略 

系统的用户密码统一采用md5 +Salt的方式，比传统的MD5方式来的安全，不容易被暴力破解。

### 敏感数据加密设置

用户的一些敏感信息,比如用户的登陆密码等,在数据库中不可以用明文存储,需要进行加密存储。所以会针对敏感数据进行加密，即使数据库泄漏也不会暴露客户的重要信息。信息的加密和解密与密匙密不可分,那么密匙的安全管理也极为重要。信息的安全是靠密匙保证的。

### 权限控制

将用户分权限,不同权限的用户具有不同的功能,不可以进行跨权限进行非正常操作。将不可被直接访问的页面隐藏，使其只能通过页面内部跳转进行访问。权限管理分为：菜单级、操作级、数据级。一般的系统支持做到操作级即可，但对个别安全级别较高的系统，可以到数据级，能对用户的资源访问进行安全控制。

### 访问日志记录

每当用户进入某模块进行业务操作的同时，系统自动将用户的登陆名，计算机名称，计算机IP地址，进入模块的时间，执行的操作（查询，新增，删除，修改），退出的时间保存起来，供超级管理员查询，通过用户审计，可以找到用户在非指定计算机或者地点使用系统模块功能，从而防止出现数据和信息的泄漏。

### 访问黑名单

系统提供BLACKLIST黑名单机制，用户只需将非法的用户的IP记录到配置文件中，那么该非法用户将无法访问应用端的任何资源。

### 数据安全过滤

​     提交数据做安全过滤系统在前后台的所有数据提交到服务器端都会进行统一的数据过滤。防止用户SQL注入，恶意攻击等行为。

### API授权

​     每个程序都会生成一个唯一的证书号与对应私钥，所有的数据接口传递和发送都需通过其证书号和对应私钥进行相关算法生成签名验证，防止非信任用户获取，篡改数据。

### 设置web应用防火墙

使用一款能够统一拦截请求,过滤恶意参数,自动消毒(转换恶意字符),自动添加token,并且能根据最新攻击和漏洞自动升级,处理掉大部分的网络攻击的产品。

### 网站安全漏洞测试

当我们将项目的安全性设置完毕后,要进行安全测试。网站安全漏洞扫描：使用扫描工具,对网站模拟各种黑客攻击手段,检测网站安全性。



平台设计采用顶层设计方法，自顶向下进行结构化设计，自底向上实现各种业务。提供统一风格、单点登录的统一授权系统。对现有的各业务系统数据进行整合，建立统一的企业共享数据库，加强各业务系统的综合管理。基于大数据智能分析的现代企业智慧化管理，使公司管理活动的各个环节通过信息服务进行流通，实现**业务流**、**信息流**、**资金流**的整合。优化企业资源的配置，提高企业管理效率，提高企业经济效益和核心竞争力，促进企业信息化发展。