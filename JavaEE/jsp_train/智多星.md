# 目录

[TOC]

# 智多星报告

编辑格式：markdown

姓名：傅子镐

班级：信管1161

学号：201611671104

时间：2019年5月21日

# **安装配置说明**

## 实验环境

数据库：mysql5.7

开发工具：IntelliJ IDEA 2018.2 x64、Navicat

Web容器：apache-tomcat-9.0.10

## 数据库准备

打开Navicat，按如下操作新建数据库jsp_zdx

![1558439065154](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1558439065154.png)

建立完数据库，按如下操作，运行jsp_zdx.sql文件：

![1558439163593](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1558439163593.png)

选择SQL文件的位置，并运行SQL文件。（sql文件见附录）

# **代码实现部分**

创建项目，项目名为jsp_zdk_code

导入jar包，分别为：

![1558438594043](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1558438594043.png)

* commons-fileupload、commons-io：图片上传
* jstl、standard：jstl表达式的使用
* mysql-connector-java：jdbc的连接

整体目录结构如下所示：

![1558438365260](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1558438365260.png)

![1558438411790](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1558438411790.png)

![1558438454139](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1558438454139.png)

![1558438510759](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1558438510759.png)

 

## 前台部分

### 主页

#### 代码：

web根目录下创建

##### index.jsp

 ```jsp
<%@ page contentType="text/html;charset=utf-8" %>
<HTML> <BODY>
<HEAD><%@ include file="head.jsp" %></HEAD>
<title>首页</title>
<CENTER> <h1><font Size=4 color=blue>
         欢迎光临“智多星”智能手机销售网
         </font></h1>
<img src="image/welcome.jpg" width=500 height=400 ></img>
</CENTER>
</BODY></HTML>
 ```

#####  head.jsp

```jsp
<%@ page contentType="text/html;charset=utf-8" %>
<div align="center">
  <H2>“智多星”智能手机销售网</H2>
  <table  cellSpacing="1" cellPadding="1" width="660" align="center"    border="0" >
   <tr valign="bottom">
   <td><A href="inputRegisterMess.jsp"><font size=2>注册</font></A></td>
   <td><A href="login.jsp"><font size=2>登录</font></A></td>
   <td><A href="lookMobile.jsp"><font size=2>浏览手机</font></A></td>
   <td><A href="searchMobile.jsp"><font size=2>查询手机</font></A></td>
   <td><A href="lookShoppingCar.jsp"><font size=2>查看购物车</font></A></td>
   <td><A href="lookOrderForm.jsp"><font size=2>查看订单</font></A></td>
   <td><A href="exitServlet"><font size=2>退出</font></A></td>
       <td><A href="index.jsp"><font size=2>主页</font></A></td>
       <td><A href="admin/login.jsp"><font size=2>后台管理</font></A></td>
  </tr>
  </Font>
</table>
</div>

```

#### 实现效果

![img](file:///C:\Users\ADMINI~1\AppData\Local\Temp\ksohtml7436\wps2.jpg)

### 注册功能

#### 代码：

web根目录下创建

##### inputRegisterMess.jsp

```jsp
<%@ page contentType="text/html;charset=utf-8" %>
<jsp:useBean id="userBean" class="mybean.data.Register" scope="request"/>
<HEAD><%@ include file="head.jsp" %></HEAD>
<title>注册页面</title>
<HTML><BODY bgcolor=pink><Font size=2>
<div align="center">
<FORM action="registerServlet" method="post" name=form>
<table>
    用户名由字母、数字、下划线构成，*注释的项必须填写。
   <tr><td>*用户名称:</td><td><Input type=text name="logname" ></td>
       <td>*用户密码:</td><td><Input type=password name="password">
       </td></tr>
   <tr><td>*重复密码:</td><td>
       <Input type=password name="again_password"></td>
       <td>联系电话:</td><td><Input type=text name="phone"></td></tr>
   <tr><td>邮寄地址:</td><td><Input type=text name="address"></td>
       <td>真实姓名:</td><td><Input type=text name="realname"></td>
       <td><Input type=submit name="g" value="提交"></td> </tr>
</table>
</Form>
</div >
<div align="center">
<p> 注册反馈：
<jsp:getProperty name="userBean"  property="backNews" /> 
<table border=3>
     <tr><td>会员名称:</td>
     <td><jsp:getProperty name="userBean" property="logname"/></td>
     </tr>
     <tr><td>姓名:</td>
     <td><jsp:getProperty name="userBean" property="realname"/></td>
     </tr>
     <tr><td>地址:</td>
     <td><jsp:getProperty name="userBean" property="address"/></td>
     </tr>
     <tr><td>电话:</td>
     <td><jsp:getProperty name="userBean" property="phone"/></td>
     </tr>
</table></div >
</Body></HTML>
```

##### web.xml

WEB-INF下的web.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<web-app xmlns="http://xmlns.jcp.org/xml/ns/javaee"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd"
         version="4.0">
    <servlet>
        <servlet-name>registerServlet</servlet-name>
        <servlet-class>myservlet.control.HandleRegister</servlet-class>
    </servlet>
    <servlet-mapping>
        <servlet-name>registerServlet</servlet-name>
        <url-pattern>/registerServlet</url-pattern>
    </servlet-mapping>
    <servlet>
        <servlet-name>loginServlet</servlet-name>
        <servlet-class>myservlet.control.HandleLogin</servlet-class>
    </servlet>
    <servlet-mapping>
        <servlet-name>loginServlet</servlet-name>
        <url-pattern>/loginServlet</url-pattern>
    </servlet-mapping>
    <servlet>
        <servlet-name>deleteServlet</servlet-name>
        <servlet-class>myservlet.control.HandleDelete</servlet-class>
    </servlet>
    <servlet-mapping>
        <servlet-name>deleteServlet</servlet-name>
        <url-pattern>/deleteServlet</url-pattern>
    </servlet-mapping>
    <servlet>
        <servlet-name>buyServlet</servlet-name>
        <servlet-class>myservlet.control.HandleBuyGoods</servlet-class>
    </servlet>
    <servlet-mapping>
        <servlet-name>buyServlet</servlet-name>
        <url-pattern>/buyServlet</url-pattern>
    </servlet-mapping>
    <servlet>
        <servlet-name>queryServlet</servlet-name>
        <servlet-class>myservlet.control.QueryAllRecord</servlet-class>
    </servlet>
    <servlet-mapping>
        <servlet-name>queryServlet</servlet-name>
        <url-pattern>/queryServlet</url-pattern>
    </servlet-mapping>
    <servlet>
        <servlet-name>putGoodsServlet</servlet-name>
        <servlet-class>myservlet.control.PutGoodsToCar</servlet-class>
    </servlet>
    <servlet-mapping>
        <servlet-name>putGoodsServlet</servlet-name>
        <url-pattern>/putGoodsServlet</url-pattern>
    </servlet-mapping>
    <servlet>
        <servlet-name>searchByConditionServlet</servlet-name>
        <servlet-class>myservlet.control.SearchByCondition</servlet-class>
    </servlet>
    <servlet-mapping>
        <servlet-name>searchByConditionServlet</servlet-name>
        <url-pattern>/searchByConditionServlet</url-pattern>
    </servlet-mapping>
    <servlet>
        <servlet-name>exitServlet</servlet-name>
        <servlet-class>myservlet.control.HandleExit</servlet-class>
    </servlet>
    <servlet-mapping>
        <servlet-name>exitServlet</servlet-name>
        <url-pattern>/exitServlet</url-pattern>
    </servlet-mapping>
</web-app>

```

##### Register.java

mybean.data下创建

```java
package mybean.data;
public class Register{  
   String  logname="" , phone="",
           address="",realname="",backNews="哇";
   public void setLogname(String logname){  
      this.logname=logname;
   }
   public String getLogname(){  
      return logname;
   }
   public void setPhone(String phone){  
      this.phone=phone;
   }
   public String getPhone(){  
      return phone;
   }
   public void setAddress(String address){  
      this.address=address;
   }
   public String getAddress(){  
      return address;
   }
   public void setRealname(String realname){  
      this.realname=realname;
   }
   public String getRealname(){  
      return realname;
   }
   public void setBackNews(String backNews){  
      this.backNews=backNews;
   }
   public String getBackNews(){  
      return backNews;
   }
}
```

##### HandlerRegister.java

myservlet.control下创建

```java
package myservlet.control;
import mybean.data.*;
import java.sql.*;
import java.io.*;
import javax.servlet.*;
import javax.servlet.http.*;
public class HandleRegister extends HttpServlet {
   public void init(ServletConfig config) throws ServletException {
      super.init(config);
      try {  Class.forName("com.mysql.jdbc.Driver");
      }
      catch(Exception e){}
   }
   public String handleString(String s)
   {   try{ byte bb[]=s.getBytes("iso-8859-1");
            s=new String(bb);
       }
       catch(Exception ee){}
       return s;
   }
   public  void  doPost(HttpServletRequest request,HttpServletResponse response)
                        throws ServletException,IOException {
      String uri="jdbc:mysql://127.0.0.1/jsp_zdx?"+
                             "user=root&password=460204715&characterEncoding=utf-8";
      Connection con;
      PreparedStatement sql;
      Register userBean=new Register();  //创建的Javabean模型
      request.setAttribute("userBean",userBean);
      String logname=request.getParameter("logname").trim();
      String password=request.getParameter("password").trim();
      String again_password=request.getParameter("again_password").trim();
      String phone=request.getParameter("phone").trim();
      String address=request.getParameter("address").trim();
      String realname=request.getParameter("realname").trim();
      if(logname==null)
           logname="";
      if(password==null)
           password="";
      if(!password.equals(again_password)) {
         userBean.setBackNews("两次密码不同，注册失败，");
         RequestDispatcher dispatcher=
         request.getRequestDispatcher("inputRegisterMess.jsp");
         dispatcher.forward(request, response);//转发
         return;
      }
      boolean isLD=true;
      for(int i=0;i<logname.length();i++){
          char c=logname.charAt(i);
           if(!((c<='z'&&c>='a')||(c<='Z'&&c>='A')||(c<='9'&&c>='0')))
             isLD=false;
      }
      boolean boo=logname.length()>0&&password.length()>0&&isLD;
      String backNews="";
      try{   con=DriverManager.getConnection(uri);
             String insertCondition="INSERT INTO user(logname,password,phone,address,realname) VALUES (?,?,?,?,?)";
             sql=con.prepareStatement(insertCondition);
             if(boo)
             { sql.setString(1,handleString(logname));
               sql.setString(2,handleString(password));
               sql.setString(3,handleString(phone));
               sql.setString(4,handleString(address));
               sql.setString(5,handleString(realname));
               int m=sql.executeUpdate();
               if(m!=0){
                  backNews="注册成功";
                  userBean.setBackNews(backNews);
                  userBean.setLogname(logname);
                  userBean.setPhone(handleString(phone));
                  userBean.setAddress(handleString(address));
                  userBean.setRealname(handleString(realname));
               }
             }
             else {
                 backNews="信息填写不完整或名字中有非法字符";
                 userBean.setBackNews(backNews);
             }
             con.close();
      }
      catch(SQLException exp){
             backNews="该会员名已被使用，请您更换名字"+exp;
             userBean.setBackNews(backNews);
      }
      RequestDispatcher dispatcher=
      request.getRequestDispatcher("inputRegisterMess.jsp");
      dispatcher.forward(request, response);//转发
   }
   public  void  doGet(HttpServletRequest request,HttpServletResponse response)
                        throws ServletException,IOException {
      doPost(request,response);
   }
}
```

#### 实现效果

![1558438111080](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1558438111080.png)

### 登录功能

#### 代码：

##### login.jsp

```jsp
<%@ page contentType="text/html;charset=utf-8" %>
<jsp:useBean id="loginBean" class="mybean.data.Login" scope="session"/>
<HTML><HEAD><%@ include file="head.jsp" %></HEAD>
<BODY bgcolor=pink><font size=2>
<div align="center">
<table border=2>
<tr> <th>登录</th></tr>
<FORM action="loginServlet" Method="post">
<tr><td>登录名称:<Input type=text name="logname"></td></tr>
<tr><td>输入密码:<Input type=password name="password"></td></tr>
</table>
<Input type=submit name="g" value="提交">
</form>
</div >
<div align="center" >
登录反馈信息:<br>
<jsp:getProperty name="loginBean" property="backNews"/>
<br>登录名称:<br><jsp:getProperty name="loginBean" property="logname"/>
<div >
</font>
</BODY></HTML>
```

##### Login.java

```java
package mybean.data;

import java.util.LinkedList;

public class Login {
    String logname="",
            backNews="未登录";
    LinkedList<String> car; //用户的购物车
    public Login() {
        car = new LinkedList<String>();
    }
    public void setLogname(String logname){
        this.logname = logname;
    }
    public String getLogname(){
        return logname;
    }
    public void setBackNews(String s) {
        backNews = s;
    }
    public String getBackNews(){
        return backNews;
    }
    public LinkedList<String> getCar() {
        return car;
    }
}
```

##### HandlerLogin.java

```java
package myservlet.control;
import mybean.data.*;
import java.sql.*;
import java.io.*;
import javax.servlet.*;
import javax.servlet.http.*;
import java.util.*;
public class HandleLogin extends HttpServlet{
    public void init(ServletConfig config) throws ServletException{
        super.init(config);
        try{
            Class.forName("com.mysql.jdbc.Driver");
        }
        catch(Exception e){}
    }
    public String handleString(String s){
        try{  byte bb[]=s.getBytes("iso-8859-1");
            s=new String(bb);
        }
        catch(Exception ee){}
        return s;
    }
    public void doPost(HttpServletRequest request,HttpServletResponse response)
            throws ServletException,IOException{
        Connection con;
        Statement sql;
        String logname=request.getParameter("logname").trim(),
                password=request.getParameter("password").trim();
        logname=handleString(logname);
        password=handleString(password);
        String uri="jdbc:mysql://127.0.0.1/jsp_zdx?"+
                "user=root&password=460204715&characterEncoding=utf-8";
        boolean boo=(logname.length()>0)&&(password.length()>0);
        try{
            con=DriverManager.getConnection(uri);
            String condition="select * from user where logname = '"+logname+
                    "' and password ='"+password+"'";
            sql=con.createStatement();
            if(boo){
                ResultSet rs=sql.executeQuery(condition);
                boolean m=rs.next();
                if(m==true){
                    //调用登录成功的方法:
                    success(request,response,logname,password);
                    RequestDispatcher dispatcher=
                            request.getRequestDispatcher("login.jsp");//转发
                    dispatcher.forward(request,response);
                }
                else{
                    String backNews="您输入的用户名不存在，或密码不般配";
                    //调用登录失败的方法:
                    fail(request,response,logname,backNews);
                }
            }
            else{
                String backNews="请输入用户名和密码";
                fail(request,response,logname,backNews);
            }
            con.close();
        }
        catch(SQLException exp){
            String backNews=""+exp;
            fail(request,response,logname,backNews);
        }
    }
    public  void  doGet(HttpServletRequest request,HttpServletResponse response)
            throws ServletException,IOException{
        doPost(request,response);
    }
    public void success(HttpServletRequest request,HttpServletResponse response
            ,String logname,String password) {
        Login loginBean=null;
        HttpSession session=request.getSession(true);
        try{  loginBean=(Login)session.getAttribute("loginBean");
            if(loginBean==null){
                loginBean=new Login();  //创建新的数据模型
                session.setAttribute("loginBean",loginBean);
                loginBean=(Login)session.getAttribute("loginBean");
            }
            String name =loginBean.getLogname();
            if(name.equals(logname)) {
                loginBean.setBackNews(logname+"已经登录了");
                loginBean.setLogname(logname);
            }
            else {  //数据模型存储新的登录用户
                loginBean.setBackNews(logname+"登录成功");
                loginBean.setLogname(logname);
            }
        }
        catch(Exception ee){
            loginBean=new Login();
            session.setAttribute("loginBean",loginBean);
            loginBean.setBackNews(logname+"登录成功");
            loginBean.setLogname(logname);
        }
    }
    public void fail(HttpServletRequest request,HttpServletResponse response
            ,String logname,String backNews) {
        response.setContentType("text/html;charset=GB2312");
        try {
            PrintWriter out=response.getWriter();
            out.println("<html><body>");
            out.println("<h2>"+logname+"登录反馈结果<br>"+backNews+"</h2>") ;
            out.println("返回登录页面或主页<br>");
            out.println("<a href =login.jsp>登录页面</a>");
            out.println("<br><a href =index.jsp>主页</a>");
            out.println("</body></html>");
        }
        catch(IOException exp){}
    }
}
```

#### 实现效果

![1558439658186](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1558439658186.png)

### 浏览手机

#### 代码：

##### lookMobile.jsp

```jsp
<%@ page contentType="text/html;charset=utf-8" %>
<%@ page import="java.sql.*" %>
<HTML><HEAD><%@ include file="head.jsp" %></HEAD>
<BODY bgcolor=cyan><font size=2>
<div align="center">
<h2>选择某类手机<br>分页显示这类手机</h2>
<%   try {  Class.forName("com.mysql.jdbc.Driver");
      }
      catch(Exception e){} 
      String uri="jdbc:mysql://127.0.0.1/jsp_zdx?"+
                             "user=root&password=460204715&characterEncoding=utf-8";
      Connection con; 
      Statement sql;
      ResultSet rs;
      try {
        con=DriverManager.getConnection(uri);
        sql=con.createStatement();
        //读取mobileClassify表，获得分类：  
        rs=sql.executeQuery("SELECT * FROM mobileClassify  ");
        out.print("<form action='queryServlet' method ='post'>") ;
        out.print("<select name='fenleiNumber'>") ;
        while(rs.next()){
           int id = rs.getInt(1);
           String mobileCategory = rs.getString(2);
           out.print("<option value ="+id+">"+mobileCategory+"</option>");
        }  
        out.print("</select>");
        out.print("<input type ='submit' value ='提交'>");  
        out.print("</form>");
        con.close();
     }
     catch(SQLException e){ 
        out.print(e);
     }
%>
</div></font>
</BODY></HTML>
```

##### DataByPaeg.java

```java
package mybean.data;

import com.sun.rowset.CachedRowSetImpl;

public class DataByPage{
    CachedRowSetImpl rowSet=null;         //存储表中全部记录的行集对象
    int pageSize=1;                      //每页显示的记录数
    int totalPages=1;                     //分页后的总页数
    int currentPage =1   ;                 //当前显示页
    public void setRowSet(CachedRowSetImpl set){
        rowSet=set;
    }
    public CachedRowSetImpl getRowSet(){
        return rowSet;
    }
    public void setPageSize(int size){
        pageSize=size;
    }
    public int getPageSize(){
        return pageSize;
    }
    public int getTotalPages(){
        return totalPages;
    }
    public void setTotalPages(int n){
        totalPages=n;
    }
    public void setCurrentPage(int n){
        currentPage =n;
    }
    public int getCurrentPage(){
        return currentPage ;
    }
}
```

#### 实现效果

![1558439867461](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1558439867461.png)

### 查询手机

#### 代码：

##### searchMobile.jsp

```jsp
<%@ page contentType="text/html;charset=utf-8" %>
<HTML><HEAD><%@ include file="head.jsp" %></HEAD>
<BODY bgcolor=#55BBDD><font size=2>
<div align="center">
<br>查询时可以输入手机的版本号或手机名称及价格。<br>
手机名称支持模糊查询。
<br>输入价格是在2个值之间的价格，格式是：价格1-价格2<br>
例如 3987-8976 
<FORM action="searchByConditionServlet" Method="post" >
   <br>输入查询信息:<Input type=text name="searchMess"><br>
   <Input type =radio name="radio" value="mobile_version">手机版本号
   <Input type =radio name="radio" value="mobile_name" checked="ok">手机名称
   <Input type =radio name="radio" value="mobile_price">手机价格
   <br><Input type=submit name="g" value="提交">
</Form>
</div>
</Font></BODY></HTML>
```

##### SearchByCondition.java

```java
package myservlet.control;

import com.sun.rowset.CachedRowSetImpl;
import mybean.data.DataByPage;

import javax.servlet.ServletConfig;
import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;
import java.io.IOException;
import java.io.PrintWriter;
import java.sql.*;
public class SearchByCondition extends HttpServlet{
    CachedRowSetImpl rowSet=null;
    public void init(ServletConfig config) throws ServletException{
        super.init(config);
        try {  Class.forName("com.mysql.jdbc.Driver");
        }
        catch(Exception e){}
    }
    public void doPost(HttpServletRequest request,HttpServletResponse response)
            throws ServletException,IOException{
        request.setCharacterEncoding("utf-8");
        String searchMess= request.getParameter("searchMess");
        String radioMess= request.getParameter("radio");
        if(searchMess==null||searchMess.length()==0) {
            fail(request,response,"没有查询信息，无法查询");
            return;
        }
        String condition="";
        if(radioMess.equals("mobile_version")) {
            condition =
                    "SELECT * FROM mobileForm where mobile_version ='"+searchMess+"'";
        }
        else if(radioMess.equals("mobile_name")) {
            condition =
                    "SELECT * FROM mobileForm where mobile_name LIKE '%"+searchMess+"%'";
        }
        else if(radioMess.equals("mobile_price")) {
            double max=0,min=0;
            String regex = "[^0123456789.]";
            String [] priceMess =searchMess.split(regex);
            if(priceMess.length==1) {
                max =min = Double.parseDouble(priceMess[0]);
            }
            else if(priceMess.length==2) {
                min = Double.parseDouble(priceMess[0]);
                max = Double.parseDouble(priceMess[1]);
                if(max<min) {
                    double t = max;
                    max = min;
                    min = t;
                }
            }
            else {
                fail(request,response,"输入的价格格式有错误");
                return;
            }
            condition =  "SELECT * FROM mobileForm where "+
                    "mobile_price <= "+max+" AND mobile_price>="+min ;
        }
        HttpSession session=request.getSession(true);
        Connection con=null;
        DataByPage dataBean=null;
        try{
            dataBean=(DataByPage)session.getAttribute("dataBean");
            if(dataBean==null){
                dataBean=new DataByPage();  //创建Javabean对象
                session.setAttribute("dataBean",dataBean);
            }
        }
        catch(Exception exp){
            dataBean=new DataByPage();
            session.setAttribute("dataBean",dataBean);
        }
        String uri = "jdbc:mysql://127.0.0.1/jsp_zdx?"+
                "user=root&password=460204715&characterEncoding=utf-8";
        try{
            con=DriverManager.getConnection(uri);
            Statement sql=con.createStatement(ResultSet.TYPE_SCROLL_SENSITIVE,
                    ResultSet.CONCUR_READ_ONLY);
            ResultSet rs=sql.executeQuery(condition);
            rowSet=new CachedRowSetImpl();   //创建行集对象
            rowSet.populate(rs);
            dataBean.setRowSet(rowSet);      //行集数据存储在dataBean中
            con.close();                     //关闭连接
        }
        catch(SQLException exp){}
        response.sendRedirect("byPageShow.jsp");//重定向到byPageShow.jsp
    }
    public void doGet(HttpServletRequest request,
                      HttpServletResponse response)
            throws ServletException,IOException{
        doPost(request,response);
    }
    public void fail(HttpServletRequest request,HttpServletResponse response,
                     String backNews) {
        response.setContentType("text/html;charset=utf-8");
        try {
            PrintWriter out=response.getWriter();
            out.println("<html><body>");
            out.println("<h2>"+backNews+"</h2>") ;
            out.println("返回：");
            out.println("<a href =searchMobile.jsp>查询手机</a>");
            out.println("</body></html>");
        }
        catch(IOException exp){}
    }
}
```

#### 实现效果

![1558439916301](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1558439916301.png)

### 查看购物车、生成订单、删除购物车

#### 代码：

##### lookShoppingCar.jsp

```jsp
<%@ page contentType="text/html;charset=utf-8" %>
<%@ page import="mybean.data.Login" %>
<%@ page import="java.util.*" %>
<jsp:useBean id="loginBean" class="mybean.data.Login" scope="session"/>
<HTML><HEAD><%@ include file="head.jsp" %></HEAD>
<BODY bgcolor=yellow><font size=2>
<div align="center">
<%  if(loginBean==null){
        response.sendRedirect("login.jsp");//重定向到登录页面
    }
    else {
       boolean b =loginBean.getLogname()==null||
                  loginBean.getLogname().length()==0;
       if(b)
         response.sendRedirect("login.jsp");//重定向到登录页面
    }
    LinkedList car =loginBean.getCar();
    if(car==null)
      out.print("<h2> 购物车没有物品.</h2>");
    else {
       Iterator<String> iterator=car.iterator();
       StringBuffer buyGoods = new StringBuffer();
       int n=0;
       double priceSum =0;
       out.print("购物车中的物品：<table border=2>");
       while(iterator.hasNext()) {
           String goods=iterator.next();
           String showGoods="";
           n++; 
           //购车车物品的后缀是“#价格数字"，比如“iPhone手机价格3989 #3989”
           int index=goods.lastIndexOf("#");
           if(index!=-1){
              priceSum+=Double.parseDouble(goods.substring(index+1));
              showGoods = goods.substring(0,index);
           }
           buyGoods.append(n+":"+showGoods);
           String del="<form  action='deleteServlet' method = 'post'>"+
                     "<input type ='hidden' name='delete' value= "+goods+">"+
                     "<input type ='submit'  value='删除' ></form>";
          
           out.print("<tr><td>"+showGoods+"</td>");
           out.print("<td>"+del+"</td></tr>");
       }
       out.print("</table>");
       String orderForm = "<form action='buyServlet' method='post'>"+
              " <input type ='hidden' name='buy' value= "+buyGoods+" >"+ 
              " <input type ='hidden' name='price' value= "+priceSum+" >"+           
              "<input type ='submit'  value='生成订单'></form>";
       out.print(orderForm); 
    } 
%>
</div></font>
</BODY></HTML>
```

##### HandleBuyGoods.java

```java
package myservlet.control;

import mybean.data.Login;

import javax.servlet.ServletConfig;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;
import java.io.IOException;
import java.io.PrintWriter;
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.PreparedStatement;
import java.sql.SQLException;
import java.util.LinkedList;

public class HandleBuyGoods extends HttpServlet {
    public void init(ServletConfig config) throws ServletException {
        super.init(config);
        try{
            Class.forName("com.mysql.jdbc.Driver");
        }
        catch(Exception e){}
    }
    public  void  doPost(HttpServletRequest request,HttpServletResponse response)
            throws ServletException,IOException {
        request.setCharacterEncoding("utf-8");
        String buyGoodsMess = request.getParameter("buy");
        if(buyGoodsMess==null||buyGoodsMess.length()==0) {
            fail(request,response,"购物车没有物品，无法生成订单");
            return;
        }
        String price = request.getParameter("price");
        if(price==null||price.length()==0) {
            fail(request,response,"没有计算价格和，无法生成订单");
            return;
        }
        float sum = Float.parseFloat(price);
        Login loginBean=null;
        HttpSession session=request.getSession(true);
        try{  loginBean=(Login)session.getAttribute("loginBean");
            boolean b =loginBean.getLogname()==null||
                    loginBean.getLogname().length()==0;
            if(b)
                response.sendRedirect("login.jsp");//重定向到登录页面
        }
        catch(Exception exp){
            response.sendRedirect("login.jsp");//重定向到登录页面
        }
        String uri="jdbc:mysql://127.0.0.1/jsp_zdx?"+
                "user=root&password=460204715&characterEncoding=utf-8";
        Connection con;
        PreparedStatement sql;
        try{ con=DriverManager.getConnection(uri);
            String insertCondition="INSERT INTO orderform VALUES (?,?,?,?,?)";
            sql=con.prepareStatement(insertCondition);
            sql.setInt(1,0); //订单序号会自定增加
            sql.setString(2,loginBean.getLogname());
            sql.setString(3,buyGoodsMess);
            sql.setFloat(4,sum);
            sql.setInt(5,1);
            sql.executeUpdate();
            LinkedList car=loginBean.getCar();
            car.clear();  //清空购物车
            success(request,response,"生成订单成功");
        }
        catch(SQLException exp){
            fail(request,response,"生成订单失败"+exp);
        }
    }
    public  void  doGet(HttpServletRequest request,HttpServletResponse response)
            throws ServletException,IOException {
        doPost(request,response);
    }
    public void success(HttpServletRequest request,HttpServletResponse response,
                        String backNews) {
        response.setContentType("text/html;charset=utf-8");
        try {
            PrintWriter out=response.getWriter();
            out.println("<html><body>");
            out.println("<h2>"+backNews+"</h2>") ;
            out.println("返回主页<br>");
            out.println("<br><a href =index.jsp>主页</a>");
            out.println("查看订单<br>");
            out.println("<br><a href =lookOrderForm.jsp>查看订单</a>");
            out.println("</body></html>");
        }
        catch(IOException exp){}
    }
    public void fail(HttpServletRequest request,HttpServletResponse response,
                     String backNews) {
        response.setContentType("text/html;charset=utf-8");
        try {
            PrintWriter out=response.getWriter();
            out.println("<html><body>");
            out.println("<h2>"+backNews+"</h2>") ;
            out.println("返回主页：");
            out.println("<a href =index.jsp>主页</a>");
            out.println("</body></html>");
        }
        catch(IOException exp){}
    }
}
```

##### HandleDelete.java

```java
package myservlet.control;

import mybean.data.Login;

import javax.servlet.RequestDispatcher;
import javax.servlet.ServletConfig;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;
import java.io.IOException;
import java.util.LinkedList;

public class HandleDelete extends HttpServlet {
    public void init(ServletConfig config) throws ServletException {
        super.init(config);
    }
    public  void  doPost(HttpServletRequest request,HttpServletResponse response)
            throws ServletException,IOException {
        request.setCharacterEncoding("utf-8");
        String delete = request.getParameter("delete");
        Login loginBean=null;
        HttpSession session=request.getSession(true);
        try{  loginBean=(Login)session.getAttribute("loginBean");
            boolean b =loginBean.getLogname()==null||
                    loginBean.getLogname().length()==0;
            if(b)
                response.sendRedirect("login.jsp");//重定向到登录页面
            LinkedList<String> car = loginBean.getCar();
            car.remove(delete);
        }
        catch(Exception exp){
            response.sendRedirect("login.jsp");//重定向到登录页面
        }
        RequestDispatcher dispatcher=
                request.getRequestDispatcher("lookShoppingCar.jsp");
        dispatcher.forward(request, response);//转发
    }
    public  void  doGet(HttpServletRequest request,HttpServletResponse response)
            throws ServletException,IOException {
        doPost(request,response);
    }
}
```

#### 实现效果

![1558440330882](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1558440330882.png)

### 查看订单、更新订单状态（付款、确认收货）

#### 代码：

##### lookOrderForm.jsp

```jsp
<%@ page contentType="text/html;charset=utf-8" %>
<jsp:useBean id="loginBean" class="mybean.data.Login" scope="session"/>
<%@ page import="java.sql.*" %>
<HTML><HEAD><%@ include file="head.jsp" %></HEAD>
<div align="center">
<%  if(loginBean==null){
        response.sendRedirect("login.jsp");//重定向到登录页面
    }
    else {
       boolean b =loginBean.getLogname()==null||
                  loginBean.getLogname().length()==0;
       if(b)
         response.sendRedirect("login.jsp");//重定向到登录页面
    }
    Connection con;
    Statement sql; 
    ResultSet rs;
    try{  Class.forName("com.mysql.jdbc.Driver");
    }
    catch(Exception e){}
    try { String uri= "jdbc:mysql://127.0.0.1/jsp_zdx";
          String user="root";
          String password="460204715";
          con=DriverManager.getConnection(uri,user,password);
          sql=con.createStatement();
          String cdn=
         "SELECT id,mess,sum,status FROM orderform where logname= '"+loginBean.getLogname()+"'";
          rs=sql.executeQuery(cdn);
          out.print("<table border=2>");
          out.print("<tr>");
            out.print("<th width=100>"+"订单号");
            out.print("<th width=100>"+"信息");
            out.print("<th width=100>"+"价格");
            out.print("<th width=100>"+"订单状态");
          out.print("</TR>");
          while(rs.next()){
            out.print("<tr>");
              out.print("<td >"+rs.getString(1)+"</td>"); 
              out.print("<td >"+rs.getString(2)+"</td>");
              out.print("<td >"+rs.getString(3)+"</td>");
              if(rs.getInt(4)==1){
                  out.print("<td ><a href='/UpdateOrderStatusServlet?oid="+rs.getString(1)+"&status=2'>去付款</td>");
              }
              if(rs.getInt(4)==2){
                  out.print("<td >待发货</td>");
              }
              if(rs.getInt(4)==3){
                  out.print("<td ><a href='/UpdateOrderStatusServlet?oid="+rs.getString(1)+"&status=4'>确认收货</a></td>");
              }
              if(rs.getInt(4)==4){
                  out.print("<td >已确认收货</td>");
              }
              out.print("</tr>") ; 
          }
          out.print("</table>");
          con.close();
    }
    catch(SQLException e){ 
          out.print(e);
    }
 %>
</div></HTML>
```

##### UpdateOrderStatusServlet.java

```java
package myservlet.admin;

import dao.OrderDao;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;

@WebServlet("/UpdateOrderStatusServlet")
public class UpdateOrderStatusServlet extends HttpServlet {
    private OrderDao orderDao=new OrderDao();
    @Override
    protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        doGet(request,response);
    }

    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        try {
            Integer oid = Integer.valueOf(request.getParameter("oid"));
            Integer status = Integer.valueOf(request.getParameter("status"));
            orderDao.updateOrderStatusByOid(oid,status);
            if(status==3) {
                request.setAttribute("msg", "发货成功");
                request.getRequestDispatcher("/admin/msg.jsp").forward(request, response);
            }
            if(status==4||status==2){
                request.getRequestDispatcher("/lookOrderForm.jsp").forward(request, response);
            }
        }catch (Exception e){
            e.printStackTrace();
        }
    }
}
```

#### 演示效果

![1558440747451](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1558440747451.png)

### 退出

#### 代码：

##### HanldeExit.java

```java
package myservlet.control;

import javax.servlet.ServletConfig;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;
import java.io.IOException;

public class HandleExit extends HttpServlet {
    public void init(ServletConfig config) throws ServletException{
        super.init(config);
    }
    public  void  doPost(HttpServletRequest request,HttpServletResponse response)
            throws ServletException,IOException {
        HttpSession session=request.getSession(true);
        session.invalidate();              //销毁用户的session对象
        response.sendRedirect("index.jsp"); //返回主页
    }
    public  void  doGet(HttpServletRequest request,HttpServletResponse response)
            throws ServletException,IOException {
        doPost(request,response);
    }
}
```

#### 演示效果

点击“退出”后，回到主页面

![1558441077521](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1558441077521.png)

## 后台部分

### 实现流程

* 由于需要使用到dtree，首先需要进行如下，操作如下：
  * 在web下的admin添加dtree.css 、dtree.js；
  * 双列布局，左边是dtree结构，右边是触发的增删查改操作
  * 给每一个dtree的叶子节点赋予一个超链接，点击超链接时请求servlet或jsp
* 从pojo、dao、到service层依次进行开发，实现业务上的逻辑处理。
* 管理员登录时将信息存在session，并需要给后台系统设置一个全局拦截器，只放行与login相关的请求，其他请求需要拦截判断是否存在session，确保后台系统的安全性。
* 在订单状态上，需要修改数据库的订单表，增加status字段，已实现对订单的管理。

### 分层结构

#### utils自定义工具类

##### BeanHandler.java

```java
package utils;

import javax.servlet.http.HttpServletRequest;
import java.io.IOException;
import java.lang.reflect.Field;
import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Method;
import java.sql.ResultSet;
import java.sql.ResultSetMetaData;
import java.sql.SQLException;

import static utils.ParameterUtils.setFirstUpper;

/**
 * @author Hpsyche
 */
public class BeanHandler {
    //将request参数转为Bean对象
    public static <T> T getParametersToBean(Class<T> clazz, HttpServletRequest request) throws ClassNotFoundException, IllegalAccessException, InvocationTargetException, InstantiationException, IOException {
        T bean = clazz.newInstance();
        Field[] fields = clazz.getDeclaredFields();
        Method[] methods = clazz.getMethods();
        for (Field field : fields) {
            for (Method method : methods) {
                if (("set" + setFirstUpper(field.getName())).equals(method.getName())) {
                    String value = request.getParameter(field.getName());
                    if(value!=null) {
                        if (field.getType() == Long.class) {
                            method.invoke(bean, Long.valueOf(value));
                        } else if (field.getType() == Integer.class) {
                            method.invoke(bean, Integer.valueOf(value));
                        } else if (field.getType() == Float.class) {
                            method.invoke(bean, Float.valueOf(value));
                        } else {
                            method.invoke(bean, value);
                        }
                    }
                    break;

                }
            }
        }
        return bean;
    }

    //将数据库resultSet转为bean对象
    public static <T> T resultSetToBean(Class<T> clazz, ResultSet rs) throws IllegalAccessException, InstantiationException, SQLException, InvocationTargetException {
        T bean = clazz.newInstance();
        Field[] fields = clazz.getDeclaredFields();
        Method[] methods = clazz.getMethods();
        for (Field field : fields) {
            for (Method method : methods) {
                if (("set" + setFirstUpper(field.getName())).equals(method.getName())) {
                    if (field.getType() == String.class) {
                        method.invoke(bean, rs.getString(field.getName()));
                    }
                    if (field.getType() == Long.class) {
                        method.invoke(bean, rs.getLong(field.getName()));
                    }
                    if (field.getType() == Integer.class) {
                        method.invoke(bean, rs.getInt(field.getName()));
                    }
                    if (field.getType() == Float.class) {
                        method.invoke(bean, rs.getFloat(field.getName()));
                    }
                    break;
                }
            }
        }
        return bean;
    }
    
    public static Object getJdbcToBean(ResultSet resultSet, Class clazz) throws InvocationTargetException, IllegalAccessException, SQLException, InstantiationException {
        Object bean = clazz.newInstance();
        Field[] fields = clazz.getDeclaredFields();
        Method[] methods = clazz.getMethods();
        for (Field field : fields) {
            for (Method method : methods) {
                if (("set" + setFirstUpper(field.getName())).equals(method.getName())) {
                    ResultSetMetaData metaData = resultSet.getMetaData();
                    for (int i = 1; i < metaData.getColumnCount() + 1; i++) {
                        if (field.getName().equals(metaData.getColumnName(i))) {
                            if (field.getType() == String.class) {
                                method.invoke(bean, resultSet.getString(field.getName()));
                            }
                            if (field.getType() == Integer.class) {
                                method.invoke(bean, resultSet.getInt(field.getName()));
                            }
                            if (field.getType() == Long.class) {
                                method.invoke(bean, resultSet.getLong(field.getName()));
                            }
                            if (field.getType() == Float.class) {
                                method.invoke(bean, resultSet.getFloat(field.getName()));
                            }
                        }
                    }
                    break;
                }
            }
        }
        return bean;
    }

}
```

##### GetConnection.java

```java
package utils;

import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.SQLException;

/**
 * @author Hpsyche
 *
 */
public class GetConnection {
    /**
     * 懒汉式单例
     */
    private static Connection connection=null;
    /**
     * 同步化，处理多线程环境
     * @return
     * @throws SQLException
     * @throws ClassNotFoundException
     */
    public static synchronized Connection getConnection() throws SQLException, ClassNotFoundException {
        if(connection==null){
            String jdbcName="com.mysql.jdbc.Driver";
            Class.forName(jdbcName);
            String url="jdbc:mysql://localhost:3306/jsp_zdx?useUnicode=true&characterEncoding=UTF-8";
            String username="root";
            String password="460204715";
            return DriverManager.getConnection(url,username,password);
        }
        return connection;
    }
    
    /**
     * 将首字母变大写
     * @param s
     * @return
     */
    public static String setFirstUpper(String s){
        char[] cs=s.toCharArray();
        cs[0]-=32;
        return String.valueOf(cs);
    }
}
```

#### pojo层

pojo层主要是javaBean对象，用来传值

##### Mobile.java

```java
package pojo;

/**
 * @author Hpsyche
 */
public class Mobile {
    private Integer mid;
    private String mobile_version;
    private String mobile_name;
    private String mobile_made;
    private Float mobile_price;
    private String mobile_mess;
    private String mobile_pic;
    private Integer id;

    @Override
    public String toString() {
        return "Mobile{" +
                "mid=" + mid +
                ", mobile_version='" + mobile_version + '\'' +
                ", mobile_name='" + mobile_name + '\'' +
                ", mobile_made='" + mobile_made + '\'' +
                ", mobile_price=" + mobile_price +
                ", mobile_mess='" + mobile_mess + '\'' +
                ", mobile_pic='" + mobile_pic + '\'' +
                ", id=" + id +
                '}';
    }

    public Integer getMid() {
        return mid;
    }

    public void setMid(Integer mid) {
        this.mid = mid;
    }

    public void setMobile_price(Float mobile_price) {
        this.mobile_price = mobile_price;
    }

    public String getMobile_version() {
        return mobile_version;
    }

    public void setMobile_version(String mobile_version) {
        this.mobile_version = mobile_version;
    }

    public String getMobile_name() {
        return mobile_name;
    }

    public void setMobile_name(String mobile_name) {
        this.mobile_name = mobile_name;
    }

    public String getMobile_made() {
        return mobile_made;
    }

    public void setMobile_made(String mobile_made) {
        this.mobile_made = mobile_made;
    }

    public float getMobile_price() {
        return mobile_price;
    }

    public void setMobile_price(float mobile_price) {
        this.mobile_price = mobile_price;
    }

    public String getMobile_mess() {
        return mobile_mess;
    }

    public void setMobile_mess(String mobile_mess) {
        this.mobile_mess = mobile_mess;
    }

    public String getMobile_pic() {
        return mobile_pic;
    }

    public void setMobile_pic(String mobile_pic) {
        this.mobile_pic = mobile_pic;
    }

    public Integer getId() {
        return id;
    }

    public void setId(Integer id) {
        this.id = id;
    }
}
```

##### MobileClassify.java

```java
package pojo;

/**
 * @author Hpsyche
 */
public class MobileClassify {
    private Integer id;
    private String name;

    @Override
    public String toString() {
        return "MobileClassify{" +
                "id=" + id +
                ", name='" + name + '\'' +
                '}';
    }

    public Integer getId() {
        return id;
    }

    public void setId(Integer id) {
        this.id = id;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }
}
```

##### Order.java

```java
package pojo;

/**
 * @author Hpsyche
 */
public class Order {
    private Integer id;
    private String logname;
    private String mess;
    private Float sum;
    private Integer status;

    public Integer getStatus() {
        return status;
    }

    public void setStatus(Integer status) {
        this.status = status;
    }

    public Integer getId() {
        return id;
    }

    public void setId(Integer id) {
        this.id = id;
    }

    public String getLogname() {
        return logname;
    }

    public void setLogname(String logname) {
        this.logname = logname;
    }

    public String getMess() {
        return mess;
    }

    public void setMess(String mess) {
        this.mess = mess;
    }

    public Float getSum() {
        return sum;
    }

    public void setSum(Float sum) {
        this.sum = sum;
    }

    @Override
    public String toString() {
        return "Order{" +
                "id=" + id +
                ", logname='" + logname + '\'' +
                ", mess='" + mess + '\'' +
                ", sum=" + sum +
                '}';
    }
}
```

##### User.java

```java
package pojo;

/**
 * @author Hpsyche
 */
public class User {
    private Long uid;
    private String logname;
    private String password;
    private String phone;
    private String address;
    private String realname;

    public Long getUid() {
        return uid;
    }

    public void setUid(Long uid) {
        this.uid = uid;
    }

    @Override
    public String toString() {
        return "User{" +
                "uid=" + uid +
                ", logname='" + logname + '\'' +
                ", password='" + password + '\'' +
                ", phone='" + phone + '\'' +
                ", address='" + address + '\'' +
                ", realname='" + realname + '\'' +
                '}';
    }

    public String getLogname() {
        return logname;
    }

    public void setLogname(String logname) {
        this.logname = logname;
    }

    public String getPassword() {
        return password;
    }

    public void setPassword(String password) {
        this.password = password;
    }

    public String getPhone() {
        return phone;
    }

    public void setPhone(String phone) {
        this.phone = phone;
    }

    public String getAddress() {
        return address;
    }

    public void setAddress(String address) {
        this.address = address;
    }

    public String getRealname() {
        return realname;
    }

    public void setRealname(String realname) {
        this.realname = realname;
    }
}
```

#### dao层

dao层主要是用来操作数据库，进行增删查改等操作。

##### MobileDao.java

```java
package dao;

import pojo.Mobile;
import pojo.User;
import utils.BeanHandler;
import utils.GetConnection;

import java.lang.reflect.InvocationTargetException;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;

/**
 * @author Hpsyche
 */
public class MobileDao {
    /**
     * 查询所有手机页数
     * @return
     * @throws SQLException
     * @throws ClassNotFoundException
     */
    public int showMobilesCount() throws SQLException, ClassNotFoundException {
        Connection conn= GetConnection.getConnection();
        PreparedStatement statement = conn.prepareStatement("select count(*) count from mobileform");
        ResultSet resultSet = statement.executeQuery();
        resultSet.next();
        int count=resultSet.getInt("count");
        if(count%4==0){
            count=count/4;
        }else {
            count=count/4+1;
        }
        return count;
    }

    /**
     * 查询指定分类手机页数
     * @return
     * @throws SQLException
     * @throws ClassNotFoundException
     */
    public int showMobilesCountById(Integer id) throws SQLException, ClassNotFoundException {
        Connection conn= GetConnection.getConnection();
        PreparedStatement statement = conn.prepareStatement("select count(*) count from mobileform where id=?");
        statement.setInt(1,id);
        ResultSet resultSet = statement.executeQuery();
        resultSet.next();
        int count=resultSet.getInt("count");
        if(count%4==0){
            count=count/4;
        }else {
            count=count/4+1;
        }
        return count;
    }

    /**
     * 查询所有手机
     * @param page
     * @return
     */
    public List<Mobile> showAllMobilesByPage(Integer page) throws SQLException, ClassNotFoundException, InvocationTargetException, IllegalAccessException, InstantiationException {
        Connection conn=GetConnection.getConnection();
        PreparedStatement statement = conn.prepareStatement("select * from mobileform limit ?,?");
        statement.setInt(1,(page-1)*4);
        statement.setInt(2,4);
        ResultSet resultSet = statement.executeQuery();
        List<Mobile> mobiles=new ArrayList<>();
        if(resultSet.next()){
            do{
                Mobile mobile = (Mobile) BeanHandler.getJdbcToBean(resultSet, Mobile.class);
                mobiles.add(mobile);
            }while (resultSet.next());
        }
        return mobiles;
    }

    /**
     * 查询所有手机
     * @param page 页数
     * @param id 类别
     * @return
     */
    public List<Mobile> showAllMobilesByPageAndId(Integer page, Integer id) throws SQLException, ClassNotFoundException, IllegalAccessException, InstantiationException, InvocationTargetException {
        Connection conn=GetConnection.getConnection();
        PreparedStatement statement = conn.prepareStatement("select * from mobileform where id=? limit ?,? ");
        statement.setInt(1,id);
        statement.setInt(2,(page-1)*4);
        statement.setInt(3,4);
        ResultSet resultSet = statement.executeQuery();
        List<Mobile> mobiles=new ArrayList<>();
        if(resultSet.next()){
            do{
                Mobile mobile = (Mobile) BeanHandler.getJdbcToBean(resultSet, Mobile.class);
                mobiles.add(mobile);
            }while (resultSet.next());
        }
        return mobiles;
    }

    public Mobile getMobileByMid(Integer mid) throws SQLException, ClassNotFoundException, IllegalAccessException, InvocationTargetException, InstantiationException {
        Connection conn=GetConnection.getConnection();
        PreparedStatement statement = conn.prepareStatement("select * from mobileform where mid=?");
        statement.setInt(1,mid);
        ResultSet resultSet = statement.executeQuery();
        Mobile mobile=new Mobile();
        if(resultSet.next()){
            mobile = BeanHandler.resultSetToBean(Mobile.class, resultSet);
        }
        return mobile;
    }

    public void updateMobile(Mobile mobile) throws SQLException, ClassNotFoundException {
        Connection conn=GetConnection.getConnection();
        PreparedStatement statement = conn.prepareStatement("select * from mobileform where mid=?");
        statement.setLong(1,mobile.getMid());
        ResultSet resultSet = statement.executeQuery();
        if(resultSet.next()){
            updateMobileMethod(mobile);
        }
    }

    private void updateMobileMethod(Mobile mobile) throws SQLException, ClassNotFoundException {
        Connection conn=GetConnection.getConnection();
        PreparedStatement statement = conn.prepareStatement("update mobileform set mobile_version=?,mobile_name=?,mobile_made=?," +
                "mobile_price=?,mobile_mess=?,mobile_pic=?,id=? where mid=?");
        statement.setString(1,mobile.getMobile_version());
        statement.setString(2,mobile.getMobile_name());
        statement.setString(3,mobile.getMobile_made());
        statement.setFloat(4,mobile.getMobile_price());
        statement.setString(5,mobile.getMobile_mess());
        statement.setString(6,mobile.getMobile_pic());
        statement.setInt(7,mobile.getId());
        statement.setInt(8,mobile.getMid());
        statement.executeUpdate();
    }

    public void deleteMobileById(Integer mid) throws SQLException, ClassNotFoundException {
        Connection conn=GetConnection.getConnection();
        PreparedStatement statement = conn.prepareStatement("delete from mobileform where mid=?");
        statement.setInt(1,mid);
        statement.executeUpdate();
    }


    public void addMobile(Mobile mobile) throws SQLException, ClassNotFoundException {
        Connection conn=GetConnection.getConnection();
        PreparedStatement statement = conn.prepareStatement("insert into mobileform(mobile_version,mobile_name,mobile_made," +
                "mobile_price,mobile_mess,mobile_pic,id) values(?,?,?,?,?,?,?)");
        statement.setString(1,mobile.getMobile_version());
        statement.setString(2,mobile.getMobile_name());
        statement.setString(3,mobile.getMobile_made());
        statement.setFloat(4,mobile.getMobile_price());
        statement.setString(5,mobile.getMobile_mess());
        statement.setString(6,mobile.getMobile_pic());
        statement.setInt(7,mobile.getId());
        statement.executeUpdate();
    }
}
```

##### ClassDao.java

```java
package dao;

import pojo.MobileClassify;
import utils.GetConnection;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;

/**
 * @author Hpsyche
 */
public class ClassDao {
    public List<MobileClassify> getMobileClassifies() throws SQLException, ClassNotFoundException {
        Connection conn= GetConnection.getConnection();
        PreparedStatement statement = conn.prepareStatement("select * from mobileclassify");
        ResultSet resultSet = statement.executeQuery();
        List<MobileClassify> list=new ArrayList<>();
        if(resultSet.next()){
            do{
                MobileClassify mobileClassify=new MobileClassify();
                mobileClassify.setId(resultSet.getInt(1));
                mobileClassify.setName(resultSet.getString(2));
                list.add(mobileClassify);
            }while (resultSet.next());
        }
        return list;
    }

    public void updateMobile(MobileClassify bean) throws SQLException, ClassNotFoundException {
        Connection conn= GetConnection.getConnection();
        PreparedStatement statement = conn.prepareStatement("update mobileclassify set name=? where id=?");
        statement.setString(1,bean.getName());
        statement.setInt(2,bean.getId());
        statement.executeUpdate();
    }

    public void deleteClass(Integer cid) throws SQLException, ClassNotFoundException {
        Connection conn= GetConnection.getConnection();
        PreparedStatement statement = conn.prepareStatement("delete from mobileclassify where id=?");
        statement.setInt(1,cid);
        statement.executeUpdate();
    }

    public void insertClassify(MobileClassify classify) throws SQLException, ClassNotFoundException {
        Connection conn= GetConnection.getConnection();
        PreparedStatement statement = conn.prepareStatement("insert into mobileclassify values(?,?)");
        statement.setInt(1,classify.getId());
        statement.setString(2,classify.getName());
        statement.executeUpdate();
    }
}
```

##### Order.java

```java
package dao;

import pojo.Mobile;
import pojo.Order;
import utils.BeanHandler;
import utils.GetConnection;

import java.lang.reflect.InvocationTargetException;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;

/**
 * @author Hpsyche
 */
public class OrderDao {

    public int showOrdersCount() throws SQLException, ClassNotFoundException {
        Connection conn= GetConnection.getConnection();
        PreparedStatement statement = conn.prepareStatement("select count(*) count from orderform");
        ResultSet resultSet = statement.executeQuery();
        resultSet.next();
        int count=resultSet.getInt("count");
        if(count%4==0){
            count=count/4;      
        }else {
            count=count/4+1;
        }
        return count;
    }

    public List<Order> showAllOrdersByPage(Integer page) throws SQLException, ClassNotFoundException, IllegalAccessException, InstantiationException, InvocationTargetException {
        Connection conn=GetConnection.getConnection();
        PreparedStatement statement = conn.prepareStatement("select * from orderform limit ?,?");
        statement.setInt(1,(page-1)*4);
        statement.setInt(2,4);
        ResultSet resultSet = statement.executeQuery();
        List<Order> orders=new ArrayList<>();
        if(resultSet.next()){
            do{
                Order order = (Order) BeanHandler.getJdbcToBean(resultSet, Order.class);
                orders.add(order);
            }while (resultSet.next());
        }
        return orders;
    }

    public Order getOrderByOid(Integer oid) throws SQLException, ClassNotFoundException, IllegalAccessException, InvocationTargetException, InstantiationException {
        Connection conn=GetConnection.getConnection();
        PreparedStatement statement = conn.prepareStatement("select * from orderform where id=?");
        statement.setInt(1,oid);
        ResultSet resultSet = statement.executeQuery();
        Order order=new Order();
        if(resultSet.next()){
            order = BeanHandler.resultSetToBean(Order.class, resultSet);
        }
        return order;
    }

    public void updateOrderStatusByOid(Integer oid,Integer status) throws SQLException, ClassNotFoundException {
        Connection conn=GetConnection.getConnection();
        PreparedStatement statement = conn.prepareStatement("update orderform set status=? where id=?");
        statement.setInt(1,status);
        statement.setInt(2,oid);
        statement.executeUpdate();
    }

    public void deleteOrderByOid(Integer oid) throws SQLException, ClassNotFoundException {
        Connection conn=GetConnection.getConnection();
        PreparedStatement statement = conn.prepareStatement("delete from orderform where id=?");
        statement.setInt(1,oid);
        statement.executeUpdate();
    }
}
```

##### UserDao.java

```java
package dao;

import pojo.User;
import utils.BeanHandler;
import utils.GetConnection;

import java.lang.reflect.InvocationTargetException;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;

/**
 * @author Hpsyche
 */
public class UserDao {

    /**
     * 查询所有用户
     * @param page
     * @return
     */
    public List<User> showAllUsersByPage(Integer page) throws SQLException, ClassNotFoundException, InvocationTargetException, IllegalAccessException, InstantiationException {
        Connection conn=GetConnection.getConnection();
        PreparedStatement statement = conn.prepareStatement("select * from user limit ?,?");
        statement.setInt(1,(page-1)*10);
        statement.setInt(2,10);
        ResultSet resultSet = statement.executeQuery();
        List<User> users=new ArrayList<>();
        if(resultSet.next()){
            do{
                User user = (User) BeanHandler.getJdbcToBean(resultSet, User.class);
                users.add(user);
            }while (resultSet.next());
        }
        return users;
    }

    public int showUsersCount() throws SQLException, ClassNotFoundException {
        Connection conn=GetConnection.getConnection();
        PreparedStatement statement = conn.prepareStatement("select count(*) count from user");
        ResultSet resultSet = statement.executeQuery();
        resultSet.next();
        int count=resultSet.getInt("count");
        if(count%10==0){
            count=count/10;
        }else {
            count=count/10+1;
        }
        return count;
    }

    public User getUserByUid(Integer uid) throws SQLException, ClassNotFoundException, IllegalAccessException, InvocationTargetException, InstantiationException {
        Connection conn=GetConnection.getConnection();
        PreparedStatement statement = conn.prepareStatement("select * from user where uid=?");
        statement.setInt(1,uid);
        ResultSet resultSet = statement.executeQuery();
        User user=new User();
        if(resultSet.next()){
            user = BeanHandler.resultSetToBean(User.class, resultSet);
        }
        return user;
    }

    public void updateUser(User user) throws SQLException, ClassNotFoundException {
        Connection conn=GetConnection.getConnection();
        PreparedStatement statement = conn.prepareStatement("select * from user where uid=?");
        statement.setLong(1,user.getUid());
        ResultSet resultSet = statement.executeQuery();
        if(resultSet.next()){
            updateUserMethod(user);
        }

    }

    private void updateUserMethod(User user) throws SQLException, ClassNotFoundException {
        Connection conn=GetConnection.getConnection();
        PreparedStatement statement = conn.prepareStatement("update user set logname=?,password=?," +
                "phone=?,address=?,realname=? where uid=?");
        statement.setString(1,user.getLogname());
        statement.setString(2,user.getPassword());
        statement.setString(3,user.getLogname());
        statement.setString(4,user.getLogname());
        statement.setString(5,user.getRealname());
        statement.setLong(6,user.getUid());
        statement.executeUpdate();
    }

    public void deleteUserById(Long uid) throws SQLException, ClassNotFoundException {
        Connection conn=GetConnection.getConnection();
        PreparedStatement statement = conn.prepareStatement("delete from user where uid=?");
        statement.setLong(1,uid);
        statement.executeUpdate();
    }
}
```

### 登录界面

注意：

* 管理员的身份确认很简单，即只需要输入账号和密码相同即可确认身份；
* 设置一个LoginFilter，若在session中没获取到uid，重定向到登录界面

#### 代码：

##### login.jsp

```jsp
<%--
  Created by IntelliJ IDEA.
  User: Hpsyche
  Date: 2019/5/17
  Time: 16:49
  To change this template use File | Settings | File Templates.
--%>
<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<link rel="stylesheet" type="text/css" href="/admin/showUsers.css"/>
<html>
<head>
    <title>Title</title>
</head>
<body>
<form method="post" action="/AdminLoginServlet" >
    <table class="datalist">
        <tr>
            <td>用户名:</td>
            <td><input type="text" name="username"></td>
        </tr>
        <tr>
            <td>密码:</td>
            <td><input type="password" name="password"></td>
        </tr>
    </table>
    <input type="submit" value="登录">
${msg}
</form>
</body>
</html>
```

##### AdminLoginServlet

```java
package myservlet.admin;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;

@WebServlet("/AdminLoginServlet")
public class AdminLoginServlet extends HttpServlet {
    @Override
    protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        doGet(request,response);
    }

    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        String username=request.getParameter("username");
        String password=request.getParameter("password");
        if(username.equals(password)){
            request.getSession(true).setAttribute("uid",username);
            request.getRequestDispatcher("/admin/adminIndex.jsp").forward(request,response);
        }else {
            request.setAttribute("msg","验证失败！");
            .getRequestDispatcher("/admin/login.jsp").forward(request,response);
        }

    }
}
```

##### LoginFilter.java

```java
package filter;

import javax.servlet.*;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;
import java.io.IOException;

/**
 * @author Hpsyche
 */
public class LoginFilter implements Filter {
    @Override
    public void init(FilterConfig filterConfig) throws ServletException {

    }

    @Override
    public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException {
        HttpServletRequest request= (HttpServletRequest) servletRequest;
        HttpServletResponse response= (HttpServletResponse) servletResponse;
        HttpSession session = request.getSession(true);
        String uid= (String) session.getAttribute("uid");
        String url=request.getRequestURI();
        if(uid==null||uid.equals("")){
            if(url.contains("showUsers")){
                filterChain.doFilter(servletRequest,servletResponse);
                return;
            }
            if(url.contains("admin")&&!url.contains("login")){
                response.sendRedirect("/admin/login.jsp");
                return;
            }
        }
        filterChain.doFilter(servletRequest,servletResponse);
    }

    @Override
    public void destroy() {

    }
}
```

#### 演示效果

![1558442437846](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1558442437846.png)

### 后台主页

#### 代码：

##### adminIndex.jsp

```jsp
<%--
  Created by IntelliJ IDEA.
  User: Hpsyche
  Date: 2019/5/16
  Time: 10:27
  To change this template use File | Settings | File Templates.
--%>
<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<script type="text/javascript" language="javascript" src="dtree.js"></script>
<link rel="stylesheet" type="text/css" href="dtree.css"/>
<link rel="stylesheet" type="text/css" href="lefttree.css"/>
<html>
<head>
    <title>Title</title>
</head>
<body>
<div id="left"><%@ include file="leftTree.jsp" %></div>
<div id="right"></div>
</body>
</html>
```

##### leftTree.jsp

```jsp
<%--
  Created by IntelliJ IDEA.
  User: Hpsyche
  Date: 2019/5/16
  Time: 10:27
  To change this template use File | Settings | File Templates.
--%>
<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<script type="text/javascript" language="javascript" src="/admin/dtree.js"></script>
<link rel="stylesheet" type="text/css" href="/admin/dtree.css"/>
<link rel="stylesheet" type="text/css" href="/admin/lefttree.css"/>
<html>
<head>
    <title>Title</title>
</head>
<body>

</body>
<script type="text/javascript">
    d12=new dTree('d12');
    d12.add(0,-1,"后台管理系统");
    d12.add(10,0,"用户管理");
    d12.add(11,10,"<a href='/ShowAllUsersServlet?page=1'>所有用户</a>");
    d12.add(20,0,"分类管理");
    d12.add(21,20,"<a href='/ShowAllClassServlet'>所有分类</a>");
    d12.add(30,0,"商品管理");
    d12.add(31,30,"<a href='/ShowAllMobilesServlet?page=1'>所有商品</a>");
    d12.add(40,0,"订单管理");
    d12.add(41,40,"<a href='/ShowAllOrdersServlet?page=1'>所有订单</a>");
    d12.add(50,0,"<a href='/'>前台系统</a>");
    //通过document.write()将显示出来。
    document.write(d12);
</script>
</html>
```

#### 演示效果

![1558442814634](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1558442814634.png)

### 所有用户

#### 代码：

##### showallusers.jsp

```jsp
<%--
  Created by IntelliJ IDEA.
  User: Hpsyche
  Date: 2019/5/16
  Time: 10:56
  To change this template use File | Settings | File Templates.
--%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ page contentType="text/html;charset=UTF-8" %>
<link rel="stylesheet" type="text/css" href="/admin/showUsers.css"/>
<html>
<head>
    <title>Title</title>
</head>
<body>
<div id="left"><%@ include file="leftTree.jsp" %></div>
<div id="right">
    <h1>显示所有用户</h1>
    <table class="datalist">
        <tr>
            <th>用户名</th>
            <th>用户密码</th>
            <th>手机号码</th>
            <th>地址</th>
            <th>实际姓名</th>
            <th>修改</th>
            <th>删除</th>
        </tr>
        <c:forEach items="${users}" var="user">
            <tr>
                <td>${user.logname}</td>
                <td>${user.password}</td>
                <td>${user.phone}</td>
                <td>${user.address}</td>
                <td>${user.realname}</td>
                <td><input type="button" value="修改" onclick='updateUserUI(${user.uid})'></td>
                <td><input type="button" value="删除" onclick='deleteUser(${user.uid})'></td>
            </tr>
        </c:forEach>
    </table>
    <input type="button" value="上一页" onclick="prePage()">
    第${page}页/共${count}页
    <input type="button" value="下一页" onclick="nextPage()">
</div>
</body>
<script type="text/javascript">
    function prePage() {
        var page=${page};
        if(page==1){
            return;
        }
        window.location.href='/ShowAllUsersServlet?page='+(page-1);
    }
    function nextPage() {
        var page=${page};
        var count=${count};
        if(page+1>count){
            return;
        }
        window.location.href='/ShowAllUsersServlet?page='+(page+1);
    }
    function updateUserUI(uid) {
        window.location.href="/UpdateUserUIServlet?uid="+uid;
    }
    function deleteUser(uid) {
        var msg="确定删除吗";
        if (confirm(msg)==true){
            window.location.href="/DeleteServlet?uid="+uid;
        }else{
            return false;
        }
    }
</script>
</html>

```

##### ShowAllUsersServlet.java

```java
package myservlet.admin;

import dao.UserDao;
import pojo.User;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.lang.reflect.InvocationTargetException;
import java.sql.SQLException;
import java.util.List;

@WebServlet("/ShowAllUsersServlet")
public class ShowAllUsersServlet extends HttpServlet {
    private UserDao userDao=new UserDao();
    @Override
    protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
    }

    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        //获取记录条数
        int count=0;
        try {
            count=userDao.showUsersCount();
        } catch (Exception e) {
            e.printStackTrace();
        }
        Integer page = Integer.valueOf(request.getParameter("page"));
        List<User> userList= null;
        try {
            userList = userDao.showAllUsersByPage(page);
        } catch (Exception e) {
            e.printStackTrace();
        }
        request.setAttribute("count",count);
        request.setAttribute("users",userList);
        request.setAttribute("page",page);
        request.getRequestDispatcher("/admin/showallusers.jsp").forward(request,response);
    }
}
```

#### 演示效果

![1558444676443](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1558444676443.png)

![1558444762979](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1558444762979.png)

### 修改用户信息的页面跳转

#### 代码：

##### UpdateUserUIServlet.java

```java
package myservlet.admin;

import dao.UserDao;
import pojo.User;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.sql.SQLException;

@WebServlet("/UpdateUserUIServlet")
public class UpdateUserUIServlet extends HttpServlet {
    private UserDao userDao=new UserDao();
    @Override
    protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {

    }
    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        Integer uid = Integer.valueOf(request.getParameter("uid"));
        try {
            User user=userDao.getUserByUid(uid);
            request.setAttribute("user",user);
            request.getRequestDispatcher("/admin/updateUI.jsp").forward(request,response);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

##### UpdateUI.jsp

```jsp
<%--
  Created by IntelliJ IDEA.
  User: Hpsyche
  Date: 2019/5/16
  Time: 19:25
  To change this template use File | Settings | File Templates.
--%>
<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<html>
<head>
    <title>Title</title>
</head>
<body>
<div id="left"><%@ include file="leftTree.jsp" %></div>
<div id="right">
    <h1>修改用户信息</h1>
    <form method="post" action="/UpdateUserServlet">
    <table>
        <tr>
            <td>用户id</td>
            <td><input type="text" readonly="readonly" value="${user.uid}" name="uid"></td>
        </tr>
        <tr>
            <td>用户名</td>
            <td><input type="text" value="${user.logname}" name="logname"/></td>
        </tr>
        <tr>
            <td>用户密码</td>
            <td><input type="text" value="${user.password}" name="password"/></td>
        </tr>
        <tr>
            <td>手机号码</td>
            <td><input type="text" value="${user.phone}" name="phone"/></td>
        </tr>
        <tr>
            <td>用户地址</td>
            <td><input type="text" value="${user.address}" name="address"/></td>
        </tr>
        <tr>
            <td>真实姓名</td>
            <td><input type="text" value="${user.realname}" name="realname"/></td>
        </tr>
    </table>
        <input type="submit" value="修改">
    </form>
    <h2>${msg}</h2>
</div>
</body>
</html>
```

#### 演示效果

![1558450858758](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1558450858758.png)

### 修改用户信息

#### 代码：

##### UpdateUserServlet.java

```java
package myservlet.admin;

import dao.UserDao;
import pojo.User;
import utils.BeanHandler;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.lang.reflect.InvocationTargetException;

@WebServlet("/UpdateUserServlet")
public class UpdateUserServlet extends HttpServlet {
    private UserDao userDao=new UserDao();
    @Override
    protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        doGet(request,response);
    }

    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        request.setCharacterEncoding("utf-8");
        try {
            User user = BeanHandler.getParametersToBean(User.class, request);
            userDao.updateUser(user);
            request.setAttribute("msg","修改成功");
            request.getRequestDispatcher("/admin/updateUI.jsp").forward(request,response);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

#### 演示效果

![1558450969736](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1558450969736.png)

### 删除用户信息

#### 代码：

##### DeleteServlet.java

```java
package myservlet.admin;

import dao.UserDao;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.sql.SQLException;

@WebServlet("/DeleteServlet")
public class DeleteServlet extends HttpServlet {
    private UserDao userDao=new UserDao();
    @Override
    protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        doGet(request,response);
    }

    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        Long uid = Long.valueOf(request.getParameter("uid"));
        try {
            userDao.deleteUserById(uid);
            request.setAttribute("msg","删除成功");
            request.getRequestDispatcher("/admin/msg.jsp").forward(request,response);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

回显页面

##### msg.jsp

```JSP
<%--
  Created by IntelliJ IDEA.
  User: Hpsyche
  Date: 2019/5/16
  Time: 22:14
  To change this template use File | Settings | File Templates.
--%>
<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<html>
<head>
    <title>Title</title>
</head>
<div id="left"><%@ include file="leftTree.jsp" %></div>
<div id="right">
    <h1>${msg}</h1>
</div>
<body>
</body>
</html>
```

#### 演示效果

![1558451765147](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1558451765147.png)

### 所有分类

#### 代码：

##### ShowAllClassServlet.java

```java
package myservlet.admin;

import dao.ClassDao;
import pojo.MobileClassify;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.sql.SQLException;
import java.util.List;

@WebServlet("/ShowAllClassServlet")
public class ShowAllClassServlet extends HttpServlet {
    private ClassDao classDao=new ClassDao();
    @Override
    protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        doGet(request,response);
    }

    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        try {
            List<MobileClassify> mobileClassifies = classDao.getMobileClassifies();
            request.setAttribute("list",mobileClassifies);
            request.getRequestDispatcher("/admin/showallclass.jsp").forward(request,response);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

##### showallclass.jsp

```jsp
<%--
  Created by IntelliJ IDEA.
  User: Hpsyche
  Date: 2019/5/16
  Time: 10:56
  To change this template use File | Settings | File Templates.
--%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ page contentType="text/html;charset=UTF-8" %>
<link rel="stylesheet" type="text/css" href="/admin/showUsers.css"/>
<html>
<head>
    <title>Title</title>
</head>
<body>
<div id="left"><%@ include file="leftTree.jsp" %></div>
<div id="right">
    <h1>显示所有类别</h1>
    <table class="datalist">
        <tr>
            <th>类id</th>
            <th>类名</th>
            <th>修改</th>
            <th>删除</th>
        </tr>
        <c:forEach items="${list}" var="mobileClass">
            <tr>
                <td>${mobileClass.id}</td>
                <td>${mobileClass.name}</td>
                <td><input type="button" value="修改" onclick="updateClassUI(${mobileClass.id},'${mobileClass.name}')"></td>
                <td><input type="button" value="删除" onclick='deleteClass(${mobileClass.id})'></td>
            </tr>
        </c:forEach>
    </table>
    <input type="button" value="新增分类" onclick="addClass()">
</div>
</body>
<script type="text/javascript">
    function updateClassUI(cid,cname) {
        window.location.href="/UpdateClassUIServlet?cid="+cid+"&cname="+cname;
    }
    function deleteClass(cid) {
        var msg="确定删除吗";
        if (confirm(msg)==true){
            window.location.href="/DeleteClassServlet?cid="+cid;
        }else{
            return false;
        }
    }
    function addClass() {
        window.location.href="/admin/addClassUI.jsp";
    }
</script>
</html>
```

#### 演示效果

![1558452032304](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1558452032304.png)

### 修改分类信息的页面跳转

#### 代码：

##### UpdateUserUIServlet.java

```java
package myservlet.admin;

import dao.UserDao;
import pojo.User;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.sql.SQLException;

@WebServlet("/UpdateUserUIServlet")
public class UpdateUserUIServlet extends HttpServlet {
    private UserDao userDao=new UserDao();
    @Override
    protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {

    }
    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        Integer uid = Integer.valueOf(request.getParameter("uid"));
        try {
            User user=userDao.getUserByUid(uid);
            request.setAttribute("user",user);
            request.getRequestDispatcher("/admin/updateUI.jsp").forward(request,response);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```



##### updateUI.jsp

```jsp
<%--
  Created by IntelliJ IDEA.
  User: Hpsyche
  Date: 2019/5/16
  Time: 19:25
  To change this template use File | Settings | File Templates.
--%>
<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<html>
<head>
    <title>Title</title>
</head>
<body>
<div id="left"><%@ include file="leftTree.jsp" %></div>
<div id="right">
    <h1>修改用户信息</h1>
    <form method="post" action="/UpdateUserServlet">
    <table>
        <tr>
            <td>用户id</td>
            <td><input type="text" readonly="readonly" value="${user.uid}" name="uid"></td>
        </tr>
        <tr>
            <td>用户名</td>
            <td><input type="text" value="${user.logname}" name="logname"/></td>
        </tr>
        <tr>
            <td>用户密码</td>
            <td><input type="text" value="${user.password}" name="password"/></td>
        </tr>
        <tr>
            <td>手机号码</td>
            <td><input type="text" value="${user.phone}" name="phone"/></td>
        </tr>
        <tr>
            <td>用户地址</td>
            <td><input type="text" value="${user.address}" name="address"/></td>
        </tr>
        <tr>
            <td>真实姓名</td>
            <td><input type="text" value="${user.realname}" name="realname"/></td>
        </tr>
    </table>
        <input type="submit" value="修改">
    </form>
    <h2>${msg}</h2>
</div>
</body>
</html>
```

#### 演示效果

![1558452892032](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1558452892032.png)

### 修改分类信息

#### 代码：

##### UpdateClassServlet.java

```java
package myservlet.admin;

import dao.ClassDao;
import pojo.MobileClassify;
import utils.BeanHandler;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.lang.reflect.InvocationTargetException;

@WebServlet("/UpdateClassServlet")
public class UpdateClassServlet extends HttpServlet {
    private ClassDao classDao=new ClassDao();

    @Override
    protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        doGet(request,response);
    }

    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        request.setCharacterEncoding("utf-8");
        try {
            MobileClassify bean = BeanHandler.getParametersToBean(MobileClassify.class, request);
            classDao.updateMobile(bean);
            request.setAttribute("msg","修改成功！");
            request.getRequestDispatcher("/admin/updateClass.jsp").forward(request,response);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

#### 演示效果

![1558452965430](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1558452965430.png)

### 新增分类页面跳转

#### 代码：

##### addClassUI.jsp

```jsp
<%--
  Created by IntelliJ IDEA.
  User: Hpsyche
  Date: 2019/5/16
  Time: 23:55
  To change this template use File | Settings | File Templates.
--%>
<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<html>
<head>
    <title>Title</title>
</head>
<body>
<div id="left"><%@ include file="leftTree.jsp" %></div>
<div id="right">
    <h1>添加类别</h1>
    <form method="post" action="/AddClassServlet">
        <table>
            <tr>
                <td>类id</td>
                <td><input type="text" value="${cid}" name="id"></td>
            </tr>
            <tr>
                <td>类名</td>
                <td><input type="text" value="${cname}" name="name"></td>
            </tr>
        </table>
        <input type="submit" value="确认添加">
    </form>
    <h2>${msg}</h2>
</div>
</body>
</html>
```

#### 演示效果

![1558453185515](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1558453185515.png)

### 新增分类

#### 代码：

##### AddClassServlet.java

```java
package myservlet.admin;

import dao.ClassDao;
import pojo.MobileClassify;
import utils.BeanHandler;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;

@WebServlet("/AddClassServlet")
public class AddClassServlet extends HttpServlet {
    private ClassDao classDao=new ClassDao();

    @Override
    protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        doGet(request,response);
    }

    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        try{
            MobileClassify classify= BeanHandler.getParametersToBean(MobileClassify.class,request);
            classDao.insertClassify(classify);
            request.setAttribute("msg","添加成功");
        }catch (Exception e){
            request.setAttribute("msg","添加失败，请确保类id没有重复");
            e.printStackTrace();
        }
        request.getRequestDispatcher("/admin/addClassUI.jsp").forward(request,response);
    }
}
```

#### 演示效果

![1558453252252](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1558453252252.png)

### 删除分类

#### 代码：

##### DeleteClassServlet.java

```java
package myservlet.admin;

import dao.ClassDao;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;

@WebServlet("/DeleteClassServlet")
public class DeleteClassServlet extends HttpServlet {
    private ClassDao classDao=new ClassDao();

    @Override
    protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        doGet(request,response);
    }

    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
       try{
           Integer cid=Integer.valueOf(request.getParameter("cid"));
           classDao.deleteClass(cid);
           request.setAttribute("msg","删除成功");
           request.getRequestDispatcher("/admin/msg.jsp").forward(request,response);
       }catch (Exception e){
           e.printStackTrace();
       }
    }
}
```

#### 效果演示

![1558453535993](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1558453535993.png)

### 所有商品或按分类选择商品

#### 代码：

##### ShowAllMobilesServlet.java

```java
package myservlet.admin;

import dao.ClassDao;
import dao.MobileDao;
import dao.UserDao;
import pojo.Mobile;
import pojo.MobileClassify;
import pojo.User;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.sql.SQLException;
import java.util.List;

@WebServlet("/ShowAllMobilesServlet")
public class ShowAllMobilesServlet extends HttpServlet {
    private MobileDao mobileDao=new MobileDao();
    private ClassDao classDao=new ClassDao();

    @Override
    protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        doGet(request,response);
    }

    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        //获取记录条数
        int count=0;
        try {
            //获得类别
            Integer page = Integer.valueOf(request.getParameter("page"));
            List<Mobile> mobileList = null;
            if(request.getParameter("id")==null) {
                count = mobileDao.showMobilesCount();
                mobileList = mobileDao.showAllMobilesByPage(page);
                request.setAttribute("id",0);
            }
            else {
                Integer id=Integer.valueOf(request.getParameter("id"));
                //获得页数
                count = mobileDao.showMobilesCountById(id);
                mobileList = mobileDao.showAllMobilesByPageAndId(page,id);
                request.setAttribute("id",id);
            }
            List<MobileClassify> mobileClassifies = null;
            mobileClassifies = classDao.getMobileClassifies();
            request.setAttribute("classes", mobileClassifies);
            request.setAttribute("count", count);
            request.setAttribute("mobiles", mobileList);
            request.setAttribute("page", page);
            request.getRequestDispatcher("/admin/showallmobiles.jsp").forward(request, response);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

##### showallmobiles.jsp

```jsp
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%--
  Created by IntelliJ IDEA.
  User: Hpsyche
  Date: 2019/5/17
  Time: 0:53
  To change this template use File | Settings | File Templates.
--%>
<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<link rel="stylesheet" type="text/css" href="/admin/showUsers.css"/>
<html>
<head>
    <title>Title</title>
</head>
<div id="left"><%@ include file="leftTree.jsp" %></div>
<div id="right">
    <h1>显示所有商品</h1>
    <form action="/ShowAllMobilesServlet?page=1" method="post">
    <tr>
        <td>选择手机类别</td>
        <td>
            <select name="id">
                <c:forEach items="${classes}" var="classItem">
                    <c:if test="${classItem.id eq id}">
                        <option value="${classItem.id}" id="${classItem.id}" selected="selected">${classItem.name}</option>
                    </c:if>
                    <c:if test="${classItem.id ne id}">
                        <option value="${classItem.id}" id="${classItem.id}">${classItem.name}</option>
                    </c:if>
                </c:forEach>
            </select>
        </td>
        <td><input type="submit" value="确认选择"></td>
    </tr>
    </form>
    <table class="datalist">
        <tr>
            <th>手机型号</th>
            <th>手机名称</th>
            <th>手机制造商</th>
            <th>手机价格</th>
            <th>手机描述</th>
            <th>手机图片</th>
            <th>修改</th>
            <th>删除</th>
        </tr>
        <c:forEach items="${mobiles}" var="mobile">
            <tr>
                <td>${mobile.mobile_version}</td>
                <td>${mobile.mobile_name}</td>
                <td>${mobile.mobile_made}</td>
                <td>${mobile.mobile_price}</td>
                <td>${mobile.mobile_mess}</td>
                <td><c:if test="${not empty mobile.mobile_pic}"><img src="/image/${mobile.mobile_pic}" style="width: 60px;height: 60px;"/></c:if></td>
                <td><input type="button" value="修改" onclick='updateMobileUI(${mobile.mid})'></td>
                <td><input type="button" value="删除" onclick='deleteMobile(${mobile.mid})'></td>
            </tr>
        </c:forEach>
    </table>
    <input type="button" value="上一页" onclick="prePage()">
    第${page}页/共${count}页
    <input type="button" value="下一页" onclick="nextPage()">
    <br/><br/>
    <input type="button" style="width: 100px;padding: 5px" value="新增商品" onclick="addMobileUI()"/>
</div>
<body>

</body>
<script type="text/javascript">
    function addMobileUI() {
        window.location.href="/addMobileUIServlet";
    }
    function prePage() {
        var page=${page};
        if(page==1){
            return;
        }
        var id=${id};
        if(id==0){
            window.location.href = '/ShowAllMobilesServlet?page=' + (page - 1);
        }else {
            window.location.href = '/ShowAllMobilesServlet?page=' + (page - 1)+"&id="+id;
        }
    }
    function nextPage() {
        var page=${page};
        var count=${count};
        if(page+1>count){
            return;
        }
        var id=${id};
        if(id==0) {
            window.location.href = '/ShowAllMobilesServlet?page=' + (page + 1);
        }else {
            window.location.href = '/ShowAllMobilesServlet?page=' + (page + 1)+"&id="+id;
        }
    }
    function updateMobileUI(mid) {
        window.location.href="/UpdateMobileUIServlet?mid="+mid;
    }
    function deleteMobile(mid) {
        var msg="确定删除吗";
        if (confirm(msg)==true){
            window.location.href="/DeleteMobileServlet?mid="+mid;
        }else{
            return false;
        }
    }
</script>
</html>

```

#### 演示效果

![1558453689978](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1558453689978.png)

### ![1558453794579](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1558453794579.png)

### 上传图片

#### 代码：

##### UploadPicImgServlet.java

```java
package myservlet.admin;

import org.apache.commons.fileupload.FileItem;
import org.apache.commons.fileupload.FileUploadException;
import org.apache.commons.fileupload.disk.DiskFileItemFactory;
import org.apache.commons.fileupload.servlet.ServletFileUpload;
import org.apache.commons.io.IOUtils;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.Part;
import java.io.*;
import java.util.Collection;
import java.util.List;
import java.util.Map;
import java.util.Random;

@WebServlet("/UploadPicImgServlet")
public class  UploadPicImgServlet extends HttpServlet {
    @Override
    protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        doGet(request, response);
    }

    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        //1、创建磁盘文件项工厂
        //获取web根目录下放置缓存文件的文件夹“temp”的物理路径
        String path_temp = this.getServletContext().getRealPath("image");
        File file = new File(path_temp);
        DiskFileItemFactory factory = new DiskFileItemFactory(1024 * 1024, file);//1024*1024为设置文件缓存大小
        //2、创建文件上传的核心类
        ServletFileUpload upload = new ServletFileUpload(factory);
        //设置上传文件名称的编码为UTF-8，不设置有可能会出现中文乱码，编码规范要进行设置。
        upload.setHeaderEncoding("UTF-8");
        //判断表单是否是文件上传表单，只是为了演示需要，实际开发中开发人员肯定知道这是不是文件上传表单
        boolean multipartContent = ServletFileUpload.isMultipartContent(request);
        if (multipartContent) {
            //是文件上传的表单，解析request获得文件项集合
            List<FileItem> parseRequest = null;
            try {
                parseRequest = upload.parseRequest(request);
            } catch (FileUploadException e1) {
                e1.printStackTrace();
            }
            if (parseRequest != null) {
                for (FileItem item : parseRequest) {
                    //判断是不是普通表单项
                    boolean formField = item.isFormField();
                    //如果是文件上传项
                    String name = item.getName();
                    //加入判断文件是否上传，如果不加判断，前台没有选择文件，提交后会报IO空指针异常
                    if (item.getSize() == 0L) {
                        response.setContentType("text/html;charset=UTF-8");
                        response.getWriter().write("请上传文件");
                        return;
                    }
                    if (name == "") {
                        response.setContentType("text/html;charset=UTF-8");
                        response.getWriter().write("文件名不能为空");
                        return;
                    }
                    item.setFieldName("");
                    InputStream in = item.getInputStream();
                    String path_store = "D:\\javalearn\\jsp_zdx_code\\web\\image";
                    Random random = new Random();
                    int i = random.nextInt(1000);
                    System.out.println(i+"_"+name);
                    OutputStream out = new FileOutputStream(path_store + "/" + i + "_" + name);
                    IOUtils.copy(in, out);
                    in.close();
                    out.close();
                    response.getWriter().write(i+"_"+name);
                }
            }
        }
    }
}
```

### 修改商品信息页面跳转

 #### 代码：

##### UpdateMobileUIServlet.java

```java
package myservlet.admin;

import dao.ClassDao;
import dao.MobileDao;
import pojo.Mobile;
import pojo.MobileClassify;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.lang.reflect.InvocationTargetException;
import java.sql.SQLException;
import java.util.List;

@WebServlet("/UpdateMobileUIServlet")
public class UpdateMobileUIServlet extends HttpServlet {
    private MobileDao mobileDao=new MobileDao();
    private ClassDao classDao=new ClassDao();
    @Override
    protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
       doGet(request,response);
    }

    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        request.setCharacterEncoding("utf-8");
        Integer mid=Integer.valueOf(request.getParameter("mid"));
        try {
            //1.查询手机信息
            Mobile mobile=mobileDao.getMobileByMid(mid);
            request.setAttribute("mobile",mobile);
            //2.获取所有分类信息
            List<MobileClassify> mobileClassifies = classDao.getMobileClassifies();
            request.setAttribute("classes",mobileClassifies);
            request.getRequestDispatcher("/admin/updateMobileUI.jsp").forward(request,response);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

##### UpdateMobileUI.jsp

```jsp
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%--
  Created by IntelliJ IDEA.
  User: Hpsyche
  Date: 2019/5/16
  Time: 19:25
  To change this template use File | Settings | File Templates.
--%>
<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<html>
<head>
    <title>Title</title>
</head>
<body>
<div id="left"><%@ include file="leftTree.jsp" %></div>
<div id="right">
    <h1>修改手机信息</h1>
    <form method="post" action="/UpdateMobileServlet">
    <table>
        <tr>
            <td>手机编号</td>
            <td><input type="text" readonly="readonly" value="${mobile.mid}" name="mid"></td>
        </tr>
        <tr>
            <td>手机所属类别</td>
            <td>
                <select name="id">
                    <c:forEach items="${classes}" var="classItem">
                        <c:if test="${classItem.id eq mobile.id}">
                            <option value="${classItem.id}" id="${classItem.id}" selected="selected">${classItem.name}</option>
                        </c:if>
                        <c:if test="${classItem.id ne mobile.id}">
                            <option value="${classItem.id}" id="${classItem.id}">${classItem.name}</option>
                        </c:if>
                    </c:forEach>
                </select>
            </td>
        </tr>
        <tr>
            <td>手机型号</td>
            <td><input type="text" value="${mobile.mobile_version}" name="mobile_version"/></td>
        </tr>
        <tr>
            <td>手机名称</td>
            <td><input type="text" value="${mobile.mobile_name}" name="mobile_name"/></td>
        </tr>
        <tr>
            <td>手机制造商</td>
            <td><input type="text" value="${mobile.mobile_made}" name="mobile_made"/></td>
        </tr>
        <tr>
            <td>手机价格</td>
            <td><input type="text" value="${mobile.mobile_price}" name="mobile_price"/></td>
        </tr>
        <tr>
            <td>手机详情</td>
            <td><input type="text" value="${mobile.mobile_mess}" name="mobile_mess"/></td>
        </tr>
        <tr>
            <td>手机照片</td>
            <td><img id="myImg" style="width: 80px;height: 80px;" src="/image/${mobile.mobile_pic}">
                <input type="hidden" name="mobile_pic" id="mobile_pic" value="${mobile.mobile_pic}"/>
                <input type="file" onchange="setImg(this)"></td>
        </tr>
    </table>
        <input type="submit" value="修改">
    </form>
    <h2>${msg}</h2>
</div>
<script src="/jquery-1.12.4.min.js"></script>
<script type="text/javascript">
    function setImg(obj) {
        var f = $(obj).val();
        alert(f);
        if (f == null || f == undefined || f == '') {
            return false;
        }
        if (!/\.(?:png|jpg|bmp|gif|PNG|JPG|BMP|GIF)$/.test(f)) {
            alert("类型必须是图片(.png|jpg|bmp|gif|PNG|JPG|BMP|GIF)");
            $(obj).val('');
            return false;
        }
        var data = new FormData();
        $.each($(obj)[0].files, function (i, file) {
            data.append('file', file);
        });
        console.log(data);
        $.ajax({
            type: "POST",
            url: "/UploadPicImgServlet",
            data: data,
            cache: false,
            contentType: false,    //不可缺
            processData: false,    //不可缺
            dataType:"json",
            success:function(resData){
                console.log(123)
                console.log(resData)
            },
            error:function(result){
                $("#myImg").attr('src',"/image/"+result.responseText);
                $("#mobile_pic").val(result.responseText);
            }
        });
        alert("上传成功")
    }
</script>
</body>
</html>
```

#### 演示效果

![1558453939209](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1558453939209.png)

### 修改商品信息

#### 代码：

##### UpdateMobileServlet.java

```java
package myservlet.admin;

import dao.ClassDao;
import dao.MobileDao;
import pojo.Mobile;
import pojo.MobileClassify;
import pojo.User;
import utils.BeanHandler;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.util.List;

@WebServlet("/UpdateMobileServlet")
public class UpdateMobileServlet extends HttpServlet {
    private MobileDao mobileDao=new MobileDao();

    @Override
    protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        doGet(request,response);
    }

    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        request.setCharacterEncoding("utf-8");
        try {
            Mobile mobile = BeanHandler.getParametersToBean(Mobile.class, request);
            System.out.println(mobile);
            mobileDao.updateMobile(mobile);
            request.setAttribute("msg","修改成功");
            request.getRequestDispatcher("/admin/updateMobileUI.jsp").forward(request,response);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

#### 效果演示

![1558454053526](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1558454053526.png)

![1558454188645](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1558454188645.png)

### 新增商品页面跳转

#### 代码：

##### addMobileUIServlet.java

```java
package myservlet.admin;

import dao.ClassDao;
import pojo.MobileClassify;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.util.List;

@WebServlet("/addMobileUIServlet")
public class addMobileUIServlet extends HttpServlet {
    private ClassDao classDao=new ClassDao();

    @Override
    protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        doGet(request,response);
    }

    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        try{
            List<MobileClassify> mobileClassifies = classDao.getMobileClassifies();
            request.setAttribute("classes",mobileClassifies);
            request.getRequestDispatcher("/admin/addMobileUI.jsp").forward(request,response);
        }catch (Exception e){
            e.printStackTrace();
        }
    }
}
```

##### addMobileUI.jsp

```jsp
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%--
  Created by IntelliJ IDEA.
  User: Hpsyche
  Date: 2019/5/16
  Time: 23:55
  To change this template use File | Settings | File Templates.
--%>
<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<html>
<head>
    <title>Title</title>
</head>
<body>
<div id="left"><%@ include file="leftTree.jsp" %></div>
<div id="right">
    <h1>新增手机信息</h1>
    <form method="post" action="/AddMobileServlet">
        <table>
            <%--<tr>--%>
                <%--<td>手机编号</td>--%>
                <%--<td><input type="text" readonly="readonly" value="${mobile.mid}" name="mid"></td>--%>
            <%--</tr>--%>
            <tr>
                <td>手机所属类别</td>
                <td>
                    <select name="id">
                        <c:forEach items="${classes}" var="classItem">
                            <option value="${classItem.id}" id="${classItem.id}">${classItem.name}</option>
                        </c:forEach>
                    </select>
                </td>
            </tr>
            <tr>
                <td>手机型号</td>
                <td><input type="text" name="mobile_version"/></td>
            </tr>
            <tr>
                <td>手机名称</td>
                <td><input type="text" name="mobile_name"/></td>
            </tr>
            <tr>
                <td>手机制造商</td>
                <td><input type="text" name="mobile_made"/></td>
            </tr>
            <tr>
                <td>手机价格</td>
                <td><input type="text" name="mobile_price"/></td>
            </tr>
            <tr>
                <td>手机详情</td>
                <td><input type="text" name="mobile_mess"/></td>
            </tr>
            <tr>
                <td>手机照片</td>
                <td>
                    <input type="hidden" name="mobile_pic" id="mobile_pic" value="${mobile.mobile_pic}"/>
                    <input type="file" onchange="setImg(this)"></td>
            </tr>
        </table>
        <input type="submit" value="新增">
    </form>
    <h2>${msg}</h2>
</div>
</body>
<script src="/jquery-1.12.4.min.js"></script>
<script type="text/javascript">
    function setImg(obj) {
        var f = $(obj).val();
        if (f == null || f == undefined || f == '') {
            return false;
        }
        if (!/\.(?:png|jpg|bmp|gif|PNG|JPG|BMP|GIF)$/.test(f)) {
            alert("类型必须是图片(.png|jpg|bmp|gif|PNG|JPG|BMP|GIF)");
            $(obj).val('');
            return false;
        }
        var data = new FormData();
        $.each($(obj)[0].files, function (i, file) {
            data.append('file', file);
        });
        console.log(data);
        $.ajax({
            type: "POST",
            url: "/UploadPicImgServlet",
            data: data,
            cache: false,
            contentType: false,    //不可缺
            processData: false,    //不可缺
            dataType:"json",
            success:function(resData){
                console.log(123)
                console.log(resData)
            },
            error:function(result){
                $("#mobile_pic").val(result.responseText);
            }
        });
        alert("上传成功")
    }
</script>
</html>
```

#### 效果演示

![1558454339934](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1558454339934.png)

![1558454385338](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1558454385338.png)

### 修改商品

#### 代码：

##### DeleteMobileServlet.java

```java
package myservlet.admin;

import dao.MobileDao;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;

@WebServlet("/DeleteMobileServlet")
public class DeleteMobileServlet extends HttpServlet {
    private MobileDao mobileDao=new MobileDao();
    @Override
    protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        doGet(request,response);
    }

    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        Integer mid = Integer.valueOf(request.getParameter("mid"));
        try {
            mobileDao.deleteMobileById(mid);
            request.setAttribute("msg","删除成功");
            request.getRequestDispatcher("/admin/msg.jsp").forward(request,response);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

### 显示所有订单

#### 代码：

##### ShowAllOrdersServlet.java

```java
package myservlet.admin;

import dao.ClassDao;
import dao.MobileDao;
import dao.OrderDao;
import pojo.Mobile;
import pojo.MobileClassify;
import pojo.Order;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.util.List;

@WebServlet("/ShowAllOrdersServlet")
public class ShowAllOrdersServlet extends HttpServlet {
    private OrderDao orderDao=new OrderDao();

    @Override
    protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        doGet(request,response);
    }

    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        //获取记录条数
        int count=0;
        try {
            //获得类别
            Integer page = Integer.valueOf(request.getParameter("page"));
            List<Order> orderList = null;
            count = orderDao.showOrdersCount();
            orderList = orderDao.showAllOrdersByPage(page);
            request.setAttribute("count", count);
            request.setAttribute("orders", orderList);
            request.setAttribute("page", page);
            request.getRequestDispatcher("/admin/showallorders.jsp").forward(request, response);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

##### showallorders.jsp

```jsp
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%--
  Created by IntelliJ IDEA.
  User: Hpsyche
  Date: 2019/5/17
  Time: 0:53
  To change this template use File | Settings | File Templates.
--%>
<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<link rel="stylesheet" type="text/css" href="/admin/showUsers.css"/>
<html>
<head>
    <title>Title</title>
</head>
<div id="left"><%@ include file="leftTree.jsp" %></div>
<div id="right">
    <h1>显示所有订单</h1>
    <form action="/ShowAllMobilesServlet?page=1" method="post">
    </form>
    <table class="datalist">
        <tr>
            <th>订单id</th>
            <th>订单用户名</th>
            <th>订单信息</th>
            <th>订单总价</th>
            <th>订单状态</th>
            <th>修改</th>
            <th>删除</th>
        </tr>
        <c:forEach items="${orders}" var="order">
            <tr>
                <td>${order.id}</td>
                <td>${order.logname}</td>
                <td>${order.mess}</td>
                <td>${order.sum}</td>
                <td>
                    <c:if test="${order.status eq 1}">
                        未付款
                    </c:if>
                    <c:if test="${order.status eq 2}">
                        已付款
                    </c:if>
                    <c:if test="${order.status eq 3}">
                        已发货
                    </c:if>
                    <c:if test="${order.status eq 4}">
                        已确认收货
                    </c:if>
                </td>
                <td>
                    <c:if test="${order.status eq 1}">
                        <input type="button" value="待付款" disabled="disabled"/>
                    </c:if>
                    <c:if test="${order.status eq 2}">
                        <input type="button" value="点击发货" onclick='updateMobileStatus(${order.id})'/>
                    </c:if>
                    <c:if test="${order.status eq 3}">
                        <input type="button" value="待收货" disabled="disabled"/>
                    </c:if>
                    <c:if test="${order.status eq 4}">
                        <input type="button" value="交易结束"  disabled="disabled"/>
                    </c:if>
                </td>
                <td><input type="button" value="删除" onclick='deleteMobile(${order.id})'></td>
            </tr>
        </c:forEach>
    </table>
    <input type="button" value="上一页" onclick="prePage()">
    第${page}页/共${count}页
    <input type="button" value="下一页" onclick="nextPage()">
</div>
<body>

</body>
<script type="text/javascript">
    function prePage() {
        var page=${page};
        if(page==1){
            return;
        }
        window.location.href = '/ShowAllOrdersServlet?page=' + (page - 1);
    }
    function nextPage() {
        var page=${page};
        var count=${count};
        if(page+1>count){
            return;
        }
        window.location.href = '/ShowAllOrdersServlet?page=' + (page + 1);
    }
    function updateMobileStatus(oid) {
        var msg="确定发货吗";
        if (confirm(msg)==true){
            window.location.href="/UpdateOrderStatusServlet?oid="+oid+"&status="+3;
        }else{
            return false;
        }
    }
    function deleteMobile(oid) {
        var msg="确定删除吗";
        if (confirm(msg)==true){
            window.location.href="/DeleteOrderServlet?oid="+oid;
        }else{
            return false;
        }
    }
</script>
</html>
```

#### 效果演示

![1558454569065](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1558454569065.png)

### 修改订单状态（即发货）

#### 代码：

##### UpdateOrderStatusServlet.java

```java
package myservlet.admin;

import dao.OrderDao;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;

@WebServlet("/UpdateOrderStatusServlet")
public class UpdateOrderStatusServlet extends HttpServlet {
    private OrderDao orderDao=new OrderDao();
    @Override
    protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        doGet(request,response);
    }

    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        try {
            Integer oid = Integer.valueOf(request.getParameter("oid"));
            Integer status = Integer.valueOf(request.getParameter("status"));
            orderDao.updateOrderStatusByOid(oid,status);
            if(status==3) {
                request.setAttribute("msg", "发货成功");
                request.getRequestDispatcher("/admin/msg.jsp").forward(request, response);
            }
            if(status==4||status==2){
                request.getRequestDispatcher("/lookOrderForm.jsp").forward(request, response);
            }
        }catch (Exception e){
            e.printStackTrace();
        }
    }
}
```

![1558454685595](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1558454685595.png)

### 删除订单

#### 代码：

##### DeleteOrderServlet.java

```java
package myservlet.admin;

import dao.OrderDao;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;

@WebServlet("/DeleteOrderServlet")
public class DeleteOrderServlet extends HttpServlet {
    private OrderDao orderDao=new OrderDao();
    @Override
    protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        doGet(request,response);
    }

    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        try {
            Integer oid = Integer.valueOf(request.getParameter("oid"));
            orderDao.deleteOrderByOid(oid);
            request.setAttribute("msg","删除成功");
            request.getRequestDispatcher("/admin/msg.jsp").forward(request,response);
        }catch (Exception e){
            e.printStackTrace();
        }
    }
}
```

# 心得体会

本次实验前后耗费了自己近两天的时间，前台系统由于老师已经给出代码，故调试起来比较顺利，改下数据库即一些细节即可；在后台系统的操作中，发现了老师提供的前台系统的一些问题：

* 一些表中没有主键user表中没有uid，并不符合正常的数据库建表习惯，在“编辑”，“删除”用户时传字段不方便，最终自己在数据库新建了id字段，并重新改前台页面的部分代码；

* 订单表中缺乏status字段，后台系统无法对订单状态进行管理，故我在数据库中增加了status字段，并有：“1.未付款2.已付款3.已发货4.已确认收货”；当用户生成订单时，默认生成的satus为1，而在查看订单时，有如下：

  ![1558455443152](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1558455443152.png)

  用户可以点击“去付款”，此时订单的satus变为2；

  在后台系统中，管理员可以“点击发货”，satus变为3；最终用户在前台系统点击“确认收货”时，satus变为4，以此完成对订单的管理。

除了以上问题的发现与解决外，我也有以下的几点体会：

* 如果按照正常的request.getParameter("XXX")，会造成大量的冗余代码，故自己封装了一个utils类，其实网络上也有不少这样的包，不过我想自己实现一下，检验自己的基础知识，故通过java的反射机制实现了对Parameter的封装，通过getParametersToBean将参数直接转为Bean对象，即可省去大量取参的代码；同理，在对数据库的resultSet的处理上，我也利用了反射机制，将resultSet封装至bean对象；
* 在获取数据库的连接上，我使用了懒汉式单例，并同步化，以处理多线程环境，封装了一个utils类，在dao层都是用此来获取连接，减少系统资源开销 ；
* 由于对图片上传不太熟悉，在上传手机图片中遇到了一些阻碍，在网上搜索后，结合自己的项目情况，得以解决；

此次实验项目并不大，只是一个较为基础的小商城，但我在其中也学到了很多，也巩固复习了自己的基础知识，希望以后自己能做得更好。


