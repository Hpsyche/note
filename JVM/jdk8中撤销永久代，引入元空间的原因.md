# 前言

## 永久代和方法区的区别

### 方法区

方法区（Method Area）是jvm规范里面的运行时数据区的一个组成部分。

方法区存储东西？

主要用来存储class、运行时常量池、字段、方法、代码、JIT代码等。

注意：

（1）运行时数据区跟内存不是一个概念。

（2）方法区是运行时数据区的一部分

（3）方法区是jvm**规范**中的一部分，并不是实际的实现，切忌将规范跟实现混为一谈。

### 永久代

永久带又叫Perm区，只存在于hotspot jvm中，并且只存在于jdk7和之前的版本中，jdk8中已经彻底移除了永久带，jdk8中引入了一个新的内存区域叫metaspace。

（1）并不是所有的jvm中都有永久带，ibm的j9，oracle的JRocket都没有永久带。

（2）永久带是**实现**层面的东西。

（3）永久带里面存的东西基本上就是方法区规定的那些东西。

（4）永久代的垃圾回收和老年代的垃圾回收是绑定的，一旦其中一个区域被占满，这两个区都要进行垃圾回收。

因此，我们可以说，**永久带是方法区的一种实现**，当然，在hotspot jdk8中metaspace可以看成是方法区的一种实现。

### 结论

1. 方法区是规范层面的东西，规定了这一个区域要存放哪些东西
2. 永久带或者是metaspace是对方法区的不同实现，是实现层面的东西。
3. **方法区（method area）**只是**JVM规范**中定义的一个概念，用于存储类信息、常量池、静态变量、JIT编译后的代码等数据，具体放在哪里，不同的实现可以放在不同的地方。而**永久代**是**Hotspot**虚拟机特有的概念，是方法区的一种实现，别的JVM都没有这个东西。

## jdk1.8的改变

在 JDK 1.8 中，HotSpot 已经没有 “PermGen space”这个空间了，取而代之是一个叫做 Metaspace（元空间） 的东西。

Java7中已经将字符串常量池从永久代移除，在Java 堆（Heap）中开辟了一块区域存放字符串常量池。而在Java8中，已经彻底没有了永久代，**将方法区直接放在一个与堆不相连的本地内存区域，这个区域被叫做元空间。 **（注意：将方法区放至元空间，即此时方法区的实现变为元空间了）。

### 永久代为什么被移出HotSpot JVM了？

1、**由于Permanent Generation内存经常不够用或发生内存泄露，引发恼人的java.lang.OutOfMemoryError: PermGen （在Java Web开发中非常常见）**。

permSize：原来的jar包及你自己项目的class存放的内存空间，这部分空间是固定的，启动参数里面-permSize确定（它的大小是在启动时固定好的——很难进行调优），如果你的jar包很多，经常会遇到permSize溢出，且每个项目都会占用自己的permGen空间。

改成metaSpaces，各个项目会共享同样的class内存空间，比如两个项目都用了fast-json开源包，在mentaSpaces里面只存一份class，提高内存利用率，且更利于垃圾回收

2、**移除Permanent Generation可以促进HotSpot JVM与JRockit VM的融合，因为JRockit没有永久代。**

3、**对永久代进行调优是很困难的。 **

（由于方法区主要存储类的相关信息，所以对于动态生成类的情况比较容易出现永久代的内存溢出。最典型的场景就是，在 jsp 页面比较多的情况，容易出现永久代内存溢出。）

### 为什么要引入元空间：

1、字符串存在永久代中，容易出现性能问题和内存溢出。

2、类及方法的信息等比较难确定其大小，因此对于永久代的大小指定比较困难，太小容易出现永久代溢出，太大则容易导致老年代溢出。

3、永久代会为 GC 带来不必要的复杂度，并且回收效率偏低。

#### 使用本地内存的优点

OOM问题将不复存在，因为默认的类的元数据分配只受本地内存大小的限制。
不过应该适当限制 Metaspace 的大小: 使用 `-XX:MaxMetaspaceSize` 参数来指定 Metaspace 区域的大小. JVM 默认在运行时根据需要动态地设置 MaxMetaspaceSize 的大小.

**如果Metaspace的空间占用达到了设定的最大值，那么就会触发GC来收集死亡对象和类的加载器。**根据JDK8的特性，G1和CMS都会很好地收集Metaspace区（一般都伴随着Full GC）。

为了减少垃圾回收的频率及时间，控制吞吐量，对Metaspace进行适当的监控和调优是非常有必要的。如果在Metaspace区发生了**频繁的Full GC**，那么可能表示存在**内存泄露**或Metaspace区的**空间太小**了。