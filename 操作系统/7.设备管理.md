# I/O管理概述

## I/O管理的功能

I/O管理软件的层次结构。组成I/O软件的各个程序按照其功能划分成若干个层次，**与用户程序相关的部分在最高层**，而**直接与I/O硬件相关的部分，如中断处理程序在最底层**。

I/O管理的主要功能：

* 监视设备的状态

* 进行设备分配

* 完成I/O操作，尽量实现设备与CPU、设备与设备之间的并行

* 缓冲管理

  （解决高速低速之间问题）CPU的执行速度和访问内存的速度都比较高，而I/O设备的数据传输速度则低得多。为了解决这种设备与CPU速度不匹配的问题，系统一般都设有缓冲区来暂存数据。

##  I/O硬件组成

I/O系统的结构分为 微机I/O系统和主机I/O系统

### 微机I/O系统

微机I/O系统多采用单总线结构；

总线结构：如果计算机中有一个或多个设备使用一组共同的线，那么这种连接称为总线结构。

### 主机I/O系统

主机I/O系统中不采用总线结构，而是增加一级I/O通道，用以代替主机与各个设备控制器进行通信，并实现对它们的控制。

## I/O设备

按设备进行信息交换的单位,I/O设备可以分成块设备和字符设备。

### 块设备

<font color=red>块设备：以块为传输单位，可寻址的高速存储设备。</font>

块设备也称存储设备，是计算机中用来存储信息的主要设备（以块为传输单位）。虽然它们的存储速度比内存慢，但比内存的容量大得多，相对价格也便宜，尤其是磁盘。

**磁盘的特征之一是可寻址。磁盘的特征还有磁盘的传输速度比较高，磁盘的输入输出一般采用<font color=red>DMA方法。</font>**

### 字符设备

<font color=red>字符设备：以字符为传输单位，不可寻址、中低速的设备；</font>

字符设备也称为I/O设备，用于数据的输入和输出。由于I/O设备上的信息是以字符为单位组织的，故称为字符设备。

字符设备属于无结构设备，基本特征是不可寻址、传输速度低。字符设备在输入输出时常采用中断方式。



按设备的共享属性又可以把I/O设备分为独占设备、共享设备和虚拟设备。

### 独占设备

一段时间内只允许一个进程访问的设备

### 共享设备

允许多个进程同时访问的设备

### 虚拟设备

通过虚拟技术将一台独占设备变换成的若干个设备，可供多个进程同时使用

## 设备控制器

**接收CPU发来的命令，并控制I/O设备工作。**

### 设备控制器的组成

* 设备控制器与CPU的接口
* 设备控制器与设备的接口
* I/O逻辑

## 设备通道

虽然在CPU与设备之间增加了设备控制器，以能大大减少CPU的干预，但当计算机配置的外设很多时，CPU的负担仍然很重。为此，在许多计算机系统中配置了通道，其目的就是建立独立的I/O操作，使CPU从繁重的I/O中解放出来。**（通道：独立于CPU，专门负责I/O设备的传输）**

<font color=blue>通道实际上是一个特殊的处理机，它具有执行I/O指令的能力，并通过执行通道程序来控制I/O操作。但通道又与一般的处理机有所不同，主要表现在以下两个方面：</font>

* <font color=blue>通道指令类型单一</font>
* <font color=blue>通道内没有自己的内存。通道执行的指令一般放在其主机的内存中</font>

### 通道与设备的连接

* 单通路
* 多通路

在单通路中，当在启动某个设备时，其占有了该通道和控制器；则此时其他设备无法启动，必须等待；

解决该问题的方法是采用**多通路连接，**增加设备到主机之间的通路，而不增加通道或控制器。换言之，就是把一个设备连接到多个控制器上；而一个控制器又被连接到多个通道上。



# I/O控制方式

## I/O功能的发展

* CPU直接控制外设，早期的计算机系统和微处理系统中比较常见。

* 有了控制器和I/O模块，但CPU使用<font color=red>没有中断的程序</font>控制I/O。

* 采用<font color=red>中断控制方式</font>，CPU不浪费时间等待I/O操作的完成。

* 采用<font color=red>DMA控制方式</font>，内存和设备间传输一块数据的开始和结束时才需要CPU的干预。

* 采用<font color=red>通道控制方式</font>，通道独立实现控制I/O的完成，不需要CPU的参与。

​       越来越多的I/O都可以在没有主机控制的情况下进行，CPU从I/O任务中解脱出来，从而提供了性能，减少了主机对I/O控制的干预。

## 程序直接控制方式

程序直接控制方式就是由用户进程直接控制CPU与外设之间的信息传送。

程序直接控制方式实现简单，也不需要硬件的支持，但它明显存在以下缺点：

* CPU与外设之间只能串行工作，这使得CPU的利用率大大降低；
* CPU在一段时间内只能与一台外设交换数据信息，因此各台外设之间也是串行工作；
* 由于程序直接控制方式是依靠测试设备的状态来控制数据的传送，因此无法发现和处理由于设备和其他硬件所产生的错误。

（程序直接控制方式只适用于那些CPU执行速度较慢且外设较少的系统）

## 中断控制方式

此时CPU与设备控制器之间有相应的中断请求线，设备控制器的控制/状态寄存器中有相应的中断允许位。

CPU向设备控制器发出I/O命令后，转去执行其它任务，当I/O操作完成后，CPU接收控制器发来的中断信号，再去处理相应数据。

因此，**CPU与设备可以并行工作**，使CPU的利用率大大提高，并且能支持多道程序和设备的并行工作。

缺点：

* 设备控制器的数据寄存器装满数据后发生中断
* 计算机中通常配置各种各样的外设，如果这些外设都通过中断的方式进行数据传送，则会由于中断次数的急剧增加造成CPU无法及时响应中断，出现数据丢失现象。

采用中断方式，CPU是以字节为单位进行干预的，如果将这种方式用于块设备的I/O，效率低下。如，为了从磁盘中读出1KB的数据，需要中断1024次CPU。

## DMA控制方式

DMA（Direct Memory Access）直接存储器访问

DMA控制器包含以下三部分：主机与DMA控制器的接口、I/O控制逻辑和DMA控制器与设备之间的接口。

特点：

* 数据传输的基本单位是数据块，即CPU与I/O设备之间每次传送一个数据块的数据
* 所传送的数据是从设备直接到内存或者从内存直接到设备
* 仅在传送数据块的开始和结束时需要CPU的干预，整块数据的传送是在控制器的控制之下完成的

 在DMA方式中，每发出一个I/O指令，能传送一个连续的数据块，当需要一次去读多个离散的数据块且将它们分别传送到不同的内存区域时，则需多条I/O指令和多次中断才能完成。

仅在传送一个或多个数据块的开始和结束时，才需CPU干预，整块数据的传送是在控制器的控制下完成的。

**因此，引入通道控制方式，可以进一步减少CPU对I/O操作的干预！**

## 通道控制方式

I/O通道方式是DMA方式的发展，把以数据块为单位的干预，减少到**对一组数据块为单位的干预。**

通道：通道是一种通过执行通道程序管理I/O操作的控制器，它使主机与I/O操作之间达到更高的并行程度。



# I/O系统

I/O系统分为以下几个层次：

* I/O接口
* I/O管理软件
* 设备驱动程序
* 中断处理程序

## 设备分配

### 设备的固有属性

* 独占设备
* 共享设备
* 虚拟设备

### 设备分配的安全性

* 安全分配方式
* 不安全分配方式

### 设备的独立性（无关性）

为了实现设备的独立性，引入了逻辑设备和物理设备两个概念。

操作系统具有将逻辑设备名转换成物理设备名的功能。

#### 实现逻辑设备名的好处

* 增加了设备分配的灵活性
* 易于实现I/O重定向

#### 逻辑设备表

为了实现设备的独立性，系统必须能够将用户程序中所使用的逻辑设备名转换成物理设备名，为此需要设置一张逻辑设备表，该表的每一个表目包含逻辑设备名、物理设备名和设备驱动程序的入口地址。

## SPOOLing技术

利用一个进程来模拟脱机输入时外围计算机的功能，把低速I/O设备上的数据传送到高速的磁盘上；再用一个进程模拟脱机输出时外围计算机的功能，把数据从磁盘传送到低速I/O设备上。此时，输入输出操作与CPU对数据的处理同时进行，这种**在联机情况下实现的输入输出与CPU的工作并行的操作称为SPOOLing或假脱机操作，**SPOOLing技术是将一台独占设备改造成共享设备的一种行之有效的技术。

SPOOLing通常有以下三部分组合：

* 输入井和输出井
* 输入缓冲区和输出缓冲区
* 输入进程和输出进程

### <font color=red>实现原理</font>

 预输入程序将输入设备输入的数据读入到磁盘输入井上。
 用户进程需要输入数据时，直接从输入井读入即可。
 用户进程需要输出数据时，直接写出到输出井即可。
 预输出程序从输出井中取走数据送给输出设备进行输出。

 ![](D:\Work\TyporaNotes\note\操作系统\pict\SPOOLing技术的实现原理.png)

### SPOOLing系统的特点

* 提高了I/O速度（磁盘：高速；打印机：低速）
* 将独占设备改造成共享设备（磁盘：独占；打印机：共享）
* 实现了虚拟设备功能（磁盘空间虚拟成打印机设备） 

### <font color=red>SPOOLing技术的应用实例</font>

共享打印机是SPOOLing 技术应用的典型实例，它将一台打印机改造为可供多个用户共享的设备 。

* 当用户进程请求打印输出时，SPOOLing系统响应请求，由预输出进程在输出井中申请一个空闲区，将要打印的数据送出到输出井；

* 为用户进程申请一张空白的用户请求打印表，填入打印请求，然后将该表链接到请求打印队列尾。

* 若继续有进程请求打印输出，系统继续响应请求，用户的感觉是都能分配到打印机。 

## 设备驱动程序

### 特点

* 设备驱动程序的突出特点是，它与设备控制器和I/O设备的硬件特性紧密相关。 
* 与I/O设备所采用的I/O控制方式紧密相关。（常用的I/O控制方式是中断驱动和DMA方式）
* 允许可重入（一个正在运行的驱动程序常会在一次调用完成前被再次调用）
* 可以动态加载

## 中断处理程序

### 中断的基本概念

中断：计算机在执行进程期间，系统内发生急需处理的事件，使CPU暂停正在执行的程序转去执行相应的事件处理程序，处理完后再返回原来被中断处继续执行或调度新的进程执行。

中断源：引起中断发生的事件称为中断源。

### 中断的分类

根据中断源产生的条件，可以把中断分为内中断和外中断。

* 外中断

**外中断：来自处理机和内存外部的中断**。它包括I/O设备发出的I/O中断、外部信号中断、各种定时器引起的时钟中断、调试程序中设置的断点、……

* 内中断

**内中断：在CPU和内存内部产生的中断。**程序运算引起的各种错误、分时系统中的时间片到、从用户态到核心态的切换、……



# 磁盘管理

## 提高磁盘I/O速度的主要途径

* 选择性能好的磁盘
  * 数据的组织
  * 磁盘的类型
  * 磁盘访问时间
* 采用好的磁盘调度技术
* 设置磁盘高速缓冲区

## 磁盘调度

为了提高性能，要减少花费在寻道上的时间。

### 先来先服务（FCFS）

<font color=red>**平均寻道时间最少**</font>

该算法公平，简单，且每个进程的请求都一次得到处理，不会出现某一进程的请求长期得不到处理的情况。

但平均寻道时间较长。仅适用于磁盘I/O的进程数目较少的场合。

### 最短寻道时间优先（SSTF）

选择离当前磁头所在的磁道距离最近的磁道，以使每次寻道时间最短。

<font color=red>**但该算法容易产生“饥饿”现象。**</font>

### 扫描算法（SCAN）

不仅考虑要访问的磁道与当前磁头所在磁道的距离，更优先考虑的是磁头的当前移动方向。 选择在当前磁头**移动方向上**离当前磁道最近的磁道访问，**<font color=red>也被称为电梯算法</font>**。

该算法优先考虑当前磁头的移动方向，<font color=red>**能防止“饥饿”现象，但可能会出现某进程请求被大大延迟的现象**</font>。

### 循环扫描算法C-SCAN

对SCAN进行改造，解决进程严重延迟现象。**规定磁头单方向移动**，将最小磁道号紧接着最大磁道号构成循环，进行循环扫描。



# 缓冲管理

缓冲：缓冲是在两个不同速度设备之间传输信息时，用于平滑传输过程的一种手段。

在操作系统中引入缓冲的目的：

* 缓解CPU与I/O设备之间速度不匹配的矛盾
* 减少中断CPU的次数
* 提高CPU与I/O设备之间的并行性

## 缓冲

* Cache
* I/O设备或控制器内部的纯硬件缓冲区
* **内存开辟的缓冲区**
* 脱机I/O技术和SPOOLing技术也属于缓冲技术

### 单缓冲

单缓冲是当用户发出I/O请求时，操作系统在主存中为其分配一缓冲区；

当块设备使用单缓冲时，要读取磁盘上的某块数据，首先从磁盘把数据送入内存缓冲区，其所花费的时间为T；然后由操作系统将缓冲区的数据送入用户区，花费的时间为M；接着，CPU对数据进行处理，其所花费的时间为C；则系统对整块数据的处理时间为max(C,T)+M     （此时T与C并行，通常M远小于T或C）；

如果不使用缓冲区，数据直接进入用户区，则一块数据的处理时间为T+C（此时T与C串行），因此使用缓冲技术可以提高处理I/O请求的速度。

![](D:\Work\TyporaNotes\note\操作系统\pict\单缓冲.png)

### 双缓冲

当设备使用双缓冲时，先将数据输入第一个缓冲区，装满后输入第二个缓冲区，在向第二个缓冲区送数据的同时，CPU对第一个缓冲区中的数据进行计算。

因此在有双缓冲区的情况下，系统处理一块数据的时间为max(C,T)。如果C<T，块设备连续输入，CPU有段时间的等待；如果C>T，CPU就不必等待设备输入。

![](D:\Work\TyporaNotes\note\操作系统\pict\双缓冲.png)

对于字符设备输出，如果使用双缓冲，先将第一行数据送入缓冲区1，装满后在字符设备上输出。在输出缓冲区1内容的同时，又向缓冲区2送入第二行数据。缓冲区1的内容在设备上输出完毕后，缓冲区2也刚好输入了数据，如此用户进程就不必阻塞，CPU与字符设备完全并行地工作。

### 循环缓冲

当输入、输出的速度基本相匹配时，可使用双缓冲，**但若两者的速度相差甚远，即双缓冲的效果就不会太理想**，此时可使用多缓存。

引入多缓冲机制，将多个缓冲区组织成环形。循环缓冲的典型应用是“生产者—消费者”问题。

### 缓冲池

<font color=blue>*前面所讲述缓冲区是为特定的通信双方进程设置的，属于专用资源。若系统中有大量专属缓冲区，会消耗大量空间，利用率也不高。为此，引入缓冲池机制。*</font>

缓冲池是包含了一个管理的数据结构及一组操作函数的管理机制，**用于管理多个缓冲区。这些缓冲区可被所有进程共享。**

#### 缓冲池组成

缓冲池是由如下所述3个缓冲区链队列组成的

* 空缓冲区队列emq，由系统中所有的空闲缓冲区链成
* 输入队列inq，由装满输入数据的缓冲区链成
* 输出队列outq，由装满输出数据的缓冲区链成

#### 缓冲池队列操作

对3个队列的操作是类似的，主要有两个操作：

* AddBuf(Type,number)：将一个由number指向的缓冲区挂在某个队列Type上；
* TakeBuf(Type)：从Type指示的某个队列上摘下一个缓冲区



# 例题

**数据传输控制方式有哪几种？试比较它们的优缺点。**

数据转送控制方式有程序直接控制方式、中断控制方式、 DMA 控制方式和通道方式四种。

* 程序直接控制方式  

优点：实现简单，不需要硬件的支持；
缺点：CPU与外设只能串行工作 ; CPU在一段时间内只能与一台外设交换数据信息；由于程序直接控制方式是依靠测试设备的状态来控制数据传递的，因此无法发现和处理由于设备和其他硬件所产生的错误。

* 中断控制方式 

优点：提高了 CPU的利用率；
缺点：在进程传送数据的过程中，发生中断的次数可能很多，这将消耗 CPU大量处理时间；计算机中通常配置各种各样的外设，如果这些外设都通过中断的方式进行数据传递，由于中断次数过多将使 CPU无法及时响应中断，造成数据丢失。

* DMA 控制方式

优点：数据传输的基本单位为数据块；仅在开始和结束才需要 CPU干预，整块数据的传送是在控制器的控制之下完成的；所传送的数据是从设备直接到内存或者从内存直接到设备。
缺点：DMA方式对外设的管理和操作仍由CPU控制；多个DMA同时使用显然会引起内存地址的冲突并使得控制过程进一步复杂化。

* 通道方式

优点：把对一个数据块的读 （写）干预减少到对一组数据块的读 （写）干预；实现CPU、通道及I/O设备三者的秉性工作，从而更有效地提高整个系统的资源利用率。



# 课堂习题

![](https://github.com/Hpsyche/note/blob/master/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pict/第七章课后习题1.png)

![](https://github.com/Hpsyche/note/blob/master/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pict/第七章课后习题2.png)

![](https://github.com/Hpsyche/note/blob/master/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pict/第七章课后习题3.png)
