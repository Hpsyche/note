# 文件概述

文件管理最基本目标：实现按名存取（通过目录）

文件时具有文件名的一组相关数据的集合。

文件可分为有结构文件和无结构文件两种。有结构文件由若干个相关记录组成，无结构文件则被看成是字符流的集合。

有些文件系统区分大小写，有些则不区分。如UNIX操作系统区分大小写，而MS-DOS则不区分。

## 文件类型

### 按文件的用途分类

* 系统文件

有操作系统软件构成，包括系统内核、系统管理程序

* 用户文件

用户有自己的文件，如用户的源程序文件、可执行程序文件或文档资料

* 库文件

由标准的子程序及非标准的子程序构成。标准的子程序通常称为系统库，提供对系统内核的访问。而非标准的子程序则是满足特定应用的库。库文件一般有两种形式，即动态链接库和静态链接库。

### 按文件的性质分类

* 普通文件
* 目录文件
* 特殊文件

### 按文件的存取属性分类

* 只执行文件
* 只读文件
* 读/写文件

### 按文件数据的形式分类

* 源文件
* 目标文件
* 可执行文件

## 文件的操作

### 对文件记录的操作

* 检索记录
* 插入记录
* 修改记录
* 删除记录

### 对文件自身的操作

## 文件访问方式

### 顺序访问

文件信息按顺序，一个记录接着一个记录地得以处理。这种访问方式最为常见。

对文件的大量的操作是读/写。

### 直接访问

直接访问也称为对文件的随机存取，它是磁盘文件的访问模式。一般每次存取的单位是固定的，称为块。

随机存取方式主要用于大批量信息的直接访问，如大型数据库的访问。

进行随机存取时，先要设置读/写指针的位置，然后使用系统提供的专门的操作命令从该位置开始读/写文件。

随机方式读/写文件都以块号为参数，该块号是文件的相对块号，即相对文件开头的索引。而该块在磁盘上的物理块号由操作系统根据磁盘空间的具体使用情况动态分配。



# 文件结构和文件系统

## 文件结构

文件的逻辑结构：从用户角度所看到的文件形式

文件的物理结构：文件在外存的存储方式以及它与文件逻辑之间的对应关系

### 无结构文件

无结构文件也称流式文件。现代操作系统普遍采用。

把文件看成字符流，为操作系统带来了灵活性，用户可以根据需要在自己的文件中加入任何内容，不用操作系统提供任何额外的帮助。

### 有结构文件

有结构文件也称记录式文件。

### 树形文件

树形文件是有结构文件的一种特殊形式。

## 有结构文件的组织

### 顺序文件

**顺序文件是最常用的一种文件组织形式，适用于顺序存储设备<font color=red>（磁带）</font>**

在这种文件中，每个记录都使用一种固定的格式，所有记录都具有相同的长度，并且由相同数目，长度固定的数据项构组成。

由于每个数据项的长度和位置是已知的，因此只需要保存各个数据项的值，每个数据项的名字和长度是该文件结构的属性。

为了方便文件的查找，在顺序文件中通常指定一个或几个数据项作为关键字。关键字能唯一地标识一个记录，因此，不同记录的关键字的值时不同的。一般地，记录是按关键字值的某种顺序存储的。

顺序文件的最佳应用场合是对记录进行批量存取时。

缺点：

* 用户要求查找或更新某个记录时，系统要逐个地查找每个记录，顺序文件表现出的性能可能很差，尤其当文件较大时，情况更为严重。
* 增加或修改一个记录比较困难。（解决方案：为顺序文件配置一个日志文件或事务文件。通过周期性地执行一个成批的更新，把日志文件或事务文件合并到主文件中，并按正确的关键字顺序产生一个新文件）

### 索引文件

顺序文件只能基于关键字进行查询，当需要基于其他数据项搜索一个记录时，顺序文件就不能胜任。此时可以采用索引文件。

索引文件就是为每一种可能成为搜索条件的数据项建立一张索引表。**只适用于<font color=red>磁盘</font>，能进行顺序存取，也能随机存取，**对于主文件中的每个记录，在索引表中有一相应项，用于存储该记录在主文件中的位置。

索引文件可以方便地实现直接存取。

索引文件的主要缺点是：它除了主文件以外，还需要配置一个索引文件，而且每个记录都要有一个索引项，因而增加了存储费用。

### 索引顺序文件

索引顺序文件是顺序文件和索引文件相结合的产物。

它也要为顺序文件建立一张索引表，不同的是，它将顺序文件中的所有记录分为若干个组，在索引表中，为每个组建立一个索引项。

一般地，假设一个文件的记录数为N，采用顺序文件，平均检索N/2个记录；但对于索引顺序文件，平均只需要检索√N个记录，因而检索效率是顺序文件的√N/2倍。

## 文件系统

### 文件系统的结构

文件系统是操作系统的重要组成部分。它含有大量的文件及其属性信息，负责对文件进行操纵和管理，并向用户提供一个使用文件的接口。

* 文件及其属性
* 文件系统接口
* 文件管理软件

### 文件管理功能

# 目录

建立文件系统的主要目的，就是通过用户给出的文件名快速、准确地找到文件。而这主要依赖于文件目录来实现。目录具有将文件名转换成文件在外存的物理位置的功能。

文件目录的功能：

* 实现”按名存取“
* 提高检索速度
* 允许文件同名
* 文件共享

## 文件控制块和索引节点

为了能对文件进行正确的存取，必须为文件设置用于描述和控制文件的数据结构----文件控制块，该数据结构包含文件名即文件的各种属性，每个文件有一个文件控制块。

### 文件目录

文件控制块的有序集合即为文件目录，文件控制块就是其中的目录项。或者说，一个控制块就是一个文件目录项。完全由目录项组成的文件成为目录文件。

### 索引节点

在查找文件的过程中，只用到了文件名，而文件的其他描述信息是用不到的，所以，在有些文件系统中，如UNIX系统中，把文件名与文件的描述信息分开，把文件的描述信息单独形成一个称为索引节点的数据结构，简称i节点。而在文件目录中的每个目录项，则由文件名及指向文件所对应的i节点的指针构成。

磁盘上的索引节点称为磁盘索引节点，每个文件有唯一的一个磁盘索引节点。

内容索引节点是指存放在内存中的索引节点。**当文件被打开时，要将磁盘索引节点中的部分内容复制到内容的索引节点中，以便于以后使用。**

## 单级目录

单级目录的优点是实现简单，但存在两个缺点：

* 不允许文件重名
* 查找速度慢

## 两级目录

所谓两级目录，就是把登记文件的目录分成两级，一级主文件目录和一级用户文件目录。

优点：

* 提供了文件检索速度
* 部分允许文件重名

缺点：

该结构虽然能有效地将多个用户隔开，在各用户之间完全无关时，这种隔离是一个优点；但当多个用户需要共享一个文件时，这种隔离又成为一个缺点。

## 树形目录

树形目录结构的优点：

* 既可以方便用户查找文件，又可以把不同类型的文件或不同用途的文件分类
* 允许文件重名
* 利用多级分层结构关系，可以更方便地制定保护文件的存取权限，有利于文件保护

## 目录的查询

### 线性检索算法

目录查询的最简单的算法是线性检索算法，又称顺序检索算法。以UNIX的树形目录结构为例，用户提供的文件名包含由多个分量组成的路径名，此时需要对多级目录进行查找。

假定用户给定的文件路径名为"\usr\ast\books"，查找过程如下：

1. 首先读入文件路径名的第一个目录名usr，用它与根目录中的各目录项顺序地进行比较，从中找到匹配者，并得到匹配项的索引节点号6，再从索引节点中得知usr目录文件存放在第132号盘块中，将它读入内存；
2. 系统读入路径名的第二个目录名ast，用它与132号盘块汇总的第二级目录文件中的各目录项顺序的进行比较，从中找到匹配者，并得知ast的目录文件放在索引节点26中，再从索引节点中得知“usr\ast"目录文件存放在第406号盘块中，将它读入内存；
3. 系统读入路径名的第三个分量books，用它与第三级目录文件"usr/ast"中各目录项顺序地进行比较，从而得到“\usr\ast\books"的索引节点号92，即92号索引节点中存放了指定的文件的物理地址。目录查找到此结束。

### 哈希检索算法

进行目录检索时，首先根据目录名来计算一个哈希值，然后得到一个指向哈希表目录项的指针。这样，该算法就可以大幅度地减少目录检索的时间。插入和删除目录时，要考虑两个目录项的冲突问题，就是两个目录项的哈希值是相同的。

其难点在于选择合适的哈希表长度和哈希函数的构造。

## 文件的共享

### 基于索引节点的文件共享

即文件的物理地址及其他文件属性信息不再放在目录中，而是放在索引节点中。在文件目录中只设置文件名和指向相应索引节点的指点，从而也能提供给其他用户共享新增加的内容。

在索引节点中有一个链接计数count，用于表示链接到本索引节点上的目录项的数目。当conut=3是，表示有3个目录项链接到该文件上，或者说，有3个用户共享该文件。

当用户C创建文件时，它是该文件的所有者。此时置count为1。当用户B要共享该文件时，在用户B的目录中增加一个目录项，并设置一指针指向该文件的索引节点。此时，文件的所有者仍然是C，count=2。

如果用户C不再需要此文件，也不可以将该文件删除，因为如果用户C删除了该文件，也必然删除了该文件的索引节点，这样，使用户B指向该索引节点的指针悬空。但是如果用户C不删除此文件，等用户B继续使用，由于文件所有者是用户C，如果系统要记账收费，则C必须为B使用该共享文件而付账，这样也不合理。

### 基于符号链接的文件共享

在基于符号链接的共享方式中，由于只有文件所有者拥有指向索引节点的指针，而共享用户只有该文件的路径名，这样就不会发生文件所有者删除文件使得其他用户指向该文件的指针悬空的问题。

符号链接方式存在的问题是需要额外的开销。每次访问一个共享文件时，都可能多次读盘，这使得访问共享文件的开销很大。另外，为每个共享文件建立一条符号链，由于该链实际上是一个文件，该文件仍然要占用一定的磁盘空间。

符号链接的一个优势是，用该方法可以连接全球任何一处的机器上的文件，此时只需要提供该文件所在机器的网络地址，以及在该机器中的文件路径。

# 文件系统实现

<font color=red>最基本的目标：按名存取（通过目录管理功能实现的）</font>

## 文件系统的格式

### 文件系统的含义

一般而言，对文件系统的定义是指**在操作系统内部用来对文件进行控制和管理的一套机制及其实现**。而在具体应用和实现上，文件系统又指存储介质按照一定特定的文件格式加以构造。

### 分区与文件系统

文件系统是建立在某种存储介质上的，目前最常用的存储介质就是磁盘。

## 文件的存储结构

实现文件存储的关键问题是将文件分配到磁盘的哪些磁盘块中。

### 连续分配

连续分配是最简单的一种存储分配方案，它要求为每个文件分配一组连续的磁盘块。

仅当访问到一条磁道的最后一个盘块时，才需要移到下一个磁道，于是又可以连续地读/写多个盘块。

采用连续分配方式时，可把逻辑文件中的记录顺序地存储到邻接的各个物理盘块中，这样形成的物理文件成为顺序文件。这种分配方式保证了逻辑文件的记录顺序与物理存储器中文件占用的盘块顺序的一致性。

优点：

* 便于顺序访问
* 顺序访问速度快

缺点：

* 要求有连续的存储空间

因为文件分配一段连续的存储空间，便会出现许多外部碎片，严重降低了外存空间的利用率；

* 不便于文件的动态增长

因为一个文件的末尾处的空闲空间可能已分配给别的文件，一旦文件需要增加其长度，就需要大量的移动。

### 链接分配（串联文件）

与连续分配相对的一个极端是链接分配。采用链接分配方式，每个磁盘块都含有一个指向下一个盘块的指针，通过指针将属于同一文件多个离散地盘块链接成一个链接，形成链接文件。

优点：

* 解决了文件动态增长的问题
* 顺序存取

缺点：

* 只适合于文件的顺序访问，随机访问是低效的
* 指针占用存储空间

### 索引分配

索引分配解决了连续分配方式和链接分配方式中的许多问题。对于索引分配，每个文件都有一个索引块，索引块是一个表，其中存放了文件所占用的盘块号。

优点：

* 避免了连续分配存在的外部碎片问题和文件长度不便于动态增长的问题
* 支持对文件的直接访问

缺点：

* 索引块的分配增加了系统存储空间的开销，由于文件的大小不同，尤其对于小文件，采用索引分配方式时，索引块的利用率是很低的

当文件特别大，其索引块太多时，这种方法是低效的，故可以形成两级、三级、四级索引分配。

### 混合分配

* 一级索引分配（40kb）
* 二级索引分配（4mb+40kb）
* 三级索引分配（4GB+4MB+40KB）
* 四级索引分配（4TB+4GB+4MB+40KB）

## 空闲存储空间的管理

### 空闲表

空闲表用于连续分配方式，连续分配方式为每个文件分配一个连续的存储空间，系统需要维护一张空闲表，记录外存上所有空闲区的情况。

优点：

* 减少了I/O频率，小文件、多媒体文件多使用此

缺点：

* 整个系统中只有一张表，当磁盘存储空间较碎时，会造成表很大，从而影响文件分配时查找空闲表的速度；

### 空闲链

空闲链法是将所有空闲存储空间拉成一个空闲盘块链。

优点：

* 分配和回收过程简单

缺点：

* 每当在链上增加或删除空闲块时都需要I/O操作，因此工作效率低

空闲链方法适用于任何分配方式。

### 位示图

位示图是利用二进制的一位表示磁盘中的一个盘块的使用情况。当前值为“0”时，表示对应的盘块空闲；为“1”时，表示对应的盘块已分配；

优点：

* 通过位示图可以很容易找到一个或一组相邻接的空闲盘块。因此它适用于任何一种文件分配方式
* 它占用的磁盘空间比较少。一个位示图需要的存储总量是：磁盘大小/（8*磁盘块的大小）（B）；

例如，对于1GB的磁盘，块的大小是512B，则位示图占用256KB的空间，大约需要512个磁盘块。

在实际应用中，为了提高文件磁盘空间的分配速度，常将位示图放在内存中。

### 成组链接法

空闲表和空闲链都不适合用于大型文件系统，因为会使空闲表或空闲链太长。UNIX系统中采用的成组链接法，是综合上述两种方法而形成的一种空闲盘块管理方法。它兼备了两种方法的优点，并克服了他们的不足。