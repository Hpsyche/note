# 虚拟存储器的引入

前文所述的页式存储管理系统要求进程在运行之前将进程对应的全部程序都装入内存，但实际上许多进程在运行时，并非用到全部程序。故引入了虚拟存储器。

## 局部性原理

表现在以下两个方面：

* 空间局部性
* 时间局部性（原因：程序中存在着大量循环）

## 虚拟存储器

一个进程在运行时，没有必要将其全部装入内存，而仅将当前要运行的那部分装入内存，其余部分暂时留在磁盘内。当进程访问不在内存的那部分程序和数据时，再将其调入内存。

如果此时内存已满，无法装入新的程序和数据，可以将暂时不用的部分程序和数据置换出去，腾出内存空间后再将需要的调入内存，使进程能继续运行。

从用户的角度，系统具有的内存容量要比实际大得多，所以称为虚拟存储器。

**虚拟存储器是指具有<font color=red>请求调入</font>和<font color=red>置换</font>功能，能从<font color=red>逻辑上</font>对内存容量进行扩充的一种存储器系统。**

虚拟存储器逻辑内存的容量由内存和外存对换区之和决定。（运行速度接近于内存速度，而成本却又接近于外存）

## 虚拟存储器的特征

* 离散性

实现虚拟存储器的基础。只有采用离散分配方式，进程仅在需要调入某部分程序和数据时才为它分配存储空间，避免内存空间的浪费，也才有可能实现虚拟存储器。

* 多次性

指一个进程分多次调入内存。

* 对换性

指进程在运行过程中，允许将部分程序和数据换进、换出。

* 虚拟性

只是从逻辑上扩充了内存的容量，物理内存不变。

## 实现思想

将程序的逻辑地址空间与内存的物理地址空间分开处理，各自形成编址范围；利用大容量的外存储器存放程序和数据，而实际内存作为程序执行时的工作区。当要执行作业时，先将要执行到的部分程序和数据调入内存，暂时不执行的部分就留在外存，等内存中的部分程序执行结束后，再将等待执行的部分程序调入内存工作区中。

## 实现方式

* 请求页式系统
* 请求段式系统

# 请求页式存储管理

将虚拟存储器用在页式存储管理系统中，进程的多个页根据需要调入内部，当内存空间紧张时再将暂时不用的页调出。因为页是根据需要请求调入的，因此成为请求页式存储管理系统。

实现请求页式存储管理系统，需要一定的硬件支持。除了需要**一定容量的内存和外存对换区之外**，还需要**页表机制、缺页中断机构和地址变换机构**。

软件支持：请求调页软件、页面置换软件

## 请求页式存储管理系统的实现

### 页表的扩充

### 缺页中断机构

在请求页式管理系统中，当要访问页的页表项中状态位为0时，就表明该页不在内存，便产生一缺页中断，请求操作系统将所缺页调入内存。

主要体现在以下两个方面

* 在指令执行期间产生和处理中断信号
* 一条指令执行期间可能发生多次缺页中断

系统中的硬件机构能保存多次中断时的状态，并保证最后能返回中断前产生缺页中断的指令处继续执行。

### 地址变换机构

请求页式存储管理系统地址变换流程图

## 请求页式存储管理驻留级管理

### 存储块数分配策略

* 固定分配策略

在内存为进程分配固定的存储块数

* 可变分配策略

如果一个进程的缺页率比较高，则再额外分配给它一些存储块，以减少缺页率；

反之，如果一个进程的缺页率特别低，可以在不明显增加其缺页率的基础上减少分配给它的存储块数。

该策略的难点：要求操作系统随时评估活动进程的行为，这必然增加系统的软件开销。

### 驻留级管理

除了分配策略，系统还要考虑换出策略。

* 局部置换策略

是指在缺页的进程中选择一页换出

* 全局置换策略

是指在所有驻留在内存的页中进行选择，不管它属于哪个进程。

**固定分配就意味着使用局部置换，可变分配策略既可以采用局部置换策略，也可以采用全局置换策略。**

固有以下三种适用的策略：

* 固定分配、局部置换

该策略难点：确定每个进程分配多少个存储块。太少，频繁地发生缺页；太多，使内存中驻留的进程数减少，进而造成CPU利用率降低或其他资源空闲等情况。

* 可变分配、全局置换
* 可变分配、局部置换

## 请求页式存储管理的调入策略

涉及何时调入和何处调入两个问题。

### 何时调入策略

* 请调

当进程运行过程中发生缺页时，将所缺页面调入内存。这种调入策略实现简单，但容易产生较多缺页中断，造成对磁盘I/O次数增多，容易产生抖动现象。

* 预调（主要用于进程首次调入时）

预计进程要访问的页，提前将其调入内存的方法就是预调。由于从磁盘调入一页，系统开销比较大，故一次调入多页比调入一页更高效。根据局部性原理，每次调入时，也将相邻的若干页调入内存。

### 何处调入策略

在请求页式存储管理系统中，把外存分为两部分，即文件区和对换区。

文件区是用于存放文件的磁盘空间，对换区专门用于存放从内存换出的页面。

* 从对换区调入

要求系统对换区的空间比较大

* 只将修改过的页放在对换区

适用于对换区空间较小的情况

* 首次从文件区调入，以后再次调入时从对换区调入

UNIX系统采用这用方式

### 缺页率影响因素

* 页面大小
* 进程所分配到的物理块数
* 页面置换算法
* 程序固有的特性

## 请求页式存储管理的页面置换算法

* 最佳置换算法 OPT
* 先进先出置换算法 FIFO
* 最近最久未使用置换算法 LRU
* 时钟置换算法 Clock

## 请求页式存储管理系统的性能

### 驻留集

驻留集：是指在某段时间间隔内进程要访问的页面集合

正确选择驻留集窗口大小，如果窗口大小选择得很大，以致能将整个进程地址空间都装入内存，虽不会产生缺页，但也失去了虚拟存储器的意义；如果窗口大小选择得过小，在运行过程中频繁产生缺页中断，降低了系统的吞吐量。因此，窗口大小应选择适中。

### 抖动和加载控制

不适当地提高多道程序的道数，不仅不会提高系统的吞吐量，反而会使其降低。而且因为内存中进程过多，将会出现“抖动”现象。

抖动：<font color=red>在虚存中，页面在内存与外存之间频繁调度，以至于调度页面所需时间比进程实际运行的时间还多，此时系统效率急剧下降，甚至导致系统崩溃。</font>

**产生抖动的原因：**

* 页面置换算法不合理
* 分配给进程的物理页面数太少
* 内存中加载了过多的进程

### 缺页率与进程存储块数

![](https://github.com/Hpsyche/note/blob/master/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pict/缺页率与进程存储块数.png)

<center>为进程分配的存储块数应取该曲线的拐点附近或稍大。</center>

当多道程序的道数从一个比较小的值开始时，多道程序交替地占有CPU，随着多道程序道数的增加，CPU的利用率也随之提高，但是到达某一个峰值之后，如果继续增加多道程序的道数，将产生抖动现象，CPU利用率急剧下降。

为了预防这种情况的发生，（抖动预防方法），可以采取以下措施：

* 驻留集理论隐含了加载控制，只有驻留集足够大的进程才允许执行
* 调整多道程序的道数，使产生缺页的平均时间L等于系统处理缺页的平均时间S，此时CPU的利用率最大
* 系统在采取可变分配策略时，尽可能采用局部置换。
* 当多道程序的道数出现偏高时，简单而有效的方法是挂机一些进程，以便腾出内存空间分配给出现抖动的进程。选择被挂起进程时应考虑优先级较低的进程、进程较大、缺页进程及剩余执行时间较大的进程。



# 请求段式存储管理

段式中块的大小是一定的，所以只要知道块号就知道起始地址。

## 存储保护措施

* 越界检查
* 存取控制权限检查
* 环保护机制

在采用环保护机制时，操作系统应处于（最高特权环）内，一般应用程序应处于（最低特权环）内，并遵循如下规则：一个程序可以访问驻留在（相同和较低特权）环中的数据；可以调用驻留在（相同和较高特权）环中的服务。



# 例题

## 缺页中断与一般中断的区别
* 两种中断产生的时刻不同

  缺页中断是在执行一条指令中间时产生的中断，并立即转去处理；

  而一般中断则是在一条指令执行完毕后，当硬件中断装置发现有中断请求时才去响应和处理。

* 处理完毕后的归属不同

  缺页中断处理完后，仍返回到原指令去重新执行，因为那条指令并未执行；

  而一般中断则是或返回到被中断进程的下一条指令去执行，因为上一条指令已经执行完了，或重新调度，去执行别的进程程序。

* 一条指令执行期间可能产生多次缺页中断。



# 课堂习题

![](D:\Work\TyporaNotes\note\操作系统\pict\第六章课后习题1.png)

![](D:\Work\TyporaNotes\note\操作系统\pict\第六章课后习题2.png)

![](D:\Work\TyporaNotes\note\操作系统\pict\第六章课后习题3.png)
